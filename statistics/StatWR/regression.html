<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Regression models | R 통계분석</title>
  <meta name="description" content="8 Regression models | R 통계분석" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Regression models | R 통계분석" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Regression models | R 통계분석" />
  
  
  

<meta name="author" content="psnam" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="modchapter.html"/>
<link rel="next" href="mlchapter.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="preamble.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://datatellme.github.io">Data Tell Me Something</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>안녕하세요</a></li>
<li class="chapter" data-level="1" data-path="Introduction.html"><a href="Introduction.html"><i class="fa fa-check"></i><b>1</b> 들어가며</a>
<ul>
<li class="chapter" data-level="1.1" data-path="Introduction.html"><a href="Introduction.html#whatR"><i class="fa fa-check"></i><b>1.1</b> R이란?</a></li>
<li class="chapter" data-level="1.2" data-path="Introduction.html"><a href="Introduction.html#Rinstallation"><i class="fa fa-check"></i><b>1.2</b> R 설치하기</a></li>
<li class="chapter" data-level="1.3" data-path="Introduction.html"><a href="Introduction.html#RStudioinstallation"><i class="fa fa-check"></i><b>1.3</b> RStudio 설치하기</a></li>
<li class="chapter" data-level="1.4" data-path="Introduction.html"><a href="Introduction.html#LaTeXinstallation"><i class="fa fa-check"></i><b>1.4</b> 레이텍 설치하기</a></li>
<li class="chapter" data-level="1.5" data-path="Introduction.html"><a href="Introduction.html#packageinstallation"><i class="fa fa-check"></i><b>1.5</b> Packages 설치하기</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="thebasics.html"><a href="thebasics.html"><i class="fa fa-check"></i><b>2</b> 기본</a>
<ul>
<li class="chapter" data-level="2.1" data-path="thebasics.html"><a href="thebasics.html#rstudio-살펴보기"><i class="fa fa-check"></i><b>2.1</b> RStudio 살펴보기</a></li>
<li class="chapter" data-level="2.2" data-path="thebasics.html"><a href="thebasics.html#runningcode"><i class="fa fa-check"></i><b>2.2</b> R 코드 실행하기</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="thebasics.html"><a href="thebasics.html#r-스크립트"><i class="fa fa-check"></i><b>2.2.1</b> R 스크립트</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="thebasics.html"><a href="thebasics.html#varsandfuncs"><i class="fa fa-check"></i><b>2.3</b> 변수와 함수</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="thebasics.html"><a href="thebasics.html#데이터-저장"><i class="fa fa-check"></i><b>2.3.1</b> 데이터 저장</a></li>
<li class="chapter" data-level="2.3.2" data-path="thebasics.html"><a href="thebasics.html#변수-이름"><i class="fa fa-check"></i><b>2.3.2</b> 변수 이름</a></li>
<li class="chapter" data-level="2.3.3" data-path="thebasics.html"><a href="thebasics.html#벡터와-데이터프레임"><i class="fa fa-check"></i><b>2.3.3</b> 벡터와 데이터프레임</a></li>
<li class="chapter" data-level="2.3.4" data-path="thebasics.html"><a href="thebasics.html#함수"><i class="fa fa-check"></i><b>2.3.4</b> 함수</a></li>
<li class="chapter" data-level="2.3.5" data-path="thebasics.html"><a href="thebasics.html#maths"><i class="fa fa-check"></i><b>2.3.5</b> 수학연산</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="thebasics.html"><a href="thebasics.html#descstats"><i class="fa fa-check"></i><b>2.4</b> 기술통계</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="thebasics.html"><a href="thebasics.html#숫자-데이터"><i class="fa fa-check"></i><b>2.4.1</b> 숫자 데이터</a></li>
<li class="chapter" data-level="2.4.2" data-path="thebasics.html"><a href="thebasics.html#catdata1"><i class="fa fa-check"></i><b>2.4.2</b> 명목 데이터</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="thebasics.html"><a href="thebasics.html#그래프와-숫자-데이터"><i class="fa fa-check"></i><b>2.5</b> 그래프와 숫자 데이터</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="thebasics.html"><a href="thebasics.html#나의-그래프"><i class="fa fa-check"></i><b>2.5.1</b> 나의 그래프</a></li>
<li class="chapter" data-level="2.5.2" data-path="thebasics.html"><a href="thebasics.html#색과-형태-및-축"><i class="fa fa-check"></i><b>2.5.2</b> 색과 형태 및 축</a></li>
<li class="chapter" data-level="2.5.3" data-path="thebasics.html"><a href="thebasics.html#축의-한계와-스케일"><i class="fa fa-check"></i><b>2.5.3</b> 축의 한계와 스케일</a></li>
<li class="chapter" data-level="2.5.4" data-path="thebasics.html"><a href="thebasics.html#comparinggroups"><i class="fa fa-check"></i><b>2.5.4</b> 그룹 비교</a></li>
<li class="chapter" data-level="2.5.5" data-path="thebasics.html"><a href="thebasics.html#박스-그래풀럿"><i class="fa fa-check"></i><b>2.5.5</b> 박스 그래풀럿</a></li>
<li class="chapter" data-level="2.5.6" data-path="thebasics.html"><a href="thebasics.html#히스토그램"><i class="fa fa-check"></i><b>2.5.6</b> 히스토그램</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="thebasics.html"><a href="thebasics.html#catdata2"><i class="fa fa-check"></i><b>2.6</b> 그래프와 명목 데인터</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="thebasics.html"><a href="thebasics.html#막대-그래프"><i class="fa fa-check"></i><b>2.6.1</b> 막대 그래프</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="thebasics.html"><a href="thebasics.html#그래프-저장"><i class="fa fa-check"></i><b>2.7</b> 그래프 저장</a></li>
<li class="chapter" data-level="2.8" data-path="thebasics.html"><a href="thebasics.html#troubleshooting"><i class="fa fa-check"></i><b>2.8</b> 오류 문제 해결</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="datachapter.html"><a href="datachapter.html"><i class="fa fa-check"></i><b>3</b> Transforming, summarising, and analysing data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="datachapter.html"><a href="datachapter.html#data-frames-and-data-types"><i class="fa fa-check"></i><b>3.1</b> Data frames and data types</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="datachapter.html"><a href="datachapter.html#types-and-structures"><i class="fa fa-check"></i><b>3.1.1</b> Types and structures</a></li>
<li class="chapter" data-level="3.1.2" data-path="datachapter.html"><a href="datachapter.html#typesoftables"><i class="fa fa-check"></i><b>3.1.2</b> Types of tables</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="datachapter.html"><a href="datachapter.html#findingpoints"><i class="fa fa-check"></i><b>3.2</b> Vectors in data frames</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="datachapter.html"><a href="datachapter.html#accessingelements"><i class="fa fa-check"></i><b>3.2.1</b> Accessing vectors and elements</a></li>
<li class="chapter" data-level="3.2.2" data-path="datachapter.html"><a href="datachapter.html#use-your-dollars"><i class="fa fa-check"></i><b>3.2.2</b> Use your dollars</a></li>
<li class="chapter" data-level="3.2.3" data-path="datachapter.html"><a href="datachapter.html#conditionsintro"><i class="fa fa-check"></i><b>3.2.3</b> Using conditions</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="datachapter.html"><a href="datachapter.html#paths"><i class="fa fa-check"></i><b>3.3</b> Importing data</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="datachapter.html"><a href="datachapter.html#importing-csv-files"><i class="fa fa-check"></i><b>3.3.1</b> Importing csv files</a></li>
<li class="chapter" data-level="3.3.2" data-path="datachapter.html"><a href="datachapter.html#file-paths"><i class="fa fa-check"></i><b>3.3.2</b> File paths</a></li>
<li class="chapter" data-level="3.3.3" data-path="datachapter.html"><a href="datachapter.html#importing-excel-files"><i class="fa fa-check"></i><b>3.3.3</b> Importing Excel files</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="datachapter.html"><a href="datachapter.html#saving-and-exporting-your-data"><i class="fa fa-check"></i><b>3.4</b> Saving and exporting your data</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="datachapter.html"><a href="datachapter.html#exporting-data"><i class="fa fa-check"></i><b>3.4.1</b> Exporting data</a></li>
<li class="chapter" data-level="3.4.2" data-path="datachapter.html"><a href="datachapter.html#saving-and-loading-r-data"><i class="fa fa-check"></i><b>3.4.2</b> Saving and loading R data</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="datachapter.html"><a href="datachapter.html#rstudio-projects"><i class="fa fa-check"></i><b>3.5</b> RStudio projects</a></li>
<li class="chapter" data-level="3.6" data-path="datachapter.html"><a href="datachapter.html#firstttest"><i class="fa fa-check"></i><b>3.6</b> Running a t-test</a></li>
<li class="chapter" data-level="3.7" data-path="datachapter.html"><a href="datachapter.html#firstlm"><i class="fa fa-check"></i><b>3.7</b> Fitting a linear regression model</a></li>
<li class="chapter" data-level="3.8" data-path="datachapter.html"><a href="datachapter.html#grouped"><i class="fa fa-check"></i><b>3.8</b> Grouped summaries</a></li>
<li class="chapter" data-level="3.9" data-path="datachapter.html"><a href="datachapter.html#pipes"><i class="fa fa-check"></i><b>3.9</b> Using <code>%&gt;%</code> pipes</a>
<ul>
<li class="chapter" data-level="3.9.1" data-path="datachapter.html"><a href="datachapter.html#ceci-nest-pas-une-pipe"><i class="fa fa-check"></i><b>3.9.1</b> <em>Ceci n’est pas une pipe</em></a></li>
<li class="chapter" data-level="3.9.2" data-path="datachapter.html"><a href="datachapter.html#aliases-and-placeholders"><i class="fa fa-check"></i><b>3.9.2</b> Aliases and placeholders</a></li>
</ul></li>
<li class="chapter" data-level="3.10" data-path="datachapter.html"><a href="datachapter.html#flavours-of-r-base-and-tidyverse"><i class="fa fa-check"></i><b>3.10</b> Flavours of R: base and tidyverse</a></li>
<li class="chapter" data-level="3.11" data-path="datachapter.html"><a href="datachapter.html#ethicalguidelines"><i class="fa fa-check"></i><b>3.11</b> Ethics and good statistical practice</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="eda.html"><a href="eda.html"><i class="fa fa-check"></i><b>4</b> Exploratory data analysis and unsupervised learning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="eda.html"><a href="eda.html#rmarkdown"><i class="fa fa-check"></i><b>4.1</b> Reports with R Markdown</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="eda.html"><a href="eda.html#a-first-example"><i class="fa fa-check"></i><b>4.1.1</b> A first example</a></li>
<li class="chapter" data-level="4.1.2" data-path="eda.html"><a href="eda.html#formatting-text"><i class="fa fa-check"></i><b>4.1.2</b> Formatting text</a></li>
<li class="chapter" data-level="4.1.3" data-path="eda.html"><a href="eda.html#lists-tables-and-images"><i class="fa fa-check"></i><b>4.1.3</b> Lists, tables, and images</a></li>
<li class="chapter" data-level="4.1.4" data-path="eda.html"><a href="eda.html#code-chunks"><i class="fa fa-check"></i><b>4.1.4</b> Code chunks</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="eda.html"><a href="eda.html#themes"><i class="fa fa-check"></i><b>4.2</b> Customising <code>ggplot2</code> plots</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="eda.html"><a href="eda.html#using-themes"><i class="fa fa-check"></i><b>4.2.1</b> Using themes</a></li>
<li class="chapter" data-level="4.2.2" data-path="eda.html"><a href="eda.html#colourpalettes"><i class="fa fa-check"></i><b>4.2.2</b> Colour palettes</a></li>
<li class="chapter" data-level="4.2.3" data-path="eda.html"><a href="eda.html#theme-settings"><i class="fa fa-check"></i><b>4.2.3</b> Theme settings</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="eda.html"><a href="eda.html#exploring-distributions"><i class="fa fa-check"></i><b>4.3</b> Exploring distributions</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="eda.html"><a href="eda.html#density-plots-and-frequency-polygons"><i class="fa fa-check"></i><b>4.3.1</b> Density plots and frequency polygons</a></li>
<li class="chapter" data-level="4.3.2" data-path="eda.html"><a href="eda.html#asking-questions"><i class="fa fa-check"></i><b>4.3.2</b> Asking questions</a></li>
<li class="chapter" data-level="4.3.3" data-path="eda.html"><a href="eda.html#violin-plots"><i class="fa fa-check"></i><b>4.3.3</b> Violin plots</a></li>
<li class="chapter" data-level="4.3.4" data-path="eda.html"><a href="eda.html#patchwork"><i class="fa fa-check"></i><b>4.3.4</b> Combine multiple plots into a single graphic</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="eda.html"><a href="eda.html#outliers-and-missing-data"><i class="fa fa-check"></i><b>4.4</b> Outliers and missing data</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="eda.html"><a href="eda.html#detecting-outliers"><i class="fa fa-check"></i><b>4.4.1</b> Detecting outliers</a></li>
<li class="chapter" data-level="4.4.2" data-path="eda.html"><a href="eda.html#labelling-outliers"><i class="fa fa-check"></i><b>4.4.2</b> Labelling outliers</a></li>
<li class="chapter" data-level="4.4.3" data-path="eda.html"><a href="eda.html#missing-data"><i class="fa fa-check"></i><b>4.4.3</b> Missing data</a></li>
<li class="chapter" data-level="4.4.4" data-path="eda.html"><a href="eda.html#exploring-data"><i class="fa fa-check"></i><b>4.4.4</b> Exploring data</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="eda.html"><a href="eda.html#trends-in-scatterplots"><i class="fa fa-check"></i><b>4.5</b> Trends in scatterplots</a></li>
<li class="chapter" data-level="4.6" data-path="eda.html"><a href="eda.html#tsplots"><i class="fa fa-check"></i><b>4.6</b> Exploring time series</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="eda.html"><a href="eda.html#annotations-and-reference-lines"><i class="fa fa-check"></i><b>4.6.1</b> Annotations and reference lines</a></li>
<li class="chapter" data-level="4.6.2" data-path="eda.html"><a href="eda.html#longitudinal-data"><i class="fa fa-check"></i><b>4.6.2</b> Longitudinal data</a></li>
<li class="chapter" data-level="4.6.3" data-path="eda.html"><a href="eda.html#path-plots"><i class="fa fa-check"></i><b>4.6.3</b> Path plots</a></li>
<li class="chapter" data-level="4.6.4" data-path="eda.html"><a href="eda.html#spaghetti-plots"><i class="fa fa-check"></i><b>4.6.4</b> Spaghetti plots</a></li>
<li class="chapter" data-level="4.6.5" data-path="eda.html"><a href="eda.html#stlsec"><i class="fa fa-check"></i><b>4.6.5</b> Seasonal plots and decompositions</a></li>
<li class="chapter" data-level="4.6.6" data-path="eda.html"><a href="eda.html#detecting-changepoints"><i class="fa fa-check"></i><b>4.6.6</b> Detecting changepoints</a></li>
<li class="chapter" data-level="4.6.7" data-path="eda.html"><a href="eda.html#interactivets"><i class="fa fa-check"></i><b>4.6.7</b> Interactive time series plots</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="eda.html"><a href="eda.html#polar"><i class="fa fa-check"></i><b>4.7</b> Using polar coordinates</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="eda.html"><a href="eda.html#visualising-periodic-data"><i class="fa fa-check"></i><b>4.7.1</b> Visualising periodic data</a></li>
<li class="chapter" data-level="4.7.2" data-path="eda.html"><a href="eda.html#pie-charts"><i class="fa fa-check"></i><b>4.7.2</b> Pie charts</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="eda.html"><a href="eda.html#visualising-multiple-variables"><i class="fa fa-check"></i><b>4.8</b> Visualising multiple variables</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="eda.html"><a href="eda.html#scatterplotmatrix"><i class="fa fa-check"></i><b>4.8.1</b> Scatterplot matrices</a></li>
<li class="chapter" data-level="4.8.2" data-path="eda.html"><a href="eda.html#d-scatterplots"><i class="fa fa-check"></i><b>4.8.2</b> 3D scatterplots</a></li>
<li class="chapter" data-level="4.8.3" data-path="eda.html"><a href="eda.html#correlograms"><i class="fa fa-check"></i><b>4.8.3</b> Correlograms</a></li>
<li class="chapter" data-level="4.8.4" data-path="eda.html"><a href="eda.html#adding-more-variables-to-scatterplots"><i class="fa fa-check"></i><b>4.8.4</b> Adding more variables to scatterplots</a></li>
<li class="chapter" data-level="4.8.5" data-path="eda.html"><a href="eda.html#overplotting"><i class="fa fa-check"></i><b>4.8.5</b> Overplotting</a></li>
<li class="chapter" data-level="4.8.6" data-path="eda.html"><a href="eda.html#categorical-data"><i class="fa fa-check"></i><b>4.8.6</b> Categorical data</a></li>
<li class="chapter" data-level="4.8.7" data-path="eda.html"><a href="eda.html#putting-it-all-together"><i class="fa fa-check"></i><b>4.8.7</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="4.9" data-path="eda.html"><a href="eda.html#pca"><i class="fa fa-check"></i><b>4.9</b> Principal component analysis</a></li>
<li class="chapter" data-level="4.10" data-path="eda.html"><a href="eda.html#clustering"><i class="fa fa-check"></i><b>4.10</b> Cluster analysis</a>
<ul>
<li class="chapter" data-level="4.10.1" data-path="eda.html"><a href="eda.html#hierarchical-clustering"><i class="fa fa-check"></i><b>4.10.1</b> Hierarchical clustering</a></li>
<li class="chapter" data-level="4.10.2" data-path="eda.html"><a href="eda.html#heatmaps-and-clustering-variables"><i class="fa fa-check"></i><b>4.10.2</b> Heatmaps and clustering variables</a></li>
<li class="chapter" data-level="4.10.3" data-path="eda.html"><a href="eda.html#centroid"><i class="fa fa-check"></i><b>4.10.3</b> Centroid-based clustering</a></li>
<li class="chapter" data-level="4.10.4" data-path="eda.html"><a href="eda.html#fuzzy-clustering"><i class="fa fa-check"></i><b>4.10.4</b> Fuzzy clustering</a></li>
<li class="chapter" data-level="4.10.5" data-path="eda.html"><a href="eda.html#modelbasedclustering"><i class="fa fa-check"></i><b>4.10.5</b> Model-based clustering</a></li>
<li class="chapter" data-level="4.10.6" data-path="eda.html"><a href="eda.html#comparing-clusters"><i class="fa fa-check"></i><b>4.10.6</b> Comparing clusters</a></li>
</ul></li>
<li class="chapter" data-level="4.11" data-path="eda.html"><a href="eda.html#exploratory-factor-analysis"><i class="fa fa-check"></i><b>4.11</b> Exploratory factor analysis</a>
<ul>
<li class="chapter" data-level="4.11.1" data-path="eda.html"><a href="eda.html#factor-analysis"><i class="fa fa-check"></i><b>4.11.1</b> Factor analysis</a></li>
<li class="chapter" data-level="4.11.2" data-path="eda.html"><a href="eda.html#lca"><i class="fa fa-check"></i><b>4.11.2</b> Latent class analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="messychapter.html"><a href="messychapter.html"><i class="fa fa-check"></i><b>5</b> Dealing with messy data</a>
<ul>
<li class="chapter" data-level="5.1" data-path="messychapter.html"><a href="messychapter.html#coercion"><i class="fa fa-check"></i><b>5.1</b> Changing data types</a></li>
<li class="chapter" data-level="5.2" data-path="messychapter.html"><a href="messychapter.html#lists2"><i class="fa fa-check"></i><b>5.2</b> Working with lists</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="messychapter.html"><a href="messychapter.html#splitvector"><i class="fa fa-check"></i><b>5.2.1</b> Splitting vectors into lists</a></li>
<li class="chapter" data-level="5.2.2" data-path="messychapter.html"><a href="messychapter.html#collapsing-lists-into-vectors"><i class="fa fa-check"></i><b>5.2.2</b> Collapsing lists into vectors</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="messychapter.html"><a href="messychapter.html#working-with-numbers"><i class="fa fa-check"></i><b>5.3</b> Working with numbers</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="messychapter.html"><a href="messychapter.html#rounding-numbers"><i class="fa fa-check"></i><b>5.3.1</b> Rounding numbers</a></li>
<li class="chapter" data-level="5.3.2" data-path="messychapter.html"><a href="messychapter.html#sums-and-means-in-data-frames"><i class="fa fa-check"></i><b>5.3.2</b> Sums and means in data frames</a></li>
<li class="chapter" data-level="5.3.3" data-path="messychapter.html"><a href="messychapter.html#rle"><i class="fa fa-check"></i><b>5.3.3</b> Summaries of series of numbers</a></li>
<li class="chapter" data-level="5.3.4" data-path="messychapter.html"><a href="messychapter.html#scientific-notation-1e-03"><i class="fa fa-check"></i><b>5.3.4</b> Scientific notation <code>1e-03</code></a></li>
<li class="chapter" data-level="5.3.5" data-path="messychapter.html"><a href="messychapter.html#floatingpoints"><i class="fa fa-check"></i><b>5.3.5</b> Floating point arithmetics</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="messychapter.html"><a href="messychapter.html#factors"><i class="fa fa-check"></i><b>5.4</b> Working with factors</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="messychapter.html"><a href="messychapter.html#creating-factors"><i class="fa fa-check"></i><b>5.4.1</b> Creating factors</a></li>
<li class="chapter" data-level="5.4.2" data-path="messychapter.html"><a href="messychapter.html#factorlevels"><i class="fa fa-check"></i><b>5.4.2</b> Changing factor levels</a></li>
<li class="chapter" data-level="5.4.3" data-path="messychapter.html"><a href="messychapter.html#changing-the-order-of-levels"><i class="fa fa-check"></i><b>5.4.3</b> Changing the order of levels</a></li>
<li class="chapter" data-level="5.4.4" data-path="messychapter.html"><a href="messychapter.html#combining-levels"><i class="fa fa-check"></i><b>5.4.4</b> Combining levels</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="messychapter.html"><a href="messychapter.html#strings"><i class="fa fa-check"></i><b>5.5</b> Working with strings</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="messychapter.html"><a href="messychapter.html#concatenating-strings"><i class="fa fa-check"></i><b>5.5.1</b> Concatenating strings</a></li>
<li class="chapter" data-level="5.5.2" data-path="messychapter.html"><a href="messychapter.html#changing-case"><i class="fa fa-check"></i><b>5.5.2</b> Changing case</a></li>
<li class="chapter" data-level="5.5.3" data-path="messychapter.html"><a href="messychapter.html#regexp"><i class="fa fa-check"></i><b>5.5.3</b> Finding patterns using regular expressions</a></li>
<li class="chapter" data-level="5.5.4" data-path="messychapter.html"><a href="messychapter.html#sub"><i class="fa fa-check"></i><b>5.5.4</b> Substitution</a></li>
<li class="chapter" data-level="5.5.5" data-path="messychapter.html"><a href="messychapter.html#splitting-strings"><i class="fa fa-check"></i><b>5.5.5</b> Splitting strings</a></li>
<li class="chapter" data-level="5.5.6" data-path="messychapter.html"><a href="messychapter.html#variable-names"><i class="fa fa-check"></i><b>5.5.6</b> Variable names</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="messychapter.html"><a href="messychapter.html#datetime"><i class="fa fa-check"></i><b>5.6</b> Working with dates and times</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="messychapter.html"><a href="messychapter.html#date-formats"><i class="fa fa-check"></i><b>5.6.1</b> Date formats</a></li>
<li class="chapter" data-level="5.6.2" data-path="messychapter.html"><a href="messychapter.html#plotting-with-dates"><i class="fa fa-check"></i><b>5.6.2</b> Plotting with dates</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="messychapter.html"><a href="messychapter.html#data-manipulation-with-data.table-dplyr-and-tidyr"><i class="fa fa-check"></i><b>5.7</b> Data manipulation with <code>data.table</code>, <code>dplyr</code>, and <code>tidyr</code></a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="messychapter.html"><a href="messychapter.html#dtbasics"><i class="fa fa-check"></i><b>5.7.1</b> <code>data.table</code> and tidyverse syntax basics</a></li>
<li class="chapter" data-level="5.7.2" data-path="messychapter.html"><a href="messychapter.html#modifyvar"><i class="fa fa-check"></i><b>5.7.2</b> Modifying a variable</a></li>
<li class="chapter" data-level="5.7.3" data-path="messychapter.html"><a href="messychapter.html#computing-a-new-variable-based-on-existing-variables"><i class="fa fa-check"></i><b>5.7.3</b> Computing a new variable based on existing variables</a></li>
<li class="chapter" data-level="5.7.4" data-path="messychapter.html"><a href="messychapter.html#renaming-a-variable"><i class="fa fa-check"></i><b>5.7.4</b> Renaming a variable</a></li>
<li class="chapter" data-level="5.7.5" data-path="messychapter.html"><a href="messychapter.html#removing-a-variable"><i class="fa fa-check"></i><b>5.7.5</b> Removing a variable</a></li>
<li class="chapter" data-level="5.7.6" data-path="messychapter.html"><a href="messychapter.html#recodedplyr"><i class="fa fa-check"></i><b>5.7.6</b> Recoding <code>factor</code> levels</a></li>
<li class="chapter" data-level="5.7.7" data-path="messychapter.html"><a href="messychapter.html#grouped2"><i class="fa fa-check"></i><b>5.7.7</b> Grouped summaries</a></li>
<li class="chapter" data-level="5.7.8" data-path="messychapter.html"><a href="messychapter.html#fillNA"><i class="fa fa-check"></i><b>5.7.8</b> Filling in missing values</a></li>
<li class="chapter" data-level="5.7.9" data-path="messychapter.html"><a href="messychapter.html#chaining-commands-together"><i class="fa fa-check"></i><b>5.7.9</b> Chaining commands together</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="messychapter.html"><a href="messychapter.html#filtering"><i class="fa fa-check"></i><b>5.8</b> Filtering: select rows</a>
<ul>
<li class="chapter" data-level="5.8.1" data-path="messychapter.html"><a href="messychapter.html#filtering-using-row-numbers"><i class="fa fa-check"></i><b>5.8.1</b> Filtering using row numbers</a></li>
<li class="chapter" data-level="5.8.2" data-path="messychapter.html"><a href="messychapter.html#conditions2"><i class="fa fa-check"></i><b>5.8.2</b> Filtering using conditions</a></li>
<li class="chapter" data-level="5.8.3" data-path="messychapter.html"><a href="messychapter.html#selecting-rows-at-random"><i class="fa fa-check"></i><b>5.8.3</b> Selecting rows at random</a></li>
<li class="chapter" data-level="5.8.4" data-path="messychapter.html"><a href="messychapter.html#using-regular-expressions-to-select-rows"><i class="fa fa-check"></i><b>5.8.4</b> Using regular expressions to select rows</a></li>
</ul></li>
<li class="chapter" data-level="5.9" data-path="messychapter.html"><a href="messychapter.html#subsetting-select-columns"><i class="fa fa-check"></i><b>5.9</b> Subsetting: select columns</a>
<ul>
<li class="chapter" data-level="5.9.1" data-path="messychapter.html"><a href="messychapter.html#selecting-a-single-column"><i class="fa fa-check"></i><b>5.9.1</b> Selecting a single column</a></li>
<li class="chapter" data-level="5.9.2" data-path="messychapter.html"><a href="messychapter.html#selecting-multiple-columns"><i class="fa fa-check"></i><b>5.9.2</b> Selecting multiple columns</a></li>
<li class="chapter" data-level="5.9.3" data-path="messychapter.html"><a href="messychapter.html#using-regular-expressions-to-select-columns"><i class="fa fa-check"></i><b>5.9.3</b> Using regular expressions to select columns</a></li>
<li class="chapter" data-level="5.9.4" data-path="messychapter.html"><a href="messychapter.html#subsetusingcn"><i class="fa fa-check"></i><b>5.9.4</b> Subsetting using column numbers</a></li>
</ul></li>
<li class="chapter" data-level="5.10" data-path="messychapter.html"><a href="messychapter.html#sorting"><i class="fa fa-check"></i><b>5.10</b> Sorting</a>
<ul>
<li class="chapter" data-level="5.10.1" data-path="messychapter.html"><a href="messychapter.html#changing-the-column-order"><i class="fa fa-check"></i><b>5.10.1</b> Changing the column order</a></li>
<li class="chapter" data-level="5.10.2" data-path="messychapter.html"><a href="messychapter.html#changing-the-row-order"><i class="fa fa-check"></i><b>5.10.2</b> Changing the row order</a></li>
</ul></li>
<li class="chapter" data-level="5.11" data-path="messychapter.html"><a href="messychapter.html#reshaping"><i class="fa fa-check"></i><b>5.11</b> Reshaping data</a>
<ul>
<li class="chapter" data-level="5.11.1" data-path="messychapter.html"><a href="messychapter.html#from-long-to-wide"><i class="fa fa-check"></i><b>5.11.1</b> From long to wide</a></li>
<li class="chapter" data-level="5.11.2" data-path="messychapter.html"><a href="messychapter.html#from-wide-to-long"><i class="fa fa-check"></i><b>5.11.2</b> From wide to long</a></li>
<li class="chapter" data-level="5.11.3" data-path="messychapter.html"><a href="messychapter.html#splittingcolumns"><i class="fa fa-check"></i><b>5.11.3</b> Splitting columns</a></li>
<li class="chapter" data-level="5.11.4" data-path="messychapter.html"><a href="messychapter.html#merging-columns"><i class="fa fa-check"></i><b>5.11.4</b> Merging columns</a></li>
</ul></li>
<li class="chapter" data-level="5.12" data-path="messychapter.html"><a href="messychapter.html#mergedata"><i class="fa fa-check"></i><b>5.12</b> Merging data from multiple tables</a>
<ul>
<li class="chapter" data-level="5.12.1" data-path="messychapter.html"><a href="messychapter.html#binds"><i class="fa fa-check"></i><b>5.12.1</b> Binds</a></li>
<li class="chapter" data-level="5.12.2" data-path="messychapter.html"><a href="messychapter.html#merging-tables-using-keys"><i class="fa fa-check"></i><b>5.12.2</b> Merging tables using keys</a></li>
<li class="chapter" data-level="5.12.3" data-path="messychapter.html"><a href="messychapter.html#inner-and-outer-joins"><i class="fa fa-check"></i><b>5.12.3</b> Inner and outer joins</a></li>
<li class="chapter" data-level="5.12.4" data-path="messychapter.html"><a href="messychapter.html#semijoins"><i class="fa fa-check"></i><b>5.12.4</b> Semijoins and antijoins</a></li>
</ul></li>
<li class="chapter" data-level="5.13" data-path="messychapter.html"><a href="messychapter.html#scraping-data-from-websites"><i class="fa fa-check"></i><b>5.13</b> Scraping data from websites</a></li>
<li class="chapter" data-level="5.14" data-path="messychapter.html"><a href="messychapter.html#commontasks"><i class="fa fa-check"></i><b>5.14</b> Other commons tasks</a>
<ul>
<li class="chapter" data-level="5.14.1" data-path="messychapter.html"><a href="messychapter.html#deleting-variables"><i class="fa fa-check"></i><b>5.14.1</b> Deleting variables</a></li>
<li class="chapter" data-level="5.14.2" data-path="messychapter.html"><a href="messychapter.html#foreign"><i class="fa fa-check"></i><b>5.14.2</b> Importing data from other statistical packages</a></li>
<li class="chapter" data-level="5.14.3" data-path="messychapter.html"><a href="messychapter.html#importing-data-from-databases"><i class="fa fa-check"></i><b>5.14.3</b> Importing data from databases</a></li>
<li class="chapter" data-level="5.14.4" data-path="messychapter.html"><a href="messychapter.html#importing-data-from-json-files"><i class="fa fa-check"></i><b>5.14.4</b> Importing data from JSON files</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="progchapter.html"><a href="progchapter.html"><i class="fa fa-check"></i><b>6</b> R programming</a>
<ul>
<li class="chapter" data-level="6.1" data-path="progchapter.html"><a href="progchapter.html#functions"><i class="fa fa-check"></i><b>6.1</b> Functions</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="progchapter.html"><a href="progchapter.html#createfunctions"><i class="fa fa-check"></i><b>6.1.1</b> Creating functions</a></li>
<li class="chapter" data-level="6.1.2" data-path="progchapter.html"><a href="progchapter.html#local-and-global-variables"><i class="fa fa-check"></i><b>6.1.2</b> Local and global variables</a></li>
<li class="chapter" data-level="6.1.3" data-path="progchapter.html"><a href="progchapter.html#willfunctionwork"><i class="fa fa-check"></i><b>6.1.3</b> Will your function work?</a></li>
<li class="chapter" data-level="6.1.4" data-path="progchapter.html"><a href="progchapter.html#more-on-arguments"><i class="fa fa-check"></i><b>6.1.4</b> More on arguments</a></li>
<li class="chapter" data-level="6.1.5" data-path="progchapter.html"><a href="progchapter.html#namespaces"><i class="fa fa-check"></i><b>6.1.5</b> Namespaces</a></li>
<li class="chapter" data-level="6.1.6" data-path="progchapter.html"><a href="progchapter.html#sourcing-other-scripts"><i class="fa fa-check"></i><b>6.1.6</b> Sourcing other scripts</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="progchapter.html"><a href="progchapter.html#morepipes"><i class="fa fa-check"></i><b>6.2</b> More on pipes</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="progchapter.html"><a href="progchapter.html#ce-ne-sont-pas-non-plus-des-pipes"><i class="fa fa-check"></i><b>6.2.1</b> <em>Ce ne sont pas non plus des pipes</em></a></li>
<li class="chapter" data-level="6.2.2" data-path="progchapter.html"><a href="progchapter.html#writing-functions-with-pipes"><i class="fa fa-check"></i><b>6.2.2</b> Writing functions with pipes</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="progchapter.html"><a href="progchapter.html#conditions"><i class="fa fa-check"></i><b>6.3</b> Checking conditions</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="progchapter.html"><a href="progchapter.html#if-and-else"><i class="fa fa-check"></i><b>6.3.1</b> <code>if</code> and <code>else</code></a></li>
<li class="chapter" data-level="6.3.2" data-path="progchapter.html"><a href="progchapter.html#section"><i class="fa fa-check"></i><b>6.3.2</b> <code>&amp;</code> &amp; <code>&amp;&amp;</code></a></li>
<li class="chapter" data-level="6.3.3" data-path="progchapter.html"><a href="progchapter.html#ifelse"><i class="fa fa-check"></i><b>6.3.3</b> <code>ifelse</code></a></li>
<li class="chapter" data-level="6.3.4" data-path="progchapter.html"><a href="progchapter.html#switch"><i class="fa fa-check"></i><b>6.3.4</b> <code>switch</code></a></li>
<li class="chapter" data-level="6.3.5" data-path="progchapter.html"><a href="progchapter.html#failing-gracefully"><i class="fa fa-check"></i><b>6.3.5</b> Failing gracefully</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="progchapter.html"><a href="progchapter.html#loopsection"><i class="fa fa-check"></i><b>6.4</b> Iteration using loops</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="progchapter.html"><a href="progchapter.html#forloops"><i class="fa fa-check"></i><b>6.4.1</b> <code>for</code> loops</a></li>
<li class="chapter" data-level="6.4.2" data-path="progchapter.html"><a href="progchapter.html#nestedloops"><i class="fa fa-check"></i><b>6.4.2</b> Loops within loops</a></li>
<li class="chapter" data-level="6.4.3" data-path="progchapter.html"><a href="progchapter.html#beepr"><i class="fa fa-check"></i><b>6.4.3</b> Keeping track of what’s happening</a></li>
<li class="chapter" data-level="6.4.4" data-path="progchapter.html"><a href="progchapter.html#lists"><i class="fa fa-check"></i><b>6.4.4</b> Loops and lists</a></li>
<li class="chapter" data-level="6.4.5" data-path="progchapter.html"><a href="progchapter.html#whileloop"><i class="fa fa-check"></i><b>6.4.5</b> <code>while</code> loops</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="progchapter.html"><a href="progchapter.html#vectorloops"><i class="fa fa-check"></i><b>6.5</b> Iteration using vectorisation and functionals</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="progchapter.html"><a href="progchapter.html#a-first-example-with-apply"><i class="fa fa-check"></i><b>6.5.1</b> A first example with <code>apply</code></a></li>
<li class="chapter" data-level="6.5.2" data-path="progchapter.html"><a href="progchapter.html#variations-on-a-theme"><i class="fa fa-check"></i><b>6.5.2</b> Variations on a theme</a></li>
<li class="chapter" data-level="6.5.3" data-path="progchapter.html"><a href="progchapter.html#purrr"><i class="fa fa-check"></i><b>6.5.3</b> <code>purrr</code></a></li>
<li class="chapter" data-level="6.5.4" data-path="progchapter.html"><a href="progchapter.html#specialised-functions"><i class="fa fa-check"></i><b>6.5.4</b> Specialised functions</a></li>
<li class="chapter" data-level="6.5.5" data-path="progchapter.html"><a href="progchapter.html#exploring-data-with-functionals"><i class="fa fa-check"></i><b>6.5.5</b> Exploring data with functionals</a></li>
<li class="chapter" data-level="6.5.6" data-path="progchapter.html"><a href="progchapter.html#keep-calm-and-carry-on"><i class="fa fa-check"></i><b>6.5.6</b> Keep calm and carry on</a></li>
<li class="chapter" data-level="6.5.7" data-path="progchapter.html"><a href="progchapter.html#multiiter"><i class="fa fa-check"></i><b>6.5.7</b> Iterating over multiple variables</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="progchapter.html"><a href="progchapter.html#measureperformance"><i class="fa fa-check"></i><b>6.6</b> Measuring code performance</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="progchapter.html"><a href="progchapter.html#timing-functions"><i class="fa fa-check"></i><b>6.6.1</b> Timing functions</a></li>
<li class="chapter" data-level="6.6.2" data-path="progchapter.html"><a href="progchapter.html#measuring-memory-usage---and-a-note-on-compilation"><i class="fa fa-check"></i><b>6.6.2</b> Measuring memory usage - and a note on compilation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="modchapter.html"><a href="modchapter.html"><i class="fa fa-check"></i><b>7</b> Modern classical statistics</a>
<ul>
<li class="chapter" data-level="7.1" data-path="modchapter.html"><a href="modchapter.html#simulation"><i class="fa fa-check"></i><b>7.1</b> Simulation and distributions</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="modchapter.html"><a href="modchapter.html#generating-random-numbers"><i class="fa fa-check"></i><b>7.1.1</b> Generating random numbers</a></li>
<li class="chapter" data-level="7.1.2" data-path="modchapter.html"><a href="modchapter.html#distfunctions"><i class="fa fa-check"></i><b>7.1.2</b> Some common distributions</a></li>
<li class="chapter" data-level="7.1.3" data-path="modchapter.html"><a href="modchapter.html#assessing-distributional-assumptions"><i class="fa fa-check"></i><b>7.1.3</b> Assessing distributional assumptions</a></li>
<li class="chapter" data-level="7.1.4" data-path="modchapter.html"><a href="modchapter.html#monte-carlo-integration"><i class="fa fa-check"></i><b>7.1.4</b> Monte Carlo integration</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="modchapter.html"><a href="modchapter.html#ttest"><i class="fa fa-check"></i><b>7.2</b> Student’s t-test revisited</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="modchapter.html"><a href="modchapter.html#oldschoolt"><i class="fa fa-check"></i><b>7.2.1</b> The old-school t-test</a></li>
<li class="chapter" data-level="7.2.2" data-path="modchapter.html"><a href="modchapter.html#permutation-tests"><i class="fa fa-check"></i><b>7.2.2</b> Permutation tests</a></li>
<li class="chapter" data-level="7.2.3" data-path="modchapter.html"><a href="modchapter.html#the-bootstrap"><i class="fa fa-check"></i><b>7.2.3</b> The bootstrap</a></li>
<li class="chapter" data-level="7.2.4" data-path="modchapter.html"><a href="modchapter.html#saving-the-output"><i class="fa fa-check"></i><b>7.2.4</b> Saving the output</a></li>
<li class="chapter" data-level="7.2.5" data-path="modchapter.html"><a href="modchapter.html#multipletesting"><i class="fa fa-check"></i><b>7.2.5</b> Multiple testing</a></li>
<li class="chapter" data-level="7.2.6" data-path="modchapter.html"><a href="modchapter.html#hotellingst2"><i class="fa fa-check"></i><b>7.2.6</b> Multivariate testing with Hotelling’s <span class="math inline">\(T^2\)</span></a></li>
<li class="chapter" data-level="7.2.7" data-path="modchapter.html"><a href="modchapter.html#sample-size-computations-for-the-t-test"><i class="fa fa-check"></i><b>7.2.7</b> Sample size computations for the t-test</a></li>
<li class="chapter" data-level="7.2.8" data-path="modchapter.html"><a href="modchapter.html#a-bayesian-approach"><i class="fa fa-check"></i><b>7.2.8</b> A Bayesian approach</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="modchapter.html"><a href="modchapter.html#other-common-hypothesis-tests-and-confidence-intervals"><i class="fa fa-check"></i><b>7.3</b> Other common hypothesis tests and confidence intervals</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="modchapter.html"><a href="modchapter.html#nonparametric-tests-of-location"><i class="fa fa-check"></i><b>7.3.1</b> Nonparametric tests of location</a></li>
<li class="chapter" data-level="7.3.2" data-path="modchapter.html"><a href="modchapter.html#tests-for-correlation"><i class="fa fa-check"></i><b>7.3.2</b> Tests for correlation</a></li>
<li class="chapter" data-level="7.3.3" data-path="modchapter.html"><a href="modchapter.html#chi2-tests"><i class="fa fa-check"></i><b>7.3.3</b> <span class="math inline">\(\chi^2\)</span>-tests</a></li>
<li class="chapter" data-level="7.3.4" data-path="modchapter.html"><a href="modchapter.html#confprop"><i class="fa fa-check"></i><b>7.3.4</b> Confidence intervals for proportions</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="modchapter.html"><a href="modchapter.html#ethicsinference"><i class="fa fa-check"></i><b>7.4</b> Ethical issues in statistical inference</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="modchapter.html"><a href="modchapter.html#p-hacking-and-the-file-drawer-problem"><i class="fa fa-check"></i><b>7.4.1</b> p-hacking and the file-drawer problem</a></li>
<li class="chapter" data-level="7.4.2" data-path="modchapter.html"><a href="modchapter.html#reproducibility"><i class="fa fa-check"></i><b>7.4.2</b> Reproducibility</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="modchapter.html"><a href="modchapter.html#simeval"><i class="fa fa-check"></i><b>7.5</b> Evaluating statistical methods using simulation</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="modchapter.html"><a href="modchapter.html#comparing-estimators"><i class="fa fa-check"></i><b>7.5.1</b> Comparing estimators</a></li>
<li class="chapter" data-level="7.5.2" data-path="modchapter.html"><a href="modchapter.html#simtypeI"><i class="fa fa-check"></i><b>7.5.2</b> Type I error rate of hypothesis tests</a></li>
<li class="chapter" data-level="7.5.3" data-path="modchapter.html"><a href="modchapter.html#simpower"><i class="fa fa-check"></i><b>7.5.3</b> Power of hypothesis tests</a></li>
<li class="chapter" data-level="7.5.4" data-path="modchapter.html"><a href="modchapter.html#powerlocation"><i class="fa fa-check"></i><b>7.5.4</b> Power of some tests of location</a></li>
<li class="chapter" data-level="7.5.5" data-path="modchapter.html"><a href="modchapter.html#simadvice"><i class="fa fa-check"></i><b>7.5.5</b> Some advice on simulation studies</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="modchapter.html"><a href="modchapter.html#sscus"><i class="fa fa-check"></i><b>7.6</b> Sample size computations using simulation</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="modchapter.html"><a href="modchapter.html#simcorpower"><i class="fa fa-check"></i><b>7.6.1</b> Writing your own simulation</a></li>
<li class="chapter" data-level="7.6.2" data-path="modchapter.html"><a href="modchapter.html#the-wilcoxon-mann-whitney-test"><i class="fa fa-check"></i><b>7.6.2</b> The Wilcoxon-Mann-Whitney test</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="modchapter.html"><a href="modchapter.html#bootstrap"><i class="fa fa-check"></i><b>7.7</b> Bootstrapping</a>
<ul>
<li class="chapter" data-level="7.7.1" data-path="modchapter.html"><a href="modchapter.html#a-general-approach"><i class="fa fa-check"></i><b>7.7.1</b> A general approach</a></li>
<li class="chapter" data-level="7.7.2" data-path="modchapter.html"><a href="modchapter.html#bootstrap-confidence-intervals"><i class="fa fa-check"></i><b>7.7.2</b> Bootstrap confidence intervals</a></li>
<li class="chapter" data-level="7.7.3" data-path="modchapter.html"><a href="modchapter.html#intervalinversion"><i class="fa fa-check"></i><b>7.7.3</b> Bootstrap hypothesis tests</a></li>
<li class="chapter" data-level="7.7.4" data-path="modchapter.html"><a href="modchapter.html#parametricbootstrap"><i class="fa fa-check"></i><b>7.7.4</b> The parametric bootstrap</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="modchapter.html"><a href="modchapter.html#reporting-statistical-results"><i class="fa fa-check"></i><b>7.8</b> Reporting statistical results</a>
<ul>
<li class="chapter" data-level="7.8.1" data-path="modchapter.html"><a href="modchapter.html#what-should-you-include"><i class="fa fa-check"></i><b>7.8.1</b> What should you include?</a></li>
<li class="chapter" data-level="7.8.2" data-path="modchapter.html"><a href="modchapter.html#citing-r-packages"><i class="fa fa-check"></i><b>7.8.2</b> Citing R packages</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="regression.html"><a href="regression.html"><i class="fa fa-check"></i><b>8</b> Regression models</a>
<ul>
<li class="chapter" data-level="8.1" data-path="regression.html"><a href="regression.html#linearmodels"><i class="fa fa-check"></i><b>8.1</b> Linear models</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="regression.html"><a href="regression.html#fitting-linear-models"><i class="fa fa-check"></i><b>8.1.1</b> Fitting linear models</a></li>
<li class="chapter" data-level="8.1.2" data-path="regression.html"><a href="regression.html#interactions-and-polynomial-terms"><i class="fa fa-check"></i><b>8.1.2</b> Interactions and polynomial terms</a></li>
<li class="chapter" data-level="8.1.3" data-path="regression.html"><a href="regression.html#dummy-variables"><i class="fa fa-check"></i><b>8.1.3</b> Dummy variables</a></li>
<li class="chapter" data-level="8.1.4" data-path="regression.html"><a href="regression.html#model-diagnostics"><i class="fa fa-check"></i><b>8.1.4</b> Model diagnostics</a></li>
<li class="chapter" data-level="8.1.5" data-path="regression.html"><a href="regression.html#transformations"><i class="fa fa-check"></i><b>8.1.5</b> Transformations</a></li>
<li class="chapter" data-level="8.1.6" data-path="regression.html"><a href="regression.html#alternatives-to-lm"><i class="fa fa-check"></i><b>8.1.6</b> Alternatives to <code>lm</code></a></li>
<li class="chapter" data-level="8.1.7" data-path="regression.html"><a href="regression.html#regbootstrap"><i class="fa fa-check"></i><b>8.1.7</b> Bootstrap confidence intervals for regression coefficients</a></li>
<li class="chapter" data-level="8.1.8" data-path="regression.html"><a href="regression.html#broom"><i class="fa fa-check"></i><b>8.1.8</b> Alternative summaries with <code>broom</code></a></li>
<li class="chapter" data-level="8.1.9" data-path="regression.html"><a href="regression.html#stepwise"><i class="fa fa-check"></i><b>8.1.9</b> Variable selection</a></li>
<li class="chapter" data-level="8.1.10" data-path="regression.html"><a href="regression.html#prediction"><i class="fa fa-check"></i><b>8.1.10</b> Prediction</a></li>
<li class="chapter" data-level="8.1.11" data-path="regression.html"><a href="regression.html#multipredict"><i class="fa fa-check"></i><b>8.1.11</b> Prediction for multiple datasets</a></li>
<li class="chapter" data-level="8.1.12" data-path="regression.html"><a href="regression.html#ANOVA"><i class="fa fa-check"></i><b>8.1.12</b> ANOVA</a></li>
<li class="chapter" data-level="8.1.13" data-path="regression.html"><a href="regression.html#bayeslm"><i class="fa fa-check"></i><b>8.1.13</b> Bayesian estimation of linear models</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="regression.html"><a href="regression.html#ethical-issues-in-regression-modelling"><i class="fa fa-check"></i><b>8.2</b> Ethical issues in regression modelling</a></li>
<li class="chapter" data-level="8.3" data-path="regression.html"><a href="regression.html#generalised-linear-models"><i class="fa fa-check"></i><b>8.3</b> Generalised linear models</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="regression.html"><a href="regression.html#logreg"><i class="fa fa-check"></i><b>8.3.1</b> Modelling proportions: Logistic regression</a></li>
<li class="chapter" data-level="8.3.2" data-path="regression.html"><a href="regression.html#bootstrap-confidence-intervals-1"><i class="fa fa-check"></i><b>8.3.2</b> Bootstrap confidence intervals</a></li>
<li class="chapter" data-level="8.3.3" data-path="regression.html"><a href="regression.html#model-diagnostics-1"><i class="fa fa-check"></i><b>8.3.3</b> Model diagnostics</a></li>
<li class="chapter" data-level="8.3.4" data-path="regression.html"><a href="regression.html#prediction-1"><i class="fa fa-check"></i><b>8.3.4</b> Prediction</a></li>
<li class="chapter" data-level="8.3.5" data-path="regression.html"><a href="regression.html#modelling-count-data"><i class="fa fa-check"></i><b>8.3.5</b> Modelling count data</a></li>
<li class="chapter" data-level="8.3.6" data-path="regression.html"><a href="regression.html#modelling-rates"><i class="fa fa-check"></i><b>8.3.6</b> Modelling rates</a></li>
<li class="chapter" data-level="8.3.7" data-path="regression.html"><a href="regression.html#bayesian-estimation-of-generalised-linear-models"><i class="fa fa-check"></i><b>8.3.7</b> Bayesian estimation of generalised linear models</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="regression.html"><a href="regression.html#mixedmodels"><i class="fa fa-check"></i><b>8.4</b> Mixed models</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="regression.html"><a href="regression.html#fitting-a-linear-mixed-model"><i class="fa fa-check"></i><b>8.4.1</b> Fitting a linear mixed model</a></li>
<li class="chapter" data-level="8.4.2" data-path="regression.html"><a href="regression.html#model-diagnostics-2"><i class="fa fa-check"></i><b>8.4.2</b> Model diagnostics</a></li>
<li class="chapter" data-level="8.4.3" data-path="regression.html"><a href="regression.html#lmmbootstrap"><i class="fa fa-check"></i><b>8.4.3</b> Bootstrapping</a></li>
<li class="chapter" data-level="8.4.4" data-path="regression.html"><a href="regression.html#nested-random-effects-and-multilevelhierarchical-models"><i class="fa fa-check"></i><b>8.4.4</b> Nested random effects and multilevel/hierarchical models</a></li>
<li class="chapter" data-level="8.4.5" data-path="regression.html"><a href="regression.html#anova-with-random-effects"><i class="fa fa-check"></i><b>8.4.5</b> ANOVA with random effects</a></li>
<li class="chapter" data-level="8.4.6" data-path="regression.html"><a href="regression.html#generalised-linear-mixed-models"><i class="fa fa-check"></i><b>8.4.6</b> Generalised linear mixed models</a></li>
<li class="chapter" data-level="8.4.7" data-path="regression.html"><a href="regression.html#bayesian-estimation-of-mixed-models"><i class="fa fa-check"></i><b>8.4.7</b> Bayesian estimation of mixed models</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="regression.html"><a href="regression.html#survival"><i class="fa fa-check"></i><b>8.5</b> Survival analysis</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="regression.html"><a href="regression.html#comparing-groups"><i class="fa fa-check"></i><b>8.5.1</b> Comparing groups</a></li>
<li class="chapter" data-level="8.5.2" data-path="regression.html"><a href="regression.html#the-cox-proportional-hazards-model"><i class="fa fa-check"></i><b>8.5.2</b> The Cox proportional hazards model</a></li>
<li class="chapter" data-level="8.5.3" data-path="regression.html"><a href="regression.html#accelerated-failure-time-models"><i class="fa fa-check"></i><b>8.5.3</b> Accelerated failure time models</a></li>
<li class="chapter" data-level="8.5.4" data-path="regression.html"><a href="regression.html#bayesian-survival-analysis"><i class="fa fa-check"></i><b>8.5.4</b> Bayesian survival analysis</a></li>
<li class="chapter" data-level="8.5.5" data-path="regression.html"><a href="regression.html#multivariate-survival-analysis"><i class="fa fa-check"></i><b>8.5.5</b> Multivariate survival analysis</a></li>
<li class="chapter" data-level="8.5.6" data-path="regression.html"><a href="regression.html#power-estimates-for-the-logrank-test"><i class="fa fa-check"></i><b>8.5.6</b> Power estimates for the logrank test</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="regression.html"><a href="regression.html#left-censored-data-and-nondetects"><i class="fa fa-check"></i><b>8.6</b> Left-censored data and nondetects</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="regression.html"><a href="regression.html#estimation"><i class="fa fa-check"></i><b>8.6.1</b> Estimation</a></li>
<li class="chapter" data-level="8.6.2" data-path="regression.html"><a href="regression.html#tests-of-means"><i class="fa fa-check"></i><b>8.6.2</b> Tests of means</a></li>
<li class="chapter" data-level="8.6.3" data-path="regression.html"><a href="regression.html#censored-regression"><i class="fa fa-check"></i><b>8.6.3</b> Censored regression</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="regression.html"><a href="regression.html#creating-matched-samples"><i class="fa fa-check"></i><b>8.7</b> Creating matched samples</a>
<ul>
<li class="chapter" data-level="8.7.1" data-path="regression.html"><a href="regression.html#propensity-score-matching"><i class="fa fa-check"></i><b>8.7.1</b> Propensity score matching</a></li>
<li class="chapter" data-level="8.7.2" data-path="regression.html"><a href="regression.html#stepwise-matching"><i class="fa fa-check"></i><b>8.7.2</b> Stepwise matching</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="mlchapter.html"><a href="mlchapter.html"><i class="fa fa-check"></i><b>9</b> Predictive modelling and machine learning</a>
<ul>
<li class="chapter" data-level="9.1" data-path="mlchapter.html"><a href="mlchapter.html#evaluating-predictive-models"><i class="fa fa-check"></i><b>9.1</b> Evaluating predictive models</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="mlchapter.html"><a href="mlchapter.html#evaluating-regression-models"><i class="fa fa-check"></i><b>9.1.1</b> Evaluating regression models</a></li>
<li class="chapter" data-level="9.1.2" data-path="mlchapter.html"><a href="mlchapter.html#test-training-splits"><i class="fa fa-check"></i><b>9.1.2</b> Test-training splits</a></li>
<li class="chapter" data-level="9.1.3" data-path="mlchapter.html"><a href="mlchapter.html#loocv"><i class="fa fa-check"></i><b>9.1.3</b> Leave-one-out cross-validation and <code>caret</code></a></li>
<li class="chapter" data-level="9.1.4" data-path="mlchapter.html"><a href="mlchapter.html#kfoldcv"><i class="fa fa-check"></i><b>9.1.4</b> k-fold cross-validation</a></li>
<li class="chapter" data-level="9.1.5" data-path="mlchapter.html"><a href="mlchapter.html#twinned-observations"><i class="fa fa-check"></i><b>9.1.5</b> Twinned observations</a></li>
<li class="chapter" data-level="9.1.6" data-path="mlchapter.html"><a href="mlchapter.html#bootstrapping"><i class="fa fa-check"></i><b>9.1.6</b> Bootstrapping</a></li>
<li class="chapter" data-level="9.1.7" data-path="mlchapter.html"><a href="mlchapter.html#classifieraccuracy"><i class="fa fa-check"></i><b>9.1.7</b> Evaluating classification models</a></li>
<li class="chapter" data-level="9.1.8" data-path="mlchapter.html"><a href="mlchapter.html#decisionboundaries"><i class="fa fa-check"></i><b>9.1.8</b> Visualising decision boundaries</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="mlchapter.html"><a href="mlchapter.html#ethical-issues-in-predictive-modelling"><i class="fa fa-check"></i><b>9.2</b> Ethical issues in predictive modelling</a></li>
<li class="chapter" data-level="9.3" data-path="mlchapter.html"><a href="mlchapter.html#modellingchallenges"><i class="fa fa-check"></i><b>9.3</b> Challenges in predictive modelling</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="mlchapter.html"><a href="mlchapter.html#imbalanced"><i class="fa fa-check"></i><b>9.3.1</b> Handling class imbalance</a></li>
<li class="chapter" data-level="9.3.2" data-path="mlchapter.html"><a href="mlchapter.html#varimportance"><i class="fa fa-check"></i><b>9.3.2</b> Assessing variable importance</a></li>
<li class="chapter" data-level="9.3.3" data-path="mlchapter.html"><a href="mlchapter.html#extrapolation"><i class="fa fa-check"></i><b>9.3.3</b> Extrapolation</a></li>
<li class="chapter" data-level="9.3.4" data-path="mlchapter.html"><a href="mlchapter.html#missing-data-and-imputation"><i class="fa fa-check"></i><b>9.3.4</b> Missing data and imputation</a></li>
<li class="chapter" data-level="9.3.5" data-path="mlchapter.html"><a href="mlchapter.html#endless-waiting"><i class="fa fa-check"></i><b>9.3.5</b> Endless waiting</a></li>
<li class="chapter" data-level="9.3.6" data-path="mlchapter.html"><a href="mlchapter.html#overfittingtestset"><i class="fa fa-check"></i><b>9.3.6</b> Overfitting to the test set</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="mlchapter.html"><a href="mlchapter.html#regularised"><i class="fa fa-check"></i><b>9.4</b> Regularised regression models</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="mlchapter.html"><a href="mlchapter.html#ridge-regression"><i class="fa fa-check"></i><b>9.4.1</b> Ridge regression</a></li>
<li class="chapter" data-level="9.4.2" data-path="mlchapter.html"><a href="mlchapter.html#lasso"><i class="fa fa-check"></i><b>9.4.2</b> The lasso</a></li>
<li class="chapter" data-level="9.4.3" data-path="mlchapter.html"><a href="mlchapter.html#elastic-net"><i class="fa fa-check"></i><b>9.4.3</b> Elastic net</a></li>
<li class="chapter" data-level="9.4.4" data-path="mlchapter.html"><a href="mlchapter.html#choosing-the-best-model"><i class="fa fa-check"></i><b>9.4.4</b> Choosing the best model</a></li>
<li class="chapter" data-level="9.4.5" data-path="mlchapter.html"><a href="mlchapter.html#regularised-mixed-models"><i class="fa fa-check"></i><b>9.4.5</b> Regularised mixed models</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="mlchapter.html"><a href="mlchapter.html#mlmethods"><i class="fa fa-check"></i><b>9.5</b> Machine learning models</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="mlchapter.html"><a href="mlchapter.html#decisiontrees"><i class="fa fa-check"></i><b>9.5.1</b> Decision trees</a></li>
<li class="chapter" data-level="9.5.2" data-path="mlchapter.html"><a href="mlchapter.html#randomforests"><i class="fa fa-check"></i><b>9.5.2</b> Random forests</a></li>
<li class="chapter" data-level="9.5.3" data-path="mlchapter.html"><a href="mlchapter.html#boosted-trees"><i class="fa fa-check"></i><b>9.5.3</b> Boosted trees</a></li>
<li class="chapter" data-level="9.5.4" data-path="mlchapter.html"><a href="mlchapter.html#model-trees"><i class="fa fa-check"></i><b>9.5.4</b> Model trees</a></li>
<li class="chapter" data-level="9.5.5" data-path="mlchapter.html"><a href="mlchapter.html#discriminant-analysis"><i class="fa fa-check"></i><b>9.5.5</b> Discriminant analysis</a></li>
<li class="chapter" data-level="9.5.6" data-path="mlchapter.html"><a href="mlchapter.html#support-vector-machines"><i class="fa fa-check"></i><b>9.5.6</b> Support vector machines</a></li>
<li class="chapter" data-level="9.5.7" data-path="mlchapter.html"><a href="mlchapter.html#nearest-neighbours-classifiers"><i class="fa fa-check"></i><b>9.5.7</b> Nearest neighbours classifiers</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="mlchapter.html"><a href="mlchapter.html#tsforecast"><i class="fa fa-check"></i><b>9.6</b> Forecasting time series</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="mlchapter.html"><a href="mlchapter.html#decomposition"><i class="fa fa-check"></i><b>9.6.1</b> Decomposition</a></li>
<li class="chapter" data-level="9.6.2" data-path="mlchapter.html"><a href="mlchapter.html#forecasting-using-arima-models"><i class="fa fa-check"></i><b>9.6.2</b> Forecasting using ARIMA models</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="mlchapter.html"><a href="mlchapter.html#deploying-models"><i class="fa fa-check"></i><b>9.7</b> Deploying models</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="mlchapter.html"><a href="mlchapter.html#creating-apis-with-plumber"><i class="fa fa-check"></i><b>9.7.1</b> Creating APIs with <code>plumber</code></a></li>
<li class="chapter" data-level="9.7.2" data-path="mlchapter.html"><a href="mlchapter.html#different-types-of-output"><i class="fa fa-check"></i><b>9.7.2</b> Different types of output</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="advancedchapter.html"><a href="advancedchapter.html"><i class="fa fa-check"></i><b>10</b> Advanced topics</a>
<ul>
<li class="chapter" data-level="10.1" data-path="advancedchapter.html"><a href="advancedchapter.html#moreonpackages"><i class="fa fa-check"></i><b>10.1</b> More on packages</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="advancedchapter.html"><a href="advancedchapter.html#loading-and-auto-installing-packages"><i class="fa fa-check"></i><b>10.1.1</b> Loading and auto-installing packages</a></li>
<li class="chapter" data-level="10.1.2" data-path="advancedchapter.html"><a href="advancedchapter.html#updating-r-and-your-packages"><i class="fa fa-check"></i><b>10.1.2</b> Updating R and your packages</a></li>
<li class="chapter" data-level="10.1.3" data-path="advancedchapter.html"><a href="advancedchapter.html#alternative-repositories"><i class="fa fa-check"></i><b>10.1.3</b> Alternative repositories</a></li>
<li class="chapter" data-level="10.1.4" data-path="advancedchapter.html"><a href="advancedchapter.html#removing-packages"><i class="fa fa-check"></i><b>10.1.4</b> Removing packages</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="advancedchapter.html"><a href="advancedchapter.html#parallel"><i class="fa fa-check"></i><b>10.2</b> Speeding up computations with parallelisation</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="advancedchapter.html"><a href="advancedchapter.html#parallelising-for-loops"><i class="fa fa-check"></i><b>10.2.1</b> Parallelising <code>for</code> loops</a></li>
<li class="chapter" data-level="10.2.2" data-path="advancedchapter.html"><a href="advancedchapter.html#parallelising-functionals"><i class="fa fa-check"></i><b>10.2.2</b> Parallelising functionals</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="advancedchapter.html"><a href="advancedchapter.html#linearalgebra"><i class="fa fa-check"></i><b>10.3</b> Linear algebra and matrices</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="advancedchapter.html"><a href="advancedchapter.html#creating-matrices"><i class="fa fa-check"></i><b>10.3.1</b> Creating matrices</a></li>
<li class="chapter" data-level="10.3.2" data-path="advancedchapter.html"><a href="advancedchapter.html#sparse-matrices"><i class="fa fa-check"></i><b>10.3.2</b> Sparse matrices</a></li>
<li class="chapter" data-level="10.3.3" data-path="advancedchapter.html"><a href="advancedchapter.html#matrix-operations"><i class="fa fa-check"></i><b>10.3.3</b> Matrix operations</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="advancedchapter.html"><a href="advancedchapter.html#integration"><i class="fa fa-check"></i><b>10.4</b> Integration with other programming languages</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="advancedchapter.html"><a href="advancedchapter.html#integration-with-c"><i class="fa fa-check"></i><b>10.4.1</b> Integration with C++</a></li>
<li class="chapter" data-level="10.4.2" data-path="advancedchapter.html"><a href="advancedchapter.html#integration-with-python"><i class="fa fa-check"></i><b>10.4.2</b> Integration with Python</a></li>
<li class="chapter" data-level="10.4.3" data-path="advancedchapter.html"><a href="advancedchapter.html#integration-with-tensorflow-and-pytorch"><i class="fa fa-check"></i><b>10.4.3</b> Integration with Tensorflow and PyTorch</a></li>
<li class="chapter" data-level="10.4.4" data-path="advancedchapter.html"><a href="advancedchapter.html#integration-with-spark"><i class="fa fa-check"></i><b>10.4.4</b> Integration with Spark</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="errorchapter.html"><a href="errorchapter.html"><i class="fa fa-check"></i><b>11</b> Debugging</a>
<ul>
<li class="chapter" data-level="11.1" data-path="errorchapter.html"><a href="errorchapter.html#debugging"><i class="fa fa-check"></i><b>11.1</b> Debugging</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="errorchapter.html"><a href="errorchapter.html#find-out-where-the-error-occured-with-traceback"><i class="fa fa-check"></i><b>11.1.1</b> Find out where the error occured with <code>traceback</code></a></li>
<li class="chapter" data-level="11.1.2" data-path="errorchapter.html"><a href="errorchapter.html#interactive-debugging-of-functions-with-debug"><i class="fa fa-check"></i><b>11.1.2</b> Interactive debugging of functions with <code>debug</code></a></li>
<li class="chapter" data-level="11.1.3" data-path="errorchapter.html"><a href="errorchapter.html#investigate-the-environment-with-recover"><i class="fa fa-check"></i><b>11.1.3</b> Investigate the environment with <code>recover</code></a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="errorchapter.html"><a href="errorchapter.html#commonerrors"><i class="fa fa-check"></i><b>11.2</b> Common error messages</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="errorchapter.html"><a href="errorchapter.html#section-1"><i class="fa fa-check"></i><b>11.2.1</b> <code>+</code></a></li>
<li class="chapter" data-level="11.2.2" data-path="errorchapter.html"><a href="errorchapter.html#could-not-find-function"><i class="fa fa-check"></i><b>11.2.2</b> <code>could not find function</code></a></li>
<li class="chapter" data-level="11.2.3" data-path="errorchapter.html"><a href="errorchapter.html#object-not-found"><i class="fa fa-check"></i><b>11.2.3</b> <code>object not found</code></a></li>
<li class="chapter" data-level="11.2.4" data-path="errorchapter.html"><a href="errorchapter.html#cannot-open-the-connection-and-no-such-file-or-directory"><i class="fa fa-check"></i><b>11.2.4</b> <code>cannot open the connection</code> and <code>No such file or directory</code></a></li>
<li class="chapter" data-level="11.2.5" data-path="errorchapter.html"><a href="errorchapter.html#invalid-description-argument"><i class="fa fa-check"></i><b>11.2.5</b> <code>invalid 'description' argument</code></a></li>
<li class="chapter" data-level="11.2.6" data-path="errorchapter.html"><a href="errorchapter.html#missing-value-where-truefalse-needed"><i class="fa fa-check"></i><b>11.2.6</b> <code>missing value where TRUE/FALSE needed</code></a></li>
<li class="chapter" data-level="11.2.7" data-path="errorchapter.html"><a href="errorchapter.html#unexpected-in-..."><i class="fa fa-check"></i><b>11.2.7</b> <code>unexpected '=' in ...</code></a></li>
<li class="chapter" data-level="11.2.8" data-path="errorchapter.html"><a href="errorchapter.html#attempt-to-apply-non-function"><i class="fa fa-check"></i><b>11.2.8</b> <code>attempt to apply non-function</code></a></li>
<li class="chapter" data-level="11.2.9" data-path="errorchapter.html"><a href="errorchapter.html#undefined-columns-selected"><i class="fa fa-check"></i><b>11.2.9</b> <code>undefined columns selected</code></a></li>
<li class="chapter" data-level="11.2.10" data-path="errorchapter.html"><a href="errorchapter.html#subscript-out-of-bounds"><i class="fa fa-check"></i><b>11.2.10</b> <code>subscript out of bounds</code></a></li>
<li class="chapter" data-level="11.2.11" data-path="errorchapter.html"><a href="errorchapter.html#object-of-type-closure-is-not-subsettable"><i class="fa fa-check"></i><b>11.2.11</b> <code>Object of type ‘closure’ is not subsettable</code></a></li>
<li class="chapter" data-level="11.2.12" data-path="errorchapter.html"><a href="errorchapter.html#operator-is-invalid-for-atomic-vectors"><i class="fa fa-check"></i><b>11.2.12</b> <code>$ operator is invalid for atomic vectors</code></a></li>
<li class="chapter" data-level="11.2.13" data-path="errorchapter.html"><a href="errorchapter.html#list-object-cannot-be-coerced-to-type-double"><i class="fa fa-check"></i><b>11.2.13</b> <code>(list) object cannot be coerced to type ‘double’</code></a></li>
<li class="chapter" data-level="11.2.14" data-path="errorchapter.html"><a href="errorchapter.html#arguments-imply-differing-number-of-rows"><i class="fa fa-check"></i><b>11.2.14</b> <code>arguments imply differing number of rows</code></a></li>
<li class="chapter" data-level="11.2.15" data-path="errorchapter.html"><a href="errorchapter.html#non-numeric-argument-to-a-binary-operator"><i class="fa fa-check"></i><b>11.2.15</b> <code>non-numeric argument to a binary operator</code></a></li>
<li class="chapter" data-level="11.2.16" data-path="errorchapter.html"><a href="errorchapter.html#non-numeric-argument-to-mathematical-function"><i class="fa fa-check"></i><b>11.2.16</b> <code>non-numeric argument to mathematical function</code></a></li>
<li class="chapter" data-level="11.2.17" data-path="errorchapter.html"><a href="errorchapter.html#cannot-allocate-vector-of-size-..."><i class="fa fa-check"></i><b>11.2.17</b> <code>cannot allocate vector of size ...</code></a></li>
<li class="chapter" data-level="11.2.18" data-path="errorchapter.html"><a href="errorchapter.html#error-in-plot.new-figure-margins-too-large"><i class="fa fa-check"></i><b>11.2.18</b> <code>Error in plot.new() : figure margins too large</code></a></li>
<li class="chapter" data-level="11.2.19" data-path="errorchapter.html"><a href="errorchapter.html#error-in-.call.graphicsc_palette2-.callc_palette2-null-invalid-graphics-state"><i class="fa fa-check"></i><b>11.2.19</b> <code>Error in .Call.graphics(C_palette2, .Call(C_palette2, NULL)) : invalid graphics state</code></a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="errorchapter.html"><a href="errorchapter.html#commonwarnings"><i class="fa fa-check"></i><b>11.3</b> Common warning messages</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="errorchapter.html"><a href="errorchapter.html#replacement-has-...-rows-..."><i class="fa fa-check"></i><b>11.3.1</b> <code>replacement has ... rows ...</code></a></li>
<li class="chapter" data-level="11.3.2" data-path="errorchapter.html"><a href="errorchapter.html#iferror"><i class="fa fa-check"></i><b>11.3.2</b> <code>the condition has length &gt; 1 and only the first element will be used</code></a></li>
<li class="chapter" data-level="11.3.3" data-path="errorchapter.html"><a href="errorchapter.html#number-of-items-to-replace-is-not-a-multiple-of-replacement-length"><i class="fa fa-check"></i><b>11.3.3</b> <code>number of items to replace is not a multiple of replacement length</code></a></li>
<li class="chapter" data-level="11.3.4" data-path="errorchapter.html"><a href="errorchapter.html#longer-object-length-is-not-a-multiple-of-shorter-object-length"><i class="fa fa-check"></i><b>11.3.4</b> <code>longer object length is not a multiple of shorter object length</code></a></li>
<li class="chapter" data-level="11.3.5" data-path="errorchapter.html"><a href="errorchapter.html#nas-introduced-by-coercion"><i class="fa fa-check"></i><b>11.3.5</b> <code>NAs introduced by coercion</code></a></li>
<li class="chapter" data-level="11.3.6" data-path="errorchapter.html"><a href="errorchapter.html#package-is-not-available-for-r-version-4.x.x"><i class="fa fa-check"></i><b>11.3.6</b> <code>package is not available (for R version 4.x.x)</code></a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="errorchapter.html"><a href="errorchapter.html#installationmessages"><i class="fa fa-check"></i><b>11.4</b> Messages printed when installing <code>ggplot2</code></a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="mathschap.html"><a href="mathschap.html"><i class="fa fa-check"></i><b>12</b> Mathematical appendix</a>
<ul>
<li class="chapter" data-level="12.1" data-path="mathschap.html"><a href="mathschap.html#bootstrapcimaths"><i class="fa fa-check"></i><b>12.1</b> Bootstrap confidence intervals</a></li>
<li class="chapter" data-level="12.2" data-path="mathschap.html"><a href="mathschap.html#confintequal"><i class="fa fa-check"></i><b>12.2</b> The equivalence between confidence intervals and hypothesis tests</a></li>
<li class="chapter" data-level="12.3" data-path="mathschap.html"><a href="mathschap.html#twotypesofpvalues"><i class="fa fa-check"></i><b>12.3</b> Two types of p-values</a></li>
<li class="chapter" data-level="12.4" data-path="mathschap.html"><a href="mathschap.html#deviance"><i class="fa fa-check"></i><b>12.4</b> Deviance tests</a></li>
<li class="chapter" data-level="12.5" data-path="mathschap.html"><a href="mathschap.html#regreg"><i class="fa fa-check"></i><b>12.5</b> Regularised regression</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="solutions.html"><a href="solutions.html"><i class="fa fa-check"></i><b>13</b> Solutions to exercises</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#solutionsch2"><i class="fa fa-check"></i>Chapter 2</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#solutionsch3"><i class="fa fa-check"></i>Chapter 3</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#solutionsch4"><i class="fa fa-check"></i>Chapter 4</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#ch5solutions"><i class="fa fa-check"></i>Chapter 5</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#ch6solutions"><i class="fa fa-check"></i>Chapter 6</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#ch7solutions"><i class="fa fa-check"></i>Chapter 7</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#ch7bsolutions"><i class="fa fa-check"></i>Chapter 8</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#ch8solutions"><i class="fa fa-check"></i>Chapter 9</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>Bibliography</a>
<ul>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html#references1"><i class="fa fa-check"></i>Further reading</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html#references2"><i class="fa fa-check"></i>Online resources</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html#references3"><i class="fa fa-check"></i>References</a></li>
</ul></li>
<li class="divider"></li>
<li>&copy; 2023 psnam</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R 통계분석</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="regression" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">8</span> Regression models<a href="regression.html#regression" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Regression models, in which explanatory variables are used to model the behaviour of a response variable, is without a doubt the most commonly used class of models in the statistical toolbox. In this chapter, we will have a look at different types of regression models tailored to many different sorts of data and applications.</p>
<p>After reading this chapter, you will be able to use R to:</p>
<ul>
<li>Fit and evaluate linear and generalised linear models,</li>
<li>Fit and evaluate mixed models,</li>
<li>Fit survival analysis models,</li>
<li>Analyse data with left-censored observations,</li>
<li>Create matched samples.</li>
</ul>
<div id="linearmodels" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Linear models<a href="regression.html#linearmodels" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Being flexible enough to handle different types of data, yet simple enough to be useful and interpretable, linear models are among the most important tools in the statistics toolbox. In this section, we’ll discuss how to fit and evaluate linear models in R.</p>
<div id="fitting-linear-models" class="section level3 hasAnchor" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Fitting linear models<a href="regression.html#fitting-linear-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We had a quick glance at linear models in Section <a href="datachapter.html#firstlm">3.7</a>. There we used the <code>mtcars</code> data:</p>
<div class="sourceCode" id="cb797"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb797-1"><a href="regression.html#cb797-1" aria-hidden="true" tabindex="-1"></a>?mtcars</span>
<span id="cb797-2"><a href="regression.html#cb797-2" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(mtcars)</span></code></pre></div>
<p>First, we plotted fuel consumption (<code>mpg</code>) against gross horsepower (<code>hp</code>):</p>
<div class="sourceCode" id="cb798"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb798-1"><a href="regression.html#cb798-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb798-2"><a href="regression.html#cb798-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(hp, mpg)) <span class="sc">+</span></span>
<span id="cb798-3"><a href="regression.html#cb798-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>()</span></code></pre></div>
<p>Given <span class="math inline">\(n\)</span> observations of <span class="math inline">\(p\)</span> explanatory variables (also known as predictors, covariates, independent variables, and features), the linear model is:</p>
<p><span class="math display">\[y_i=\beta_0 +\beta_1 x_{i1}+\beta_2 x_{i2}+\cdots+\beta_p x_{ip} + \epsilon_i,\qquad i=1,\ldots,n\]</span>
where <span class="math inline">\(\epsilon_i\)</span> is a random error with mean 0, meaning that the model also can be written as:</p>
<p><span class="math display">\[E(y_i)=\beta_0 +\beta_1 x_{i1}+\beta_2 x_{i2}+\cdots+\beta_p x_{ip},\qquad i=1,\ldots,n\]</span>
We fitted a linear model using <code>lm</code>, with <code>mpg</code> as the response variable and <code>hp</code> as the explanatory variable:</p>
<div class="sourceCode" id="cb799"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb799-1"><a href="regression.html#cb799-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp, <span class="at">data =</span> mtcars)</span>
<span id="cb799-2"><a href="regression.html#cb799-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>We added the fitted line to the scatterplot by using <code>geom_abline</code>:</p>
<div class="sourceCode" id="cb800"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb800-1"><a href="regression.html#cb800-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check model coefficients:</span></span>
<span id="cb800-2"><a href="regression.html#cb800-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(m)</span>
<span id="cb800-3"><a href="regression.html#cb800-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb800-4"><a href="regression.html#cb800-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add regression line to plot:</span></span>
<span id="cb800-5"><a href="regression.html#cb800-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(hp, mpg)) <span class="sc">+</span></span>
<span id="cb800-6"><a href="regression.html#cb800-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb800-7"><a href="regression.html#cb800-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="fu">coef</span>(m)[<span class="dv">1</span>], <span class="at">slope =</span> <span class="fu">coef</span>(m)[<span class="dv">2</span>]),</span>
<span id="cb800-8"><a href="regression.html#cb800-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p>We had a look at some diagnostic plots given by applying <code>plot</code> to our fitted model <code>m</code>:</p>
<div class="sourceCode" id="cb801"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb801-1"><a href="regression.html#cb801-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m)</span></code></pre></div>
<p>Finally, we added another variable, the car weight <code>wt</code>, to the model:</p>
<div class="sourceCode" id="cb802"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb802-1"><a href="regression.html#cb802-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb802-2"><a href="regression.html#cb802-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>Next, we’ll look at what more R has to offer when it comes to regression. Before that though, it’s a good idea to do a quick exercise to make sure that you remember how to fit linear models.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7exc15" class="exercise"><strong>Exercise 8.1  </strong></span>The <code>sales-weather.csv</code> data from Section <a href="messychapter.html#mergedata">5.12</a> describes the weather in a region during the first quarter of 2020. <a href="http://www.modernstatisticswithr.com/data.zip">Download the file from the book’s web page</a>. Fit a linear regression model with <code>TEMPERATURE</code> as the response variable and <code>SUN_HOURS</code> as an explanatory variable. Plot the results. Is there a connection?</p>
<p>You’ll return to and expand this model in the next few exercises, so make sure to save your code.</p>
</div>
<p><a href="solutions.html#ch7solutions15">(Click here to go to the solution.)</a></p>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch7exc15b" class="exercise"><strong>Exercise 8.2  </strong></span>Fit a linear model to the <code>mtcars</code> data using the formula <code>mpg ~ .</code>. What happens? What is <code>~ .</code> a shorthand for?</p>
</div>
<p><a href="solutions.html#ch7solutions15b">(Click here to go to the solution.)</a></p>
</div>
<div id="interactions-and-polynomial-terms" class="section level3 hasAnchor" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Interactions and polynomial terms<a href="regression.html#interactions-and-polynomial-terms" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>It seems plausible that there could be an <em>interaction</em> between gross horsepower and weight. We can include an interaction term by adding <code>hp:wt</code> to the formula:</p>
<div class="sourceCode" id="cb803"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb803-1"><a href="regression.html#cb803-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt <span class="sc">+</span> hp<span class="sc">:</span>wt, <span class="at">data =</span> mtcars)</span>
<span id="cb803-2"><a href="regression.html#cb803-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>Alternatively, to include the main effects of <code>hp</code> and <code>wt</code> along with the interaction effect, we can use <code>hp*wt</code> as a shorthand for <code>hp + wt + hp:wt</code> to write the model formula more concisely:</p>
<div class="sourceCode" id="cb804"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb804-1"><a href="regression.html#cb804-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp<span class="sc">*</span>wt, <span class="at">data =</span> mtcars)</span>
<span id="cb804-2"><a href="regression.html#cb804-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>It is often recommended to centre the explanatory variables in regression models, i.e. to shift them so that they all have mean 0. There are a number of benefits to this: for instance that the intercept then can be interpreted as the expected value of the response variable when all explanatory variables are equal to their means, i.e. in an average case<a href="#fn55" class="footnote-ref" id="fnref55"><sup>55</sup></a>. It can also reduce any multicollinearity in the data, particularly when including interactions or polynomial terms in the model. Finally, it can reduce problems with numerical instability that may arise due to floating point arithmetics. Note however, that there is no need to centre the response variable<a href="#fn56" class="footnote-ref" id="fnref56"><sup>56</sup></a>.</p>
<p>Centring the explanatory variables can be done using <code>scale</code>:</p>
<div class="sourceCode" id="cb805"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb805-1"><a href="regression.html#cb805-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new data frame, leaving the response variable mpg</span></span>
<span id="cb805-2"><a href="regression.html#cb805-2" aria-hidden="true" tabindex="-1"></a><span class="co"># unchanged, while centring the explanatory variables:</span></span>
<span id="cb805-3"><a href="regression.html#cb805-3" aria-hidden="true" tabindex="-1"></a>mtcars_scaled <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mpg =</span> mtcars[,<span class="dv">1</span>],</span>
<span id="cb805-4"><a href="regression.html#cb805-4" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">scale</span>(mtcars[,<span class="sc">-</span><span class="dv">1</span>], <span class="at">center =</span> <span class="cn">TRUE</span>,</span>
<span id="cb805-5"><a href="regression.html#cb805-5" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">scale =</span> <span class="cn">FALSE</span>))</span>
<span id="cb805-6"><a href="regression.html#cb805-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp<span class="sc">*</span>wt, <span class="at">data =</span> mtcars_scaled)</span>
<span id="cb805-7"><a href="regression.html#cb805-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>If we wish to add a polynomial term to the model, we can do so by wrapping the polynomial in <code>I()</code>. For instance, to add a quadratic effect in the form of the square weight of a vehicle to the model, we’d use:</p>
<div class="sourceCode" id="cb806"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb806-1"><a href="regression.html#cb806-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp<span class="sc">*</span>wt <span class="sc">+</span> <span class="fu">I</span>(wt<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> mtcars_scaled)</span>
<span id="cb806-2"><a href="regression.html#cb806-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
</div>
<div id="dummy-variables" class="section level3 hasAnchor" number="8.1.3">
<h3><span class="header-section-number">8.1.3</span> Dummy variables<a href="regression.html#dummy-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Categorical variables can be included in regression models by using <em>dummy variables</em>. A dummy variable takes the values 0 and 1, indicating that an observation either belongs to a category (1) or not (0). If the original categorical variable has more than two categories, <span class="math inline">\(c\)</span> categories, say, the number of dummy variables included in the regression model should be <span class="math inline">\(c-1\)</span> (with the last category corresponding to all dummy variables being 0). R does this automatically for us if we include a <code>factor</code> variable in a regression model:</p>
<div class="sourceCode" id="cb807"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb807-1"><a href="regression.html#cb807-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make cyl a categorical variable:</span></span>
<span id="cb807-2"><a href="regression.html#cb807-2" aria-hidden="true" tabindex="-1"></a>mtcars<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">factor</span>(mtcars<span class="sc">$</span>cyl)</span>
<span id="cb807-3"><a href="regression.html#cb807-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb807-4"><a href="regression.html#cb807-4" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp<span class="sc">*</span>wt <span class="sc">+</span> cyl, <span class="at">data =</span> mtcars)</span>
<span id="cb807-5"><a href="regression.html#cb807-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>Note how only two categories, 6 cylinders and 8 cylinders, are shown in the summary table. The third category, 4 cylinders, corresponds to both those dummy variables being 0. Therefore, the coefficient estimates for <code>cyl6</code> and <code>cyl8</code> are relative to the remaining <em>reference category</em> <code>cyl4</code>. For instance, compared to <code>cyl4</code> cars, <code>cyl6</code> cars have a higher fuel consumption, with their <code>mpg</code> being <span class="math inline">\(1.26\)</span> lower.</p>
<p>We can control which category is used as the reference category by setting the order of the <code>factor</code> variable, as in Section <a href="messychapter.html#factors">5.4</a>. The first <code>factor</code> level is always used as the reference, so if for instance we want to use <code>cyl6</code> as our reference category, we’d do the following:</p>
<div class="sourceCode" id="cb808"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb808-1"><a href="regression.html#cb808-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make cyl a categorical variable with cyl6 as</span></span>
<span id="cb808-2"><a href="regression.html#cb808-2" aria-hidden="true" tabindex="-1"></a><span class="co"># reference variable:</span></span>
<span id="cb808-3"><a href="regression.html#cb808-3" aria-hidden="true" tabindex="-1"></a>mtcars<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">factor</span>(mtcars<span class="sc">$</span>cyl, <span class="at">levels =</span></span>
<span id="cb808-4"><a href="regression.html#cb808-4" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">4</span>, <span class="dv">8</span>))</span>
<span id="cb808-5"><a href="regression.html#cb808-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb808-6"><a href="regression.html#cb808-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp<span class="sc">*</span>wt <span class="sc">+</span> cyl, <span class="at">data =</span> mtcars)</span>
<span id="cb808-7"><a href="regression.html#cb808-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>Dummy variables are frequently used for modelling differences between different groups. Including only the dummy variable corresponds to using different intercepts for different groups. If we also include an interaction with the dummy variable, we can get different slopes for different groups. Consider the model <span class="math display">\[E(y_i)=\beta_0+\beta_1 x_{i1}+\beta_2 x_{i2}+\beta_{12} x_{i1}x_{i2},\qquad i=1,\ldots,n\]</span> where <span class="math inline">\(x_1\)</span> is numeric and <span class="math inline">\(x_2\)</span> is a dummy variable. Then the intercept and slope changes depending on the value of <span class="math inline">\(x_2\)</span> as follows:</p>
<p><span class="math display">\[E(y_i)=\beta_0+\beta_1 x_{i1},\qquad \mbox{if } x_2=0,\]</span>
<span class="math display">\[E(y_i)=(\beta_0+\beta_2)+(\beta_1+\beta_{12}) x_{i1},\qquad \mbox{if } x_2=1.\]</span>
This yields a model where the intercept and slope differs between the two groups that <span class="math inline">\(x_2\)</span> represents.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7exc16" class="exercise"><strong>Exercise 8.3  </strong></span>Return to the weather model from Exercise <a href="regression.html#exr:ch7exc15">8.1</a>. Create a dummy variable for precipitation (zero precipitation or non-zero precipitation) and add it to your model. Also include an interaction term between the precipitation dummy and the number of sun hours. Are any of the coefficients significantly non-zero?</p>
</div>
<p><a href="solutions.html#ch7solutions16">(Click here to go to the solution.)</a></p>
</div>
<div id="model-diagnostics" class="section level3 hasAnchor" number="8.1.4">
<h3><span class="header-section-number">8.1.4</span> Model diagnostics<a href="regression.html#model-diagnostics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There are a few different ways in which we can plot the fitted model. First, we can of course make a scatterplot of the data and add a curve showing the fitted values corresponding to the different points. These can be obtained by running <code>predict(m)</code> with our fitted model <code>m</code>.</p>
<div class="sourceCode" id="cb809"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb809-1"><a href="regression.html#cb809-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit two models:</span></span>
<span id="cb809-2"><a href="regression.html#cb809-2" aria-hidden="true" tabindex="-1"></a>mtcars<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">factor</span>(mtcars<span class="sc">$</span>cyl)</span>
<span id="cb809-3"><a href="regression.html#cb809-3" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars) <span class="co"># Simple model</span></span>
<span id="cb809-4"><a href="regression.html#cb809-4" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp<span class="sc">*</span>wt <span class="sc">+</span> cyl, <span class="at">data =</span> mtcars) <span class="co"># Complex model</span></span>
<span id="cb809-5"><a href="regression.html#cb809-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb809-6"><a href="regression.html#cb809-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frames with fitted values:</span></span>
<span id="cb809-7"><a href="regression.html#cb809-7" aria-hidden="true" tabindex="-1"></a>m1_pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">hp =</span> mtcars<span class="sc">$</span>hp, <span class="at">mpg_pred =</span> <span class="fu">predict</span>(m1))</span>
<span id="cb809-8"><a href="regression.html#cb809-8" aria-hidden="true" tabindex="-1"></a>m2_pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">hp =</span> mtcars<span class="sc">$</span>hp, <span class="at">mpg_pred =</span> <span class="fu">predict</span>(m2))</span>
<span id="cb809-9"><a href="regression.html#cb809-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb809-10"><a href="regression.html#cb809-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot fitted values:</span></span>
<span id="cb809-11"><a href="regression.html#cb809-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb809-12"><a href="regression.html#cb809-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(hp, mpg)) <span class="sc">+</span></span>
<span id="cb809-13"><a href="regression.html#cb809-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb809-14"><a href="regression.html#cb809-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> m1_pred, <span class="fu">aes</span>(<span class="at">x =</span> hp, <span class="at">y =</span> mpg_pred),</span>
<span id="cb809-15"><a href="regression.html#cb809-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb809-16"><a href="regression.html#cb809-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> m2_pred, <span class="fu">aes</span>(<span class="at">x =</span> hp, <span class="at">y =</span> mpg_pred),</span>
<span id="cb809-17"><a href="regression.html#cb809-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p>We could also plot the observed values against the fitted values:</p>
<div class="sourceCode" id="cb810"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb810-1"><a href="regression.html#cb810-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mtcars)</span>
<span id="cb810-2"><a href="regression.html#cb810-2" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Observed =</span> <span class="fu">rep</span>(mtcars<span class="sc">$</span>mpg, <span class="dv">2</span>),</span>
<span id="cb810-3"><a href="regression.html#cb810-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Fitted =</span> <span class="fu">c</span>(<span class="fu">predict</span>(m1), <span class="fu">predict</span>(m2)),</span>
<span id="cb810-4"><a href="regression.html#cb810-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Model =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;Model 1&quot;</span>, <span class="st">&quot;Model 2&quot;</span>), <span class="fu">c</span>(n, n)))</span>
<span id="cb810-5"><a href="regression.html#cb810-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb810-6"><a href="regression.html#cb810-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(models, <span class="fu">aes</span>(Fitted, Observed)) <span class="sc">+</span></span>
<span id="cb810-7"><a href="regression.html#cb810-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb810-8"><a href="regression.html#cb810-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="sc">~</span> Model, <span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb810-9"><a href="regression.html#cb810-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb810-10"><a href="regression.html#cb810-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xlab</span>(<span class="st">&quot;Fitted values&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Observed values&quot;</span>)</span></code></pre></div>
<p>Linear models are fitted and analysed using a number of assumptions, most of which are assessed by looking at plots of the model residuals, <span class="math inline">\(y_i-\hat{y}_i\)</span>, where <span class="math inline">\(\hat{y}_i\)</span> is the fitted value for observation <span class="math inline">\(i\)</span>. Some important assumptions are:</p>
<ul>
<li>The model is <em>linear in the parameters</em>: we check this by looking for non-linear patterns in the residuals, or in the plot of observed against fitted values.</li>
<li><em>The observations are independent</em>: which can be difficult to assess visually. We’ll look at models that are designed to handle correlated observations in Sections <a href="regression.html#mixedmodels">8.4</a> and <a href="mlchapter.html#tsforecast">9.6</a>.</li>
<li><em>Homoscedasticity</em>: that the random errors all have the same variance. We check this by looking for non-constant variance in the residuals. The opposite of homoscedasticity is heteroscedasticity.</li>
<li><em>Normally distributed random errors</em>: this assumption is important if we want to use the traditional parametric p-values, confidence intervals and prediction intervals. If we use permutation p-values or bootstrap intervals (as we will later in this chapter), we no longer need this assumption.</li>
</ul>
<p>Additionally, residual plots can be used to find influential points that (possibly) have a large impact on the model coefficients (influence is measured using <em>Cook’s distance</em> and potential influence using <em>leverage</em>). We’ve already seen that we can use <code>plot(m)</code> to create some diagnostic plots. To get more and better-looking plots, we can use the <code>autoplot</code> function for <code>lm</code> objects from the <code>ggfortify</code> package:</p>
<div class="sourceCode" id="cb811"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb811-1"><a href="regression.html#cb811-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify)</span>
<span id="cb811-2"><a href="regression.html#cb811-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(m1, <span class="at">which =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">label.size =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>In each of the plots, we look for the following:</p>
<ul>
<li>Residuals versus fitted: look for patterns that can indicate non-linearity, e.g. that the residuals all are high in some areas and low in others. The blue line is there to aid the eye - it should ideally be relatively close to a straight line (in this case, it isn’t perfectly straight, which could indicate a mild non-linearity).</li>
<li>Normal Q-Q: see if the points follow the line, which would indicate that the residuals (which we for this purpose can think of as estimates of the random errors) follow a normal distribution.</li>
<li>Scale-Location: similar to the residuals versus fitted plot, this plot shows whether the residuals are evenly spread for different values of the fitted values. Look for patterns in how much the residuals vary - if they e.g. vary more for large fitted values, then that is a sign of heteroscedasticity. A horizontal blue line is a sign of homoscedasticity.</li>
<li>Cook’s distance: look for points with high values. A commonly-cited rule-of-thumb (Cook &amp; Weisberg, 1982) says that values above 1 indicate points with a high influence.</li>
<li>Residuals versus leverage: look for points with a high residual and high leverage. Observations with a high residual but low leverage deviate from the fitted model but don’t affect it much. Observations with a high residual and a high leverage likely have a strong influence on the model fit, meaning that the fitted model could be quite different if these points were removed from the dataset.</li>
<li>Cook’s distance versus leverage: look for observations with a high Cook’s distance and a high leverage, which are likely to have a strong influence on the model fit.</li>
</ul>
<p>A formal test for heteroscedasticity, the Breusch-Pagan test, is available in the <code>car</code> package as a complement to graphical inspection. A low p-value indicates statistical evidence for heteroscedasticity. To run the test, we use <code>ncvTest</code> (where “ncv” stands for non-constant variance):</p>
<div class="sourceCode" id="cb812"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb812-1"><a href="regression.html#cb812-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;car&quot;</span>)</span>
<span id="cb812-2"><a href="regression.html#cb812-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb812-3"><a href="regression.html#cb812-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ncvTest</span>(m1)</span></code></pre></div>
<p>A common problem in linear regression models is multicollinearity, i.e. explanatory variables that are strongly correlated. Multicollinearity can cause your <span class="math inline">\(\beta\)</span> coefficients and p-values to change greatly if there are small changes in the data, rendering them unreliable. To check if you have multicollinearity in your data, you can create a scatterplot matrix of your explanatory variables, as in Section <a href="eda.html#scatterplotmatrix">4.8.1</a>:</p>
<div class="sourceCode" id="cb813"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb813-1"><a href="regression.html#cb813-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb813-2"><a href="regression.html#cb813-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(mtcars[, <span class="sc">-</span><span class="dv">1</span>])</span></code></pre></div>
<p>In this case, there are some highly correlated pairs, <code>hp</code> and <code>disp</code> among them. As a numerical measure of collinearity, we can use the generalised variance inflation factor (GVIF), given by the <code>vif</code> function in the <code>car</code> package:</p>
<div class="sourceCode" id="cb814"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb814-1"><a href="regression.html#cb814-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb814-2"><a href="regression.html#cb814-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> ., <span class="at">data =</span> mtcars)</span>
<span id="cb814-3"><a href="regression.html#cb814-3" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(m)</span></code></pre></div>
<p>A high GVIF indicates that a variable is highly correlated with other explanatory variables in the dataset. Recommendations for what a “high GVIF” is varies, from 2.5 to 10 or more.</p>
<p>You can mitigate problems related to multicollinearity by:</p>
<ul>
<li>Removing one or more of the correlated variables from the model (because they are strongly correlated, they measure almost the same thing anyway!),</li>
<li>Centring your explanatory variables (particularly if you include polynomial terms),</li>
<li>Using a regularised regression model (which we’ll do in Section <a href="mlchapter.html#regularised">9.4</a>).</li>
</ul>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7exc17a" class="exercise"><strong>Exercise 8.4  </strong></span>Below are two simulated datasets. One exhibits a nonlinear dependence between the variables, and the other exhibits heteroscedasticity. Fit a model with <code>y</code> as the response variable and <code>x</code> as the explanatory variable for each dataset, and make some residual plots. Which dataset suffers from which problem?</p>
</div>
<div class="sourceCode" id="cb815"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb815-1"><a href="regression.html#cb815-1" aria-hidden="true" tabindex="-1"></a>exdata1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb815-2"><a href="regression.html#cb815-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">x =</span> <span class="fu">c</span>(<span class="fl">2.99</span>, <span class="fl">5.01</span>, <span class="fl">8.84</span>, <span class="fl">6.18</span>, <span class="fl">8.57</span>, <span class="fl">8.23</span>, <span class="fl">8.48</span>, <span class="fl">0.04</span>, <span class="fl">6.80</span>,</span>
<span id="cb815-3"><a href="regression.html#cb815-3" aria-hidden="true" tabindex="-1"></a>         <span class="fl">7.62</span>, <span class="fl">7.94</span>, <span class="fl">6.30</span>, <span class="fl">4.21</span>, <span class="fl">3.61</span>, <span class="fl">7.08</span>, <span class="fl">3.50</span>, <span class="fl">9.05</span>, <span class="fl">1.06</span>,</span>
<span id="cb815-4"><a href="regression.html#cb815-4" aria-hidden="true" tabindex="-1"></a>         <span class="fl">0.65</span>, <span class="fl">8.66</span>, <span class="fl">0.08</span>, <span class="fl">1.48</span>, <span class="fl">2.96</span>, <span class="fl">2.54</span>, <span class="fl">4.45</span>),</span>
<span id="cb815-5"><a href="regression.html#cb815-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">5.25</span>, <span class="sc">-</span><span class="fl">0.80</span>, <span class="fl">4.38</span>, <span class="sc">-</span><span class="fl">0.75</span>, <span class="fl">9.93</span>, <span class="fl">13.79</span>, <span class="fl">19.75</span>, <span class="fl">24.65</span>,</span>
<span id="cb815-6"><a href="regression.html#cb815-6" aria-hidden="true" tabindex="-1"></a>         <span class="fl">6.84</span>, <span class="fl">11.95</span>, <span class="fl">12.24</span>, <span class="fl">7.97</span>, <span class="sc">-</span><span class="fl">1.20</span>, <span class="sc">-</span><span class="fl">1.76</span>, <span class="fl">10.36</span>, <span class="fl">1.17</span>,</span>
<span id="cb815-7"><a href="regression.html#cb815-7" aria-hidden="true" tabindex="-1"></a>         <span class="fl">15.41</span>, <span class="fl">15.83</span>, <span class="fl">18.78</span>, <span class="fl">12.75</span>, <span class="fl">24.17</span>, <span class="fl">12.49</span>, <span class="fl">4.58</span>, <span class="fl">6.76</span>,</span>
<span id="cb815-8"><a href="regression.html#cb815-8" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span><span class="fl">2.92</span>))</span>
<span id="cb815-9"><a href="regression.html#cb815-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb815-10"><a href="regression.html#cb815-10" aria-hidden="true" tabindex="-1"></a>exdata2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb815-11"><a href="regression.html#cb815-11" aria-hidden="true" tabindex="-1"></a>   <span class="at">x =</span> <span class="fu">c</span>(<span class="fl">5.70</span>, <span class="fl">8.03</span>, <span class="fl">8.86</span>, <span class="fl">0.82</span>, <span class="fl">1.23</span>, <span class="fl">2.96</span>, <span class="fl">0.13</span>, <span class="fl">8.53</span>, <span class="fl">8.18</span>,</span>
<span id="cb815-12"><a href="regression.html#cb815-12" aria-hidden="true" tabindex="-1"></a>         <span class="fl">6.88</span>, <span class="fl">4.02</span>, <span class="fl">9.11</span>, <span class="fl">0.19</span>, <span class="fl">6.91</span>, <span class="fl">0.34</span>, <span class="fl">4.19</span>, <span class="fl">0.25</span>, <span class="fl">9.72</span>,</span>
<span id="cb815-13"><a href="regression.html#cb815-13" aria-hidden="true" tabindex="-1"></a>         <span class="fl">9.83</span>, <span class="fl">6.77</span>, <span class="fl">4.40</span>, <span class="fl">4.70</span>, <span class="fl">6.03</span>, <span class="fl">5.87</span>, <span class="fl">7.49</span>),</span>
<span id="cb815-14"><a href="regression.html#cb815-14" aria-hidden="true" tabindex="-1"></a>   <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">21.66</span>, <span class="fl">26.23</span>, <span class="fl">19.82</span>, <span class="fl">2.46</span>, <span class="fl">2.83</span>, <span class="fl">8.86</span>, <span class="fl">0.25</span>, <span class="fl">16.08</span>,</span>
<span id="cb815-15"><a href="regression.html#cb815-15" aria-hidden="true" tabindex="-1"></a>         <span class="fl">17.67</span>, <span class="fl">24.86</span>, <span class="fl">8.19</span>, <span class="fl">28.45</span>, <span class="fl">0.52</span>, <span class="fl">19.88</span>, <span class="fl">0.71</span>, <span class="fl">12.19</span>,</span>
<span id="cb815-16"><a href="regression.html#cb815-16" aria-hidden="true" tabindex="-1"></a>         <span class="fl">0.64</span>, <span class="fl">25.29</span>, <span class="fl">26.72</span>, <span class="fl">18.06</span>, <span class="fl">10.70</span>, <span class="fl">8.27</span>, <span class="fl">15.49</span>, <span class="fl">15.58</span>,</span>
<span id="cb815-17"><a href="regression.html#cb815-17" aria-hidden="true" tabindex="-1"></a>         <span class="fl">19.17</span>))</span></code></pre></div>
<p><a href="solutions.html#ch7solutions17a">(Click here to go to the solution.)</a></p>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch7exc17" class="exercise"><strong>Exercise 8.5  </strong></span>We continue our investigation of the weather models from Exercises <a href="regression.html#exr:ch7exc15">8.1</a> and <a href="regression.html#exr:ch7exc16">8.3</a>.</p>
<ol style="list-style-type: decimal">
<li><p>Plot the observed values against the fitted values for the two models that you’ve fitted. Does either model seem to have a better fit?</p></li>
<li><p>Create residual plots for the second model from Exercise <a href="regression.html#exr:ch7exc16">8.3</a>. Are there any influential points? Any patterns? Any signs of heteroscedasticity?</p></li>
</ol>
</div>
<p><a href="solutions.html#ch7solutions17">(Click here to go to the solution.)</a></p>
</div>
<div id="transformations" class="section level3 hasAnchor" number="8.1.5">
<h3><span class="header-section-number">8.1.5</span> Transformations<a href="regression.html#transformations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If your data displays signs of heteroscedasticity or non-normal residuals, you can sometimes use a Box-Cox transformation (Box &amp; Cox, 1964) to mitigate those problems. The Box-Cox transformation is applied to your dependent variable <span class="math inline">\(y\)</span>. What it looks like is determined by a parameter <span class="math inline">\(\lambda\)</span>. The transformation is defined as <span class="math inline">\(\frac{y_i^\lambda-1}{\lambda}\)</span> if <span class="math inline">\(\lambda\neq 0\)</span> and <span class="math inline">\(\ln(y_i)\)</span> if <span class="math inline">\(\lambda=0\)</span>. <span class="math inline">\(\lambda=1\)</span> corresponds to no transformation at all. The <code>boxcox</code> function in <code>MASS</code> is useful for finding an appropriate choice of <span class="math inline">\(\lambda\)</span>. Choose a <span class="math inline">\(\lambda\)</span> that is close to the peak (inside the interval indicated by the outer dotted lines) of the curve plotted by <code>boxcox</code>:</p>
<div class="sourceCode" id="cb816"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb816-1"><a href="regression.html#cb816-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb816-2"><a href="regression.html#cb816-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb816-3"><a href="regression.html#cb816-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb816-4"><a href="regression.html#cb816-4" aria-hidden="true" tabindex="-1"></a><span class="fu">boxcox</span>(m)</span></code></pre></div>
<p>In this case, the curve indicates that <span class="math inline">\(\lambda=0\)</span>, which corresponds to a log-transformation, could be a good choice. Let’s give it a go:</p>
<div class="sourceCode" id="cb817"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb817-1"><a href="regression.html#cb817-1" aria-hidden="true" tabindex="-1"></a>mtcars<span class="sc">$</span>logmpg <span class="ot">&lt;-</span> <span class="fu">log</span>(mtcars<span class="sc">$</span>mpg)</span>
<span id="cb817-2"><a href="regression.html#cb817-2" aria-hidden="true" tabindex="-1"></a>m_bc <span class="ot">&lt;-</span> <span class="fu">lm</span>(logmpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb817-3"><a href="regression.html#cb817-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_bc)</span>
<span id="cb817-4"><a href="regression.html#cb817-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb817-5"><a href="regression.html#cb817-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify)</span>
<span id="cb817-6"><a href="regression.html#cb817-6" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(m_bc, <span class="at">which =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">label.size =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>The model fit seems to have improved after the transformation. The downside is that we now are modelling the log-mpg rather than mpg, which make the model coefficients a little difficult to interpret.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7exc18" class="exercise"><strong>Exercise 8.6  </strong></span>Run <code>boxcox</code> with your model from Exercise <a href="regression.html#exr:ch7exc16">8.3</a>. Does it indicate that a transformation can be useful for your model?</p>
</div>
<p><a href="solutions.html#ch7solutions18">(Click here to go to the solution.)</a></p>
</div>
<div id="alternatives-to-lm" class="section level3 hasAnchor" number="8.1.6">
<h3><span class="header-section-number">8.1.6</span> Alternatives to <code>lm</code><a href="regression.html#alternatives-to-lm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Non-normal regression errors can sometimes be an indication that you need to transform your data, that your model is missing an important explanatory variable, that there are interaction effects that aren’t accounted for, or that the relationship between the variables is non-linear. But sometimes, you get non-normal errors simply because the errors are non-normal.</p>
<p>The p-values reported by <code>summary</code> are computed under the assumption of normally distributed regression errors, and can be sensitive to deviations from normality. An alternative is to use the <code>lmp</code> function from the <code>lmPerm</code> package, which provides permutation test p-values instead. This doesn’t affect the model fitting in any way - the only difference is how the p-values are computed. Moreover, the syntax for <code>lmp</code> is identical to that of <code>lm</code>:</p>
<div class="sourceCode" id="cb818"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb818-1"><a href="regression.html#cb818-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, install lmPerm:</span></span>
<span id="cb818-2"><a href="regression.html#cb818-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;lmPerm&quot;</span>)</span>
<span id="cb818-3"><a href="regression.html#cb818-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb818-4"><a href="regression.html#cb818-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get summary table with permutation p-values:</span></span>
<span id="cb818-5"><a href="regression.html#cb818-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmPerm)</span>
<span id="cb818-6"><a href="regression.html#cb818-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lmp</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb818-7"><a href="regression.html#cb818-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>In some cases, you need to change the arguments of <code>lmp</code> to get reliable p-values. We’ll have a look at that in Exercise <a href="regression.html#exr:ch7exc21b">8.12</a>. Relatedly, in Section <a href="regression.html#regbootstrap">8.1.7</a> we’ll see how to construct bootstrap confidence intervals for the parameter estimates.</p>
<p>Another option that does affect the model fitting is to use a <em>robust</em> regression model based on M-estimators. Such models tend to be less sensitive to outliers, and can be useful if you are concerned about the influence of deviating points. The <code>rlm</code> function in <code>MASS</code> is used for this. As was the case for <code>lmp</code>, the syntax for <code>rlm</code> is identical to that of <code>lm</code>:</p>
<div class="sourceCode" id="cb819"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb819-1"><a href="regression.html#cb819-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb819-2"><a href="regression.html#cb819-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">rlm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb819-3"><a href="regression.html#cb819-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>Another option is to use Bayesian estimation, which we’ll discuss in Section <a href="regression.html#bayeslm">8.1.13</a>.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7exc19" class="exercise"><strong>Exercise 8.7  </strong></span>Refit your model from Exercise <a href="regression.html#exr:ch7exc16">8.3</a> using <code>lmp</code>. Are the two main effects still significant?</p>
</div>
<p><a href="solutions.html#ch7solutions19">(Click here to go to the solution.)</a></p>
</div>
<div id="regbootstrap" class="section level3 hasAnchor" number="8.1.7">
<h3><span class="header-section-number">8.1.7</span> Bootstrap confidence intervals for regression coefficients<a href="regression.html#regbootstrap" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Assuming normality, we can obtain parametric confidence intervals for the model coefficients using <code>confint</code>:</p>
<div class="sourceCode" id="cb820"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb820-1"><a href="regression.html#cb820-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb820-2"><a href="regression.html#cb820-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb820-3"><a href="regression.html#cb820-3" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(m)</span></code></pre></div>
<p>I usually prefer to use bootstrap confidence intervals, which we can obtain using <code>boot</code> and <code>boot.ci</code>, as we’ll do next. Note that the only random part in the linear model
<span class="math display">\[y_i=\beta_0 +\beta_1 x_{i1}+\beta_2 x_{i2}+\cdots+\beta_p x_{ip} + \epsilon_i,\qquad i=1,\ldots,n\]</span>
is the error term <span class="math inline">\(\epsilon_i\)</span>. In most cases, it is therefore this term (and this term only) that we wish to resample. The explanatory variables should remain constant throughout the resampling process; the inference is conditioned on the values of the explanatory variables.</p>
<p>To achieve this, we’ll resample from the model residuals, and add those to the values predicted by the fitted function, which creates new bootstrap values of the response variable. We’ll then fit a linear model to these values, from which we obtain observations from the bootstrap distribution of the model coefficients.</p>
<p>It turns out that the bootstrap performs better if we resample not from the original residuals <span class="math inline">\(e_1,\ldots,e_n\)</span>, but from scaled and centred residuals <span class="math inline">\(r_i-\bar{r}\)</span>, where each <span class="math inline">\(r_i\)</span> is a scaled version of residual <span class="math inline">\(e_i\)</span>, scaled by the leverage <span class="math inline">\(h_i\)</span>:</p>
<p><span class="math display">\[r_i=\frac{e_i}{\sqrt{1-h_i}},\]</span>
see Chapter 6 of Davison &amp; Hinkley (1997) for details. The leverages can be computed using <code>lm.influence</code>.</p>
<p>We implement this procedure in the code below (and will then have a look at convenience functions that help us achieve the same thing more easily). It makes use of <code>formula</code>, which can be used to extract the model formula from regression models:</p>
<div class="sourceCode" id="cb821"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb821-1"><a href="regression.html#cb821-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb821-2"><a href="regression.html#cb821-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-3"><a href="regression.html#cb821-3" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, i, predictions, residuals) {</span>
<span id="cb821-4"><a href="regression.html#cb821-4" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create the bootstrap value of response variable by</span></span>
<span id="cb821-5"><a href="regression.html#cb821-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># adding a randomly drawn scaled residual to the value of</span></span>
<span id="cb821-6"><a href="regression.html#cb821-6" aria-hidden="true" tabindex="-1"></a>      <span class="co"># the fitted function for each observation:</span></span>
<span id="cb821-7"><a href="regression.html#cb821-7" aria-hidden="true" tabindex="-1"></a>      data[,<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]] <span class="ot">&lt;-</span> predictions <span class="sc">+</span> residuals[i]</span>
<span id="cb821-8"><a href="regression.html#cb821-8" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb821-9"><a href="regression.html#cb821-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Fit a new model with the bootstrap value of the response</span></span>
<span id="cb821-10"><a href="regression.html#cb821-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># variable and the original explanatory variables:</span></span>
<span id="cb821-11"><a href="regression.html#cb821-11" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> <span class="fu">lm</span>(formula, <span class="at">data =</span> data)</span>
<span id="cb821-12"><a href="regression.html#cb821-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">coef</span>(m))</span>
<span id="cb821-13"><a href="regression.html#cb821-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb821-14"><a href="regression.html#cb821-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-15"><a href="regression.html#cb821-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the linear model:</span></span>
<span id="cb821-16"><a href="regression.html#cb821-16" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb821-17"><a href="regression.html#cb821-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-18"><a href="regression.html#cb821-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute scaled and centred residuals:</span></span>
<span id="cb821-19"><a href="regression.html#cb821-19" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fu">lm.influence</span>(m)<span class="sc">$</span>hat)</span>
<span id="cb821-20"><a href="regression.html#cb821-20" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> res <span class="sc">-</span> <span class="fu">mean</span>(res)</span>
<span id="cb821-21"><a href="regression.html#cb821-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-22"><a href="regression.html#cb821-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the bootstrap, extracting the model formula and the</span></span>
<span id="cb821-23"><a href="regression.html#cb821-23" aria-hidden="true" tabindex="-1"></a><span class="co"># fitted function from the model m:</span></span>
<span id="cb821-24"><a href="regression.html#cb821-24" aria-hidden="true" tabindex="-1"></a>boot_res <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> mtcars, <span class="at">statistic =</span> coefficients,</span>
<span id="cb821-25"><a href="regression.html#cb821-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">R =</span> <span class="dv">999</span>, <span class="at">formula =</span> <span class="fu">formula</span>(m),</span>
<span id="cb821-26"><a href="regression.html#cb821-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">predictions =</span> <span class="fu">predict</span>(m),</span>
<span id="cb821-27"><a href="regression.html#cb821-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">residuals =</span> res)</span>
<span id="cb821-28"><a href="regression.html#cb821-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-29"><a href="regression.html#cb821-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute 95 % confidence intervals:</span></span>
<span id="cb821-30"><a href="regression.html#cb821-30" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">1</span>) <span class="co"># Intercept</span></span>
<span id="cb821-31"><a href="regression.html#cb821-31" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">2</span>) <span class="co"># hp</span></span>
<span id="cb821-32"><a href="regression.html#cb821-32" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">3</span>) <span class="co"># wt</span></span></code></pre></div>
<p>The argument <code>index</code> in <code>boot.ci</code> should be the row number of the parameter in the table given by <code>summary</code>. The intercept is on the first row, and so its <code>index</code> is 1, <code>hp</code> is on the second row and its <code>index</code> is 2, and so on.</p>
<p>Clearly, the above code is a little unwieldy. Fortunately, the <code>car</code> package contains a function called <code>Boot</code> that can be used to bootstrap regression models in the exact same way:</p>
<div class="sourceCode" id="cb822"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb822-1"><a href="regression.html#cb822-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb822-2"><a href="regression.html#cb822-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb822-3"><a href="regression.html#cb822-3" aria-hidden="true" tabindex="-1"></a>boot_res <span class="ot">&lt;-</span> <span class="fu">Boot</span>(m, <span class="at">method =</span> <span class="st">&quot;residual&quot;</span>, <span class="at">R =</span> <span class="dv">9999</span>)</span>
<span id="cb822-4"><a href="regression.html#cb822-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb822-5"><a href="regression.html#cb822-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute 95 % confidence intervals:</span></span>
<span id="cb822-6"><a href="regression.html#cb822-6" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>)</span></code></pre></div>
<p>Finally, the most convenient approach is to use <code>boot_summary</code> from the <code>boot.pval</code> package. It provides a data frame with estimates, bootstrap confidence intervals, and bootstrap p-values (computed using interval inversion) for the model coefficients. The arguments specify what interval type and resampling strategy to use (more on the latter in Exercise <a href="regression.html#exr:ch7exc20b">8.9</a>):</p>
<div class="sourceCode" id="cb823"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb823-1"><a href="regression.html#cb823-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot.pval)</span>
<span id="cb823-2"><a href="regression.html#cb823-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_summary</span>(m, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">method =</span> <span class="st">&quot;residual&quot;</span>, <span class="at">R =</span> <span class="dv">9999</span>)</span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7exc20" class="exercise"><strong>Exercise 8.8  </strong></span>Refit your model from Exercise <a href="regression.html#exr:ch7exc16">8.3</a> using a robust regression estimator with <code>rlm</code>. Compute confidence intervals for the coefficients of the robust regression model.</p>
</div>
<p><a href="solutions.html#ch7solutions20">(Click here to go to the solution.)</a></p>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch7exc20b" class="exercise"><strong>Exercise 8.9  </strong></span>In an alternative bootstrap scheme for regression models, often referred to as <em>case resampling</em>, the observations (or cases) <span class="math inline">\((y_i, x_{i1},\ldots,x_{ip})\)</span> are resampled instead of the residuals. This approach can be applied when the explanatory variables can be treated as being random (but measured without error) rather than fixed. It can also be useful for models with heteroscedasticity, as it doesn’t rely on assumptions about constant variance (which, on the other hand, makes it less efficient if the errors actually are homoscedastic).</p>
<p>Read the documentation for <code>boot_summary</code> to see how you can compute confidence intervals for the coefficients in the model <code>m &lt;- lm(mpg ~ hp + wt, data = mtcars)</code> using case resampling. Do they differ substantially from those obtained using residual resampling in this case?</p>
</div>
<p><a href="solutions.html#ch7solutions20b">(Click here to go to the solution.)</a></p>
</div>
<div id="broom" class="section level3 hasAnchor" number="8.1.8">
<h3><span class="header-section-number">8.1.8</span> Alternative summaries with <code>broom</code><a href="regression.html#broom" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>broom</code> package contains some useful functions when working with linear models (and many other common models), which allow us to get various summaries of the model fit in useful formats. Let’s install it:</p>
<div class="sourceCode" id="cb824"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb824-1"><a href="regression.html#cb824-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;broom&quot;</span>)</span></code></pre></div>
<p>A model fitted with <code>m</code> is stored as a <code>list</code> with lots of elements:</p>
<div class="sourceCode" id="cb825"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb825-1"><a href="regression.html#cb825-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb825-2"><a href="regression.html#cb825-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(m)</span></code></pre></div>
<p>How can we access the information about the model? For instance, we may want to get the summary table from <code>summary</code>, but as a data frame rather than as printed text. Here are two ways of doing this, using <code>summary</code> and the <code>tidy</code> function from <code>broom</code>:</p>
<div class="sourceCode" id="cb826"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb826-1"><a href="regression.html#cb826-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using base R:</span></span>
<span id="cb826-2"><a href="regression.html#cb826-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)<span class="sc">$</span>coefficients</span>
<span id="cb826-3"><a href="regression.html#cb826-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb826-4"><a href="regression.html#cb826-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Using broom:</span></span>
<span id="cb826-5"><a href="regression.html#cb826-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb826-6"><a href="regression.html#cb826-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(m)</span></code></pre></div>
<p><code>tidy</code> is the better option if you want to retrieve the table as part of a pipeline. For instance, if you want to adjust the p-values for multiplicity using Bonferroni correction (Section <a href="modchapter.html#multipletesting">7.2.5</a>), you could do as follows:</p>
<div class="sourceCode" id="cb827"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb827-1"><a href="regression.html#cb827-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb827-2"><a href="regression.html#cb827-2" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb827-3"><a href="regression.html#cb827-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb827-4"><a href="regression.html#cb827-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy</span>() <span class="sc">%$%</span> </span>
<span id="cb827-5"><a href="regression.html#cb827-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">p.adjust</span>(p.value, <span class="at">method =</span> <span class="st">&quot;bonferroni&quot;</span>)</span></code></pre></div>
<p>If you prefer bootstrap p-values, you can use <code>boot_summary</code> from <code>boot.pval</code> similarly. That function also includes an argument for adjusting the p-values for multiplicity:</p>
<div class="sourceCode" id="cb828"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb828-1"><a href="regression.html#cb828-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot.pval)</span>
<span id="cb828-2"><a href="regression.html#cb828-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars) <span class="sc">%&gt;%</span></span>
<span id="cb828-3"><a href="regression.html#cb828-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">boot_summary</span>(<span class="at">adjust.method =</span> <span class="st">&quot;bonferroni&quot;</span>)</span></code></pre></div>
<p>Another useful function in <code>broom</code> is <code>glance</code>, which lets us get some summary statistics about the model:</p>
<div class="sourceCode" id="cb829"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb829-1"><a href="regression.html#cb829-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(m)</span></code></pre></div>
<p>Finally, <code>augment</code> can be used to add predicted values, residuals, and Cook’s distances to the dataset used for fitting the model, which of course can be very useful for model diagnostics:</p>
<div class="sourceCode" id="cb830"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb830-1"><a href="regression.html#cb830-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To get the data frame with predictions and residuals added:</span></span>
<span id="cb830-2"><a href="regression.html#cb830-2" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(m)</span>
<span id="cb830-3"><a href="regression.html#cb830-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb830-4"><a href="regression.html#cb830-4" aria-hidden="true" tabindex="-1"></a><span class="co"># To plot the observed values against the fitted values:</span></span>
<span id="cb830-5"><a href="regression.html#cb830-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb830-6"><a href="regression.html#cb830-6" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span> </span>
<span id="cb830-7"><a href="regression.html#cb830-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb830-8"><a href="regression.html#cb830-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">augment</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb830-9"><a href="regression.html#cb830-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(.fitted, mpg)) <span class="sc">+</span></span>
<span id="cb830-10"><a href="regression.html#cb830-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb830-11"><a href="regression.html#cb830-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xlab</span>(<span class="st">&quot;Fitted values&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Observed values&quot;</span>)</span></code></pre></div>
</div>
<div id="stepwise" class="section level3 hasAnchor" number="8.1.9">
<h3><span class="header-section-number">8.1.9</span> Variable selection<a href="regression.html#stepwise" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A common question when working with linear models is what variables to include in your model. Common practices for variable selection include stepwise regression methods, where variables are added to or removed from the model depending on p-values, <span class="math inline">\(R^2\)</span> values, or information criteria like AIC or BIC.</p>
<p><strong>Don’t ever do this if your main interest is p-values.</strong> Stepwise regression increases the risk of type I errors, renders the p-values of your final model invalid, and can lead to over-fitting; see e.g. Smith (2018). Instead, you should let your research hypothesis guide your choice of variables, or base your choice on a pilot study.</p>
<p>If your main interest is prediction, then that is a completely different story. For predictive models, it is usually recommended that variable selection and model fitting should be done simultaneously. This can be done using regularised regression models, to which Section <a href="mlchapter.html#regularised">9.4</a> is devoted.</p>
</div>
<div id="prediction" class="section level3 hasAnchor" number="8.1.10">
<h3><span class="header-section-number">8.1.10</span> Prediction<a href="regression.html#prediction" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>An important use of linear models is prediction. In R, this is done using <code>predict</code>. By providing a fitted model and a new dataset, we can get predictions.</p>
<p>Let’s use one of the models that we fitted to the <code>mtcars</code> data to make predictions for two cars that aren’t from the 1970’s. Below, we create a data frame with data for a 2009 Volvo XC90 D3 AWD (with a fuel consumption of 29 mpg) and a 2019 Ferrari Roma (15.4 mpg):</p>
<div class="sourceCode" id="cb831"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb831-1"><a href="regression.html#cb831-1" aria-hidden="true" tabindex="-1"></a>new_cars <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">hp =</span> <span class="fu">c</span>(<span class="dv">161</span>, <span class="dv">612</span>), <span class="at">wt =</span> <span class="fu">c</span>(<span class="fl">4.473</span>, <span class="fl">3.462</span>),</span>
<span id="cb831-2"><a href="regression.html#cb831-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">row.names =</span> <span class="fu">c</span>(<span class="st">&quot;Volvo XC90&quot;</span>, <span class="st">&quot;Ferrari Roma&quot;</span>))</span></code></pre></div>
<p>To get the model predictions for these new cars, we run the following:</p>
<div class="sourceCode" id="cb832"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb832-1"><a href="regression.html#cb832-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(m, new_cars)</span></code></pre></div>
<p><code>predict</code> also lets us obtain prediction intervals for our prediction, under the assumption of normality<a href="#fn57" class="footnote-ref" id="fnref57"><sup>57</sup></a>. To get 90 % prediction intervals, we add <code>interval = "prediction"</code> and <code>level = 0.9</code>:</p>
<div class="sourceCode" id="cb833"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb833-1"><a href="regression.html#cb833-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb833-2"><a href="regression.html#cb833-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(m, new_cars,</span>
<span id="cb833-3"><a href="regression.html#cb833-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">interval =</span> <span class="st">&quot;prediction&quot;</span>,</span>
<span id="cb833-4"><a href="regression.html#cb833-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">level =</span> <span class="fl">0.9</span>)</span></code></pre></div>
<p>If we were using a transformed <span class="math inline">\(y\)</span>-variable, we’d probably have to transform the predictions back to the original scale for them to be useful:</p>
<div class="sourceCode" id="cb834"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb834-1"><a href="regression.html#cb834-1" aria-hidden="true" tabindex="-1"></a>mtcars<span class="sc">$</span>logmpg <span class="ot">&lt;-</span> <span class="fu">log</span>(mtcars<span class="sc">$</span>mpg)</span>
<span id="cb834-2"><a href="regression.html#cb834-2" aria-hidden="true" tabindex="-1"></a>m_bc <span class="ot">&lt;-</span> <span class="fu">lm</span>(logmpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb834-3"><a href="regression.html#cb834-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb834-4"><a href="regression.html#cb834-4" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_bc, new_cars,</span>
<span id="cb834-5"><a href="regression.html#cb834-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">interval =</span> <span class="st">&quot;prediction&quot;</span>,</span>
<span id="cb834-6"><a href="regression.html#cb834-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">level =</span> <span class="fl">0.9</span>)</span>
<span id="cb834-7"><a href="regression.html#cb834-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb834-8"><a href="regression.html#cb834-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions for log-mpg:</span></span>
<span id="cb834-9"><a href="regression.html#cb834-9" aria-hidden="true" tabindex="-1"></a>preds</span>
<span id="cb834-10"><a href="regression.html#cb834-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform back to original scale:</span></span>
<span id="cb834-11"><a href="regression.html#cb834-11" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(preds)</span></code></pre></div>
<p>The <code>lmp</code> function that we used to compute permutation p-values does not offer confidence intervals. We can however compute bootstrap prediction intervals using the code below. Prediction intervals try to capture two sources of uncertainty:</p>
<ul>
<li><em>Model uncertainty</em>, which we will capture by resampling the data and make predictions for the expected value of the observation,</li>
<li><em>Random noise</em>, i.e. that almost all observations deviate from their expected value. We will capture this by resampling residuals from the fitted bootstrap models.</li>
</ul>
<p>Consequently, the value that we generate in each bootstrap replication will be the sum of a prediction and a resampled residual (see Davison &amp; Hinkley (1997), Section 6.3, for further details):</p>
<div class="sourceCode" id="cb835"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb835-1"><a href="regression.html#cb835-1" aria-hidden="true" tabindex="-1"></a>boot_pred <span class="ot">&lt;-</span> <span class="cf">function</span>(data, new_data, model, i,</span>
<span id="cb835-2"><a href="regression.html#cb835-2" aria-hidden="true" tabindex="-1"></a>                      formula, predictions, residuals){</span>
<span id="cb835-3"><a href="regression.html#cb835-3" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Resample residuals and fit new model:</span></span>
<span id="cb835-4"><a href="regression.html#cb835-4" aria-hidden="true" tabindex="-1"></a>      data[,<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]] <span class="ot">&lt;-</span> predictions <span class="sc">+</span> residuals[i]</span>
<span id="cb835-5"><a href="regression.html#cb835-5" aria-hidden="true" tabindex="-1"></a>      m_boot <span class="ot">&lt;-</span> <span class="fu">lm</span>(formula, <span class="at">data =</span> data)</span>
<span id="cb835-6"><a href="regression.html#cb835-6" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb835-7"><a href="regression.html#cb835-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># We use predict to get an estimate of the</span></span>
<span id="cb835-8"><a href="regression.html#cb835-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># expectation of new observations, and then</span></span>
<span id="cb835-9"><a href="regression.html#cb835-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># add resampled residuals to also include the</span></span>
<span id="cb835-10"><a href="regression.html#cb835-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># natural variation around the expectation:</span></span>
<span id="cb835-11"><a href="regression.html#cb835-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(m_boot, <span class="at">newdata =</span> new_data) <span class="sc">+</span> </span>
<span id="cb835-12"><a href="regression.html#cb835-12" aria-hidden="true" tabindex="-1"></a>         <span class="fu">sample</span>(residuals, <span class="fu">nrow</span>(new_data))</span>
<span id="cb835-13"><a href="regression.html#cb835-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb835-14"><a href="regression.html#cb835-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-15"><a href="regression.html#cb835-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb835-16"><a href="regression.html#cb835-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-17"><a href="regression.html#cb835-17" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> mtcars)</span>
<span id="cb835-18"><a href="regression.html#cb835-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-19"><a href="regression.html#cb835-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute scaled and centred residuals:</span></span>
<span id="cb835-20"><a href="regression.html#cb835-20" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="fu">lm.influence</span>(m)<span class="sc">$</span>hat)</span>
<span id="cb835-21"><a href="regression.html#cb835-21" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> res <span class="sc">-</span> <span class="fu">mean</span>(res)</span>
<span id="cb835-22"><a href="regression.html#cb835-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-23"><a href="regression.html#cb835-23" aria-hidden="true" tabindex="-1"></a>boot_res <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> m<span class="sc">$</span>model,</span>
<span id="cb835-24"><a href="regression.html#cb835-24" aria-hidden="true" tabindex="-1"></a>                     <span class="at">statistic =</span> boot_pred,</span>
<span id="cb835-25"><a href="regression.html#cb835-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">R =</span> <span class="dv">999</span>,</span>
<span id="cb835-26"><a href="regression.html#cb835-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> m,</span>
<span id="cb835-27"><a href="regression.html#cb835-27" aria-hidden="true" tabindex="-1"></a>                     <span class="at">new_data =</span> new_cars,</span>
<span id="cb835-28"><a href="regression.html#cb835-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">formula =</span> <span class="fu">formula</span>(m),</span>
<span id="cb835-29"><a href="regression.html#cb835-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">predictions =</span> <span class="fu">predict</span>(m),</span>
<span id="cb835-30"><a href="regression.html#cb835-30" aria-hidden="true" tabindex="-1"></a>                     <span class="at">residuals =</span> res)</span>
<span id="cb835-31"><a href="regression.html#cb835-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb835-32"><a href="regression.html#cb835-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 90 % bootstrap prediction intervals:</span></span>
<span id="cb835-33"><a href="regression.html#cb835-33" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">1</span>, <span class="at">conf =</span> <span class="fl">0.9</span>) <span class="co"># Volvo</span></span>
<span id="cb835-34"><a href="regression.html#cb835-34" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">2</span>, <span class="at">conf =</span> <span class="fl">0.9</span>) <span class="co"># Ferrari</span></span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7exc21" class="exercise"><strong>Exercise 8.10  </strong></span>Use your model from Exercise <a href="regression.html#exr:ch7exc16">8.3</a> to compute a bootstrap prediction interval for the temperature on a day with precipitation but no sun hours.</p>
</div>
<p><a href="solutions.html#ch7solutions21">(Click here to go to the solution.)</a></p>
</div>
<div id="multipredict" class="section level3 hasAnchor" number="8.1.11">
<h3><span class="header-section-number">8.1.11</span> Prediction for multiple datasets<a href="regression.html#multipredict" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In certain cases, we wish to fit different models to different subsets of the data. Functionals like <code>apply</code> and <code>map</code> (Section <a href="progchapter.html#vectorloops">6.5</a>) are handy when you want to fit several models at once. Below is an example of how we can use <code>split</code> (Section <a href="messychapter.html#splitvector">5.2.1</a>) and tools from the <code>purrr</code> package (Section <a href="progchapter.html#purrr">6.5.3</a>) to fit the models simultaneously, as well as for computing the fitted values in a single line of code:</p>
<div class="sourceCode" id="cb836"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb836-1"><a href="regression.html#cb836-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the dataset into three groups depending on the</span></span>
<span id="cb836-2"><a href="regression.html#cb836-2" aria-hidden="true" tabindex="-1"></a><span class="co"># number of cylinders:</span></span>
<span id="cb836-3"><a href="regression.html#cb836-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb836-4"><a href="regression.html#cb836-4" aria-hidden="true" tabindex="-1"></a>mtcars_by_cyl <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span> <span class="fu">split</span>(.<span class="sc">$</span>cyl)</span>
<span id="cb836-5"><a href="regression.html#cb836-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb836-6"><a href="regression.html#cb836-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a linear model to each subgroup:</span></span>
<span id="cb836-7"><a href="regression.html#cb836-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb836-8"><a href="regression.html#cb836-8" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> mtcars_by_cyl <span class="sc">%&gt;%</span> <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> hp <span class="sc">+</span> wt, <span class="at">data =</span> .))</span>
<span id="cb836-9"><a href="regression.html#cb836-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb836-10"><a href="regression.html#cb836-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the fitted values for each model:</span></span>
<span id="cb836-11"><a href="regression.html#cb836-11" aria-hidden="true" tabindex="-1"></a><span class="fu">map2</span>(models, mtcars_by_cyl, predict)</span></code></pre></div>
<p>We’ll make use of this approach when we study linear mixed models in Section <a href="regression.html#mixedmodels">8.4</a>.</p>
</div>
<div id="ANOVA" class="section level3 hasAnchor" number="8.1.12">
<h3><span class="header-section-number">8.1.12</span> ANOVA<a href="regression.html#ANOVA" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Linear models are also used for analysis of variance (<em>ANOVA</em>) models to test whether there are differences among the means of different groups. We’ll use the <code>mtcars</code> data to give some examples of this. Let’s say that we want to investigate whether the mean fuel consumption (<code>mpg</code>) of cars differs depending on the number of cylinders (<code>cyl</code>), and that we want to include the type of transmission (<code>am</code>) as a blocking variable.</p>
<p>To get an ANOVA table for this problem, we must first convert the explanatory variables to <code>factor</code> variables, as the variables in <code>mtcars</code> all <code>numeric</code> (despite some of them being categorical). We can then use <code>aov</code> to fit the model, and then <code>summary</code>:</p>
<div class="sourceCode" id="cb837"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb837-1"><a href="regression.html#cb837-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert variables to factors:</span></span>
<span id="cb837-2"><a href="regression.html#cb837-2" aria-hidden="true" tabindex="-1"></a>mtcars<span class="sc">$</span>cyl <span class="ot">&lt;-</span> <span class="fu">factor</span>(mtcars<span class="sc">$</span>cyl)</span>
<span id="cb837-3"><a href="regression.html#cb837-3" aria-hidden="true" tabindex="-1"></a>mtcars<span class="sc">$</span>am <span class="ot">&lt;-</span> <span class="fu">factor</span>(mtcars<span class="sc">$</span>am)</span>
<span id="cb837-4"><a href="regression.html#cb837-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb837-5"><a href="regression.html#cb837-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model and print ANOVA table:</span></span>
<span id="cb837-6"><a href="regression.html#cb837-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">aov</span>(mpg <span class="sc">~</span> cyl <span class="sc">+</span> am, <span class="at">data =</span> mtcars)</span>
<span id="cb837-7"><a href="regression.html#cb837-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>(<code>aov</code> actually uses <code>lm</code> to fit the model, but by using <code>aov</code> we specify that we want an ANOVA table to be printed by <code>summary</code>.)</p>
<p>When there are different numbers of observations in the groups in an ANOVA, so that we have an unbalanced design, the sums of squares used to compute the test statistics can be computed in at least three different ways, commonly called type I, II and III. See Herr (1986) for an overview and discussion of this.</p>
<p><code>summary</code> prints a type I ANOVA table, which isn’t the best choice for unbalanced designs. We can however get type II or III tables by instead using <code>Anova</code> from the <code>car</code> package to print the table:</p>
<div class="sourceCode" id="cb838"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb838-1"><a href="regression.html#cb838-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb838-2"><a href="regression.html#cb838-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(m, <span class="at">type =</span> <span class="st">&quot;II&quot;</span>)</span>
<span id="cb838-3"><a href="regression.html#cb838-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(m, <span class="at">type =</span> <span class="st">&quot;III&quot;</span>) <span class="co"># Default in SAS and SPSS.</span></span></code></pre></div>
<p>As a guideline, for unbalanced designs, you should use type II tables if there are no interactions, and type III tables if there are interactions. To look for interactions, we can use <code>interaction.plot</code> to create a two-way interaction plot:</p>
<div class="sourceCode" id="cb839"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb839-1"><a href="regression.html#cb839-1" aria-hidden="true" tabindex="-1"></a><span class="fu">interaction.plot</span>(mtcars<span class="sc">$</span>am, mtcars<span class="sc">$</span>cyl, <span class="at">response =</span> mtcars<span class="sc">$</span>mpg)</span></code></pre></div>
<p>In this case, there is no sign of an interaction between the two variables, as the lines are more or less parallel. A type II table is therefore probably the best choice here.</p>
<p>We can obtain diagnostic plots the same way we did for other linear models:</p>
<div class="sourceCode" id="cb840"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb840-1"><a href="regression.html#cb840-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify)</span>
<span id="cb840-2"><a href="regression.html#cb840-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(m, <span class="at">which =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">label.size =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>To find which groups that have significantly different means, we can use a post hoc test like Tukey’s HSD, available through the <code>TukeyHSD</code> function:</p>
<div class="sourceCode" id="cb841"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb841-1"><a href="regression.html#cb841-1" aria-hidden="true" tabindex="-1"></a><span class="fu">TukeyHSD</span>(m)</span></code></pre></div>
<p>We can visualise the results of Tukey’s HSD with <code>plot</code>, which shows 95 % confidence intervals for the mean differences:</p>
<div class="sourceCode" id="cb842"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb842-1"><a href="regression.html#cb842-1" aria-hidden="true" tabindex="-1"></a><span class="co"># When the difference isn&#39;t significant, the dashed line indicating</span></span>
<span id="cb842-2"><a href="regression.html#cb842-2" aria-hidden="true" tabindex="-1"></a><span class="co"># &quot;no differences&quot; falls within the confidence interval for</span></span>
<span id="cb842-3"><a href="regression.html#cb842-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the difference:</span></span>
<span id="cb842-4"><a href="regression.html#cb842-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">TukeyHSD</span>(m, <span class="st">&quot;am&quot;</span>))</span>
<span id="cb842-5"><a href="regression.html#cb842-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb842-6"><a href="regression.html#cb842-6" aria-hidden="true" tabindex="-1"></a><span class="co"># When the difference is significant, the dashed line does not</span></span>
<span id="cb842-7"><a href="regression.html#cb842-7" aria-hidden="true" tabindex="-1"></a><span class="co"># fall within the confidence interval:</span></span>
<span id="cb842-8"><a href="regression.html#cb842-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">TukeyHSD</span>(m, <span class="st">&quot;cyl&quot;</span>))</span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7exc21a" class="exercise"><strong>Exercise 8.11  </strong></span>Return to the residual plots that you created with <code>autoplot</code>. Figure out how you can plot points belonging to different <code>cyl</code> groups in different colours.</p>
</div>
<p><a href="solutions.html#ch7solutions21a">(Click here to go to the solution.)</a></p>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch7exc21b" class="exercise"><strong>Exercise 8.12  </strong></span>The <code>aovp</code> function in the <code>lmPerm</code> package can be utilised to perform permutation tests instead of the classical parametric ANOVA tests. Rerun the analysis in the example above, using <code>aovp</code> instead. Do the conclusions change? What happens if you run your code multiple times? Does using <code>summary</code> on a model fitted using <code>aovp</code> generate a type I, II or III table by default? Can you change what type of table it produces?</p>
</div>
<p><a href="solutions.html#ch7solutions21b">(Click here to go to the solution.)</a></p>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch7exc21c" class="exercise"><strong>Exercise 8.13  </strong></span>In the case of a one-way ANOVA (i.e. ANOVA with a single explanatory variable), the Kruskal-Wallis test can be used as a nonparametric option. It is available in <code>kruskal.test</code>. Use the Kruskal-Wallis test to run a one-way ANOVA for the <code>mtcars</code> data, with <code>mpg</code> as the response variable and <code>cyl</code> as an explanatory variable.</p>
</div>
<p><a href="solutions.html#ch7solutions21c">(Click here to go to the solution.)</a></p>
</div>
<div id="bayeslm" class="section level3 hasAnchor" number="8.1.13">
<h3><span class="header-section-number">8.1.13</span> Bayesian estimation of linear models<a href="regression.html#bayeslm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can fit Bayesian linear models using the <code>rstanarm</code> package. To fit a model to the <code>mtcars</code> data using all explanatory variables, we can use <code>stan_glm</code> in place of <code>lm</code> as follows:</p>
<div class="sourceCode" id="cb843"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb843-1"><a href="regression.html#cb843-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb843-2"><a href="regression.html#cb843-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(mpg <span class="sc">~</span> ., <span class="at">data =</span> mtcars)</span>
<span id="cb843-3"><a href="regression.html#cb843-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-4"><a href="regression.html#cb843-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the estimates:</span></span>
<span id="cb843-5"><a href="regression.html#cb843-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(m)</span></code></pre></div>
<p>Next, we can plot the posterior distributions of the effects:</p>
<div class="sourceCode" id="cb844"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb844-1"><a href="regression.html#cb844-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m, <span class="st">&quot;dens&quot;</span>, <span class="at">pars =</span> <span class="fu">names</span>(<span class="fu">coef</span>(m)))</span></code></pre></div>
<p>To get 95 % credible intervals for the effects, we can use <code>posterior_interval</code>:</p>
<div class="sourceCode" id="cb845"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb845-1"><a href="regression.html#cb845-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_interval</span>(m, </span>
<span id="cb845-2"><a href="regression.html#cb845-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">pars =</span> <span class="fu">names</span>(<span class="fu">coef</span>(m)),</span>
<span id="cb845-3"><a href="regression.html#cb845-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fl">0.95</span>)</span></code></pre></div>
<p>We can also plot them using <code>plot</code>:</p>
<div class="sourceCode" id="cb846"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb846-1"><a href="regression.html#cb846-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m, <span class="st">&quot;intervals&quot;</span>,</span>
<span id="cb846-2"><a href="regression.html#cb846-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">pars =</span> <span class="fu">names</span>(<span class="fu">coef</span>(m)),</span>
<span id="cb846-3"><a href="regression.html#cb846-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fl">0.95</span>)</span></code></pre></div>
<p>Finally, we can use <span class="math inline">\(\hat{R}\)</span> to check model convergence. It should be less than 1.1 if the fitting has converged:</p>
<div class="sourceCode" id="cb847"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb847-1"><a href="regression.html#cb847-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m, <span class="st">&quot;rhat&quot;</span>)</span></code></pre></div>
<p>Like for <code>lm</code>, <code>residuals(m)</code> provides the model residuals, which can be used for diagnostics. For instance, we can plot the residuals against the fitted values to look for signs of non-linearity, adding a curve to aid the eye:</p>
<div class="sourceCode" id="cb848"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb848-1"><a href="regression.html#cb848-1" aria-hidden="true" tabindex="-1"></a>model_diag <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fitted =</span> <span class="fu">predict</span>(m),</span>
<span id="cb848-2"><a href="regression.html#cb848-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Residual =</span> <span class="fu">residuals</span>(m))</span>
<span id="cb848-3"><a href="regression.html#cb848-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb848-4"><a href="regression.html#cb848-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb848-5"><a href="regression.html#cb848-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model_diag, <span class="fu">aes</span>(Fitted, Residual)) <span class="sc">+</span></span>
<span id="cb848-6"><a href="regression.html#cb848-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb848-7"><a href="regression.html#cb848-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>For fitting ANOVA models, we can instead use <code>stan_aov</code> with the argument <code>prior = R2(location = 0.5)</code> to fit the model.</p>
</div>
</div>
<div id="ethical-issues-in-regression-modelling" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Ethical issues in regression modelling<a href="regression.html#ethical-issues-in-regression-modelling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The p-hacking problem, discussed in Section <a href="modchapter.html#ethicsinference">7.4</a>, is perhaps particularly prevalent in regression modelling. Regression analysis often involves a large number of explanatory variables, and practitioners often try out several different models (e.g. by performing stepwise variable selection; see Section <a href="regression.html#stepwise">8.1.9</a>). Because so many hypotheses are tested, often in many different but similar models, there is a large risk of false discoveries.</p>
<p>In any regression analysis, there is a risk of finding <em>spurious relationships</em>. These are dependencies between the response variable and an explanatory variable that either are non-causal or are purely coincidental. As an example of the former, consider the number of deaths by drowning, which is strongly correlated with ice cream sales. Not because ice cream cause people to drown, but because both are affected by the weather: we are more likely to go swimming or buy ice cream on hot days. Lurking variables, like the temperature in the ice cream-drowning example, are commonly referred to as <em>confounding factors</em>. An effect may be statistically significant, but that does not necessarily mean that it is meaningful.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch8ethics1" class="exercise"><strong>Exercise 8.14  </strong></span><em>Discuss the following.</em> You are tasked with analysing a study on whether Vitamin D protects against the flu. One group of patients are given Vitamin D supplements, and one group is given a placebo. You plan on fitting a regression model to estimate the effect of the vitamin supplements, but note that some confounding factors that you have reason to believe are of importance, such as age and ethnicity, are missing from the data. You can therefore not include them as explanatory variables in the model. Should you still fit the model?</p>
</div>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch8ethics2" class="exercise"><strong>Exercise 8.15  </strong></span><em>Discuss the following.</em> You are fitting a linear regression model to a dataset from a medical study on a new drug which potentially can have serious side effects. The test subjects take a risk by participating in the study. Each observation in the dataset corresponds to a test subject. Like all ordinary linear regression models, your model gives more weight to observations that deviate from the average (and have a high leverage or Cook’s distance). Given the risks involved for the test subjects, is it fair to give different weight to data from different individuals? Is it OK to remove outliers because they influence the results too much, meaning that the risk that the subject took was for nought?</p>
</div>
</div>
<div id="generalised-linear-models" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Generalised linear models<a href="regression.html#generalised-linear-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Generalised linear models, abbreviated GLM, are (yes) a generalisation of the linear model, that can be used when your response variable has a non-normal error distribution. Typical examples are when your response variable is binary (only takes two values, e.g. 0 or 1), or a count of something. Fitting GLM’s is more or less entirely analogous to fitting linear models in R, but model diagnostics are very different. In this section we will look at some examples of how it can be done.</p>
<div id="logreg" class="section level3 hasAnchor" number="8.3.1">
<h3><span class="header-section-number">8.3.1</span> Modelling proportions: Logistic regression<a href="regression.html#logreg" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As the first example of binary data, we will consider the wine quality dataset <code>wine</code> from Cortez et al. (2009), which is available in the UCI Machine Learning Repository at <a href="http://archive.ics.uci.edu/ml/datasets/Wine+Quality" class="uri">http://archive.ics.uci.edu/ml/datasets/Wine+Quality</a>. It contains measurements on white and red vinho verde wine samples from northern Portugal.</p>
<!-- 
white <- read.csv("http://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-white.csv",
                  sep = ";")
red <- read.csv("http://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv",
                  sep = ";")
-->
<p>We start by loading the data. It is divided into two separate <code>.csv</code> files, one for white wines and one for red, which we have to merge:</p>
<div class="sourceCode" id="cb849"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb849-1"><a href="regression.html#cb849-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import data about white and red wines:</span></span>
<span id="cb849-2"><a href="regression.html#cb849-2" aria-hidden="true" tabindex="-1"></a>white <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://tinyurl.com/winedata1&quot;</span>,</span>
<span id="cb849-3"><a href="regression.html#cb849-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sep =</span> <span class="st">&quot;;&quot;</span>)</span>
<span id="cb849-4"><a href="regression.html#cb849-4" aria-hidden="true" tabindex="-1"></a>red <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://tinyurl.com/winedata2&quot;</span>,</span>
<span id="cb849-5"><a href="regression.html#cb849-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sep =</span> <span class="st">&quot;;&quot;</span>)</span>
<span id="cb849-6"><a href="regression.html#cb849-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb849-7"><a href="regression.html#cb849-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a type variable:</span></span>
<span id="cb849-8"><a href="regression.html#cb849-8" aria-hidden="true" tabindex="-1"></a>white<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb849-9"><a href="regression.html#cb849-9" aria-hidden="true" tabindex="-1"></a>red<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb849-10"><a href="regression.html#cb849-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb849-11"><a href="regression.html#cb849-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the datasets:</span></span>
<span id="cb849-12"><a href="regression.html#cb849-12" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">&lt;-</span> <span class="fu">rbind</span>(white, red)</span>
<span id="cb849-13"><a href="regression.html#cb849-13" aria-hidden="true" tabindex="-1"></a>wine<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="fu">factor</span>(wine<span class="sc">$</span>type)</span>
<span id="cb849-14"><a href="regression.html#cb849-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb849-15"><a href="regression.html#cb849-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the result:</span></span>
<span id="cb849-16"><a href="regression.html#cb849-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wine)</span></code></pre></div>
<p>We are interested in seeing if measurements like pH (<code>pH</code>) and alcohol content (<code>alcohol</code>) can be used to determine the colours of the wine. The colour is represented by the <code>type</code> variable, which is binary.</p>
<p>Our model is that the <code>type</code> of a randomly selected wine is binomial <span class="math inline">\(Bin(1, \pi_i)\)</span>-distributed (Bernoulli distributed), where <span class="math inline">\(\pi_i\)</span> depends on explanatory variables like pH and alcohol content. A common model for this situation is a <em>logistic regression model</em>. Given <span class="math inline">\(n\)</span> observations of <span class="math inline">\(p\)</span> explanatory variables, the model is:</p>
<p><span class="math display">\[\log\Big(\frac{\pi_i}{1-\pi_i}\Big)=\beta_0+\beta_1 x_{i1}+\beta_2 x_{i2}+\cdots+\beta_p x_{ip},\qquad i=1,\ldots,n\]</span>
Where we in linear regression models model the expected value of the response variable as a linear function of the explanatory variables, we now model the expected value of a <em>function of the expected value of the response variable</em> (that is, a function of <span class="math inline">\(\pi_i\)</span>). In GLM terminology, this function is known as a <em>link function</em>.</p>
<p>Logistic regression models can be fitted using the <code>glm</code> function. To specify what our model is, we use the argument <code>family = binomial</code>:</p>
<div class="sourceCode" id="cb850"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb850-1"><a href="regression.html#cb850-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glm</span>(type <span class="sc">~</span> pH <span class="sc">+</span> alcohol, <span class="at">data =</span> wine, <span class="at">family =</span> binomial)</span>
<span id="cb850-2"><a href="regression.html#cb850-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>The p-values presented in the summary table are based on a Wald test known to have poor performance unless the sample size is very large (Agresti, 2013). In this case, with a sample size of 6,497, it is probably safe to use, but for smaller sample sizes, it is preferable to use a bootstrap test instead, which you will do in Exercise <a href="regression.html#exr:ch7excGLM2">8.18</a>.</p>
<p>The coefficients of a logistic regression model aren’t as straightforward to interpret as those in a linear model. If we let <span class="math inline">\(\beta\)</span> denote a coefficient corresponding to an explanatory variable <span class="math inline">\(x\)</span>, then:</p>
<ul>
<li>If <span class="math inline">\(\beta\)</span> is positive, then <span class="math inline">\(\pi_i\)</span> increases when <span class="math inline">\(x_i\)</span> increases.</li>
<li>If <span class="math inline">\(\beta\)</span> is negative, then <span class="math inline">\(\pi_i\)</span> decreases when <span class="math inline">\(x_i\)</span> increases.</li>
<li><span class="math inline">\(e^\beta\)</span> is the <em>odds ratio</em>, which shows how much the odds <span class="math inline">\(\frac{\pi_i}{1-\pi_1}\)</span> change when <span class="math inline">\(x_i\)</span> is increased 1 step.</li>
</ul>
<p>We can extract the coefficients and odds ratios using <code>coef</code>:</p>
<div class="sourceCode" id="cb851"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb851-1"><a href="regression.html#cb851-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(m)      <span class="co"># Coefficients, beta</span></span>
<span id="cb851-2"><a href="regression.html#cb851-2" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(m)) <span class="co"># Odds ratios</span></span></code></pre></div>
<p>To find the fitted probability that an observation belongs to the second class we can use <code>predict(m, type = "response")</code>:</p>
<div class="sourceCode" id="cb852"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb852-1"><a href="regression.html#cb852-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check which class is the second one:</span></span>
<span id="cb852-2"><a href="regression.html#cb852-2" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(wine<span class="sc">$</span>type) </span>
<span id="cb852-3"><a href="regression.html#cb852-3" aria-hidden="true" tabindex="-1"></a><span class="co"># &quot;white&quot; is the second class!</span></span>
<span id="cb852-4"><a href="regression.html#cb852-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-5"><a href="regression.html#cb852-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get fitted probabilities:</span></span>
<span id="cb852-6"><a href="regression.html#cb852-6" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb852-7"><a href="regression.html#cb852-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-8"><a href="regression.html#cb852-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check what the average prediction is for</span></span>
<span id="cb852-9"><a href="regression.html#cb852-9" aria-hidden="true" tabindex="-1"></a><span class="co"># the two groups:</span></span>
<span id="cb852-10"><a href="regression.html#cb852-10" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(probs[wine<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;red&quot;</span>])</span>
<span id="cb852-11"><a href="regression.html#cb852-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(probs[wine<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;white&quot;</span>])</span></code></pre></div>
<p>It turns out that the model predicts that most wines are white - even the red ones! The reason may be that we have more white wines (4,898) than red wines (1,599) in the dataset. Adding more explanatory variables could perhaps solve this problem. We’ll give that a try in the next section.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excGLM1" class="exercise"><strong>Exercise 8.16  </strong></span><a href="http://www.modernstatisticswithr.com/data.zip">Download <code>sharks.csv</code> file from the book’s web page</a>. It contains information about shark attacks in South Africa. Using data on attacks that occurred in 2000 or later, fit a logistic regression model to investigate whether the age and sex of the individual that was attacked affect the probability of the attack being fatal.</p>
<p>Note: save the code for your model, as you will return to it in the subsequent exercises.</p>
</div>
<p><a href="solutions.html#ch7solutionsGLM1">(Click here to go to the solution.)</a></p>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch7excGLM1b" class="exercise"><strong>Exercise 8.17  </strong></span>In Section <a href="regression.html#broom">8.1.8</a> we saw how some functions from the <code>broom</code> package could be used to get summaries of linear models. Try using them with the <code>wine</code> data model that we created above. Do the <code>broom</code> functions work for generalised linear models as well?</p>
</div>
<p><a href="solutions.html#ch7solutionsGLM1b">(Click here to go to the solution.)</a></p>
</div>
<div id="bootstrap-confidence-intervals-1" class="section level3 hasAnchor" number="8.3.2">
<h3><span class="header-section-number">8.3.2</span> Bootstrap confidence intervals<a href="regression.html#bootstrap-confidence-intervals-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In a logistic regression, the response variable <span class="math inline">\(y_i\)</span> is a binomial (or Bernoulli) random variable with success probability <span class="math inline">\(\pi_i\)</span>. In this case, we don’t want to resample residuals to create confidence intervals, as it turns out that this can lead to predicted probabilities outside the range <span class="math inline">\((0,1)\)</span>. Instead, we can either use the case resampling strategy described in Exercise <a href="regression.html#exr:ch7exc20b">8.9</a> or use a parametric bootstrap approach where we generate new binomial variables (Section <a href="modchapter.html#distfunctions">7.1.2</a>) to construct bootstrap confidence intervals.</p>
<p>To use case resampling, we can use <code>boot_summary</code> from <code>boot.pval</code>:</p>
<div class="sourceCode" id="cb853"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb853-1"><a href="regression.html#cb853-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot.pval)</span>
<span id="cb853-2"><a href="regression.html#cb853-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb853-3"><a href="regression.html#cb853-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glm</span>(type <span class="sc">~</span> pH <span class="sc">+</span> alcohol, <span class="at">data =</span> wine, <span class="at">family =</span> binomial)</span>
<span id="cb853-4"><a href="regression.html#cb853-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb853-5"><a href="regression.html#cb853-5" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_summary</span>(m, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">method =</span> <span class="st">&quot;case&quot;</span>)</span></code></pre></div>
<p>In the parametric approach, for each observation, the fitted success probability from the logistic model will be used to sample new observations of the response variable. This method can work well if the model is well-specified but tends to perform poorly for misspecified models, so make sure to carefully perform model diagnostics (as described in the next section) before applying it. To use the parametric approach, we can do as follows:</p>
<div class="sourceCode" id="cb854"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb854-1"><a href="regression.html#cb854-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb854-2"><a href="regression.html#cb854-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb854-3"><a href="regression.html#cb854-3" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, predictions, ...) {</span>
<span id="cb854-4"><a href="regression.html#cb854-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check whether the response variable is a factor or</span></span>
<span id="cb854-5"><a href="regression.html#cb854-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># numeric, and then resample:</span></span>
<span id="cb854-6"><a href="regression.html#cb854-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.factor</span>(data[,<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]])) {</span>
<span id="cb854-7"><a href="regression.html#cb854-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If the response variable is a factor:</span></span>
<span id="cb854-8"><a href="regression.html#cb854-8" aria-hidden="true" tabindex="-1"></a>      data[,<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]] <span class="ot">&lt;-</span></span>
<span id="cb854-9"><a href="regression.html#cb854-9" aria-hidden="true" tabindex="-1"></a>         <span class="fu">factor</span>(<span class="fu">levels</span>(data[,<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]])[<span class="dv">1</span> <span class="sc">+</span> <span class="fu">rbinom</span>(<span class="fu">nrow</span>(data),</span>
<span id="cb854-10"><a href="regression.html#cb854-10" aria-hidden="true" tabindex="-1"></a>                                              <span class="dv">1</span>, predictions)]) } <span class="cf">else</span> {</span>
<span id="cb854-11"><a href="regression.html#cb854-11" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If the response variable is numeric:</span></span>
<span id="cb854-12"><a href="regression.html#cb854-12" aria-hidden="true" tabindex="-1"></a>      data[,<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]] <span class="ot">&lt;-</span></span>
<span id="cb854-13"><a href="regression.html#cb854-13" aria-hidden="true" tabindex="-1"></a>         <span class="fu">unique</span>(data[,<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]])[<span class="dv">1</span> <span class="sc">+</span> <span class="fu">rbinom</span>(<span class="fu">nrow</span>(data),</span>
<span id="cb854-14"><a href="regression.html#cb854-14" aria-hidden="true" tabindex="-1"></a>                                              <span class="dv">1</span>, predictions)] }</span>
<span id="cb854-15"><a href="regression.html#cb854-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb854-16"><a href="regression.html#cb854-16" aria-hidden="true" tabindex="-1"></a>      m <span class="ot">&lt;-</span> <span class="fu">glm</span>(formula, <span class="at">data =</span> data, <span class="at">family =</span> binomial)</span>
<span id="cb854-17"><a href="regression.html#cb854-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">coef</span>(m))</span>
<span id="cb854-18"><a href="regression.html#cb854-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb854-19"><a href="regression.html#cb854-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb854-20"><a href="regression.html#cb854-20" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glm</span>(type <span class="sc">~</span> pH <span class="sc">+</span> alcohol, <span class="at">data =</span> wine, <span class="at">family =</span> binomial)</span>
<span id="cb854-21"><a href="regression.html#cb854-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb854-22"><a href="regression.html#cb854-22" aria-hidden="true" tabindex="-1"></a>boot_res <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> wine, <span class="at">statistic =</span> coefficients,</span>
<span id="cb854-23"><a href="regression.html#cb854-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">R =</span> <span class="dv">999</span>, </span>
<span id="cb854-24"><a href="regression.html#cb854-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">formula =</span> <span class="fu">formula</span>(m),</span>
<span id="cb854-25"><a href="regression.html#cb854-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">predictions =</span> <span class="fu">predict</span>(m, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb854-26"><a href="regression.html#cb854-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb854-27"><a href="regression.html#cb854-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute confidence intervals:</span></span>
<span id="cb854-28"><a href="regression.html#cb854-28" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">1</span>) <span class="co"># Intercept</span></span>
<span id="cb854-29"><a href="regression.html#cb854-29" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">2</span>) <span class="co"># pH</span></span>
<span id="cb854-30"><a href="regression.html#cb854-30" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">3</span>) <span class="co"># Alcohol</span></span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excGLM2" class="exercise"><strong>Exercise 8.18  </strong></span>Use the model that you fitted to the <code>sharks.csv</code> data in Exercise <a href="regression.html#exr:ch7excGLM1">8.16</a> for the following:</p>
<ol style="list-style-type: decimal">
<li><p>When the <code>MASS</code> package is loaded, you can use <code>confint</code> to obtain (asymptotic) confidence intervals for the parameters of a GLM. Use it to compute confidence intervals for the parameters of your model for the <code>sharks.csv</code> data.</p></li>
<li><p>Compute parametric bootstrap confidence intervals and p-values for the parameters of your logistic regression model for the <code>sharks.csv</code> data. Do they differ from the intervals obtained using <code>confint</code>? Note that there are a lot of missing values for the response variable. Think about how that will affect your bootstrap intervals and adjust your code accordingly.</p></li>
<li><p>Use the confidence interval inversion method of Section <a href="modchapter.html#intervalinversion">7.7.3</a> to compute bootstrap p-values for the effect of age.</p></li>
</ol>
</div>
<p><a href="solutions.html#ch7solutionsGLM2">(Click here to go to the solution.)</a></p>
</div>
<div id="model-diagnostics-1" class="section level3 hasAnchor" number="8.3.3">
<h3><span class="header-section-number">8.3.3</span> Model diagnostics<a href="regression.html#model-diagnostics-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>It is notoriously difficult to assess model fit for GLM’s, because the behaviour of the residuals is very different from residuals in ordinary linear models. In the case of logistic regression, the response variable is always 0 or 1, meaning that there will be two bands of residuals:</p>
<div class="sourceCode" id="cb855"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb855-1"><a href="regression.html#cb855-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Store deviance residuals:</span></span>
<span id="cb855-2"><a href="regression.html#cb855-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glm</span>(type <span class="sc">~</span> pH <span class="sc">+</span> alcohol, <span class="at">data =</span> wine, <span class="at">family =</span> binomial)</span>
<span id="cb855-3"><a href="regression.html#cb855-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(Predicted <span class="ot">&lt;-</span> <span class="fu">predict</span>(m),</span>
<span id="cb855-4"><a href="regression.html#cb855-4" aria-hidden="true" tabindex="-1"></a>                  Residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m, <span class="at">type =</span><span class="st">&quot;deviance&quot;</span>),</span>
<span id="cb855-5"><a href="regression.html#cb855-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Index =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(m<span class="sc">$</span>data),</span>
<span id="cb855-6"><a href="regression.html#cb855-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">CooksDistance =</span> <span class="fu">cooks.distance</span>(m))</span>
<span id="cb855-7"><a href="regression.html#cb855-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb855-8"><a href="regression.html#cb855-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot fitted values against the deviance residuals:</span></span>
<span id="cb855-9"><a href="regression.html#cb855-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb855-10"><a href="regression.html#cb855-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(Predicted, Residuals)) <span class="sc">+</span></span>
<span id="cb855-11"><a href="regression.html#cb855-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>()</span>
<span id="cb855-12"><a href="regression.html#cb855-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb855-13"><a href="regression.html#cb855-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot index against the deviance residuals:</span></span>
<span id="cb855-14"><a href="regression.html#cb855-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(Index, Residuals)) <span class="sc">+</span></span>
<span id="cb855-15"><a href="regression.html#cb855-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>()</span></code></pre></div>
<p>Plots of raw residuals are of little use in logistic regression models. A better option is to use a binned residual plot, in which the observations are grouped into bins based on their fitted value. The average residual in each bin can then be computed, which will tell us if which parts of the model have a poor fit. A function for this is available in the <code>arm</code> package:</p>
<div class="sourceCode" id="cb856"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb856-1"><a href="regression.html#cb856-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;arm&quot;</span>)</span>
<span id="cb856-2"><a href="regression.html#cb856-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb856-3"><a href="regression.html#cb856-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arm)</span>
<span id="cb856-4"><a href="regression.html#cb856-4" aria-hidden="true" tabindex="-1"></a><span class="fu">binnedplot</span>(<span class="fu">predict</span>(m, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>),</span>
<span id="cb856-5"><a href="regression.html#cb856-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">residuals</span>(m, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span></code></pre></div>
<p>The grey lines show confidence bounds which are supposed to contain about 95 % of the bins. If too many points fall outside these bounds, it’s a sign that we have a poor model fit. In this case, there are a few points outside the bounds. Most notably, the average residuals are fairly large for the observations with the lowest fitted values, i.e. among the observations with the lowest predicted probability of being white wines.</p>
<p>Let’s compare the above plot to that for a model with more explanatory variables:</p>
<div class="sourceCode" id="cb857"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb857-1"><a href="regression.html#cb857-1" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(type <span class="sc">~</span> pH <span class="sc">+</span> alcohol <span class="sc">+</span> fixed.acidity <span class="sc">+</span> residual.sugar,</span>
<span id="cb857-2"><a href="regression.html#cb857-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> wine, <span class="at">family =</span> binomial)</span>
<span id="cb857-3"><a href="regression.html#cb857-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb857-4"><a href="regression.html#cb857-4" aria-hidden="true" tabindex="-1"></a><span class="fu">binnedplot</span>(<span class="fu">predict</span>(m2, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>),</span>
<span id="cb857-5"><a href="regression.html#cb857-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">residuals</span>(m2, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span></code></pre></div>
<p>This looks much better - adding more explanatory variable appears to have improved the model fit.</p>
<p>It’s worth repeating that if your main interest is hypothesis testing, you shouldn’t fit multiple models and then pick the one that gives the best results. However, if you’re doing an exploratory analysis or are interested in predictive modelling, you can and should try different models. It can then be useful to do a formal hypothesis test of the null hypothesis that <code>m</code> and <code>m2</code> fit the data equally well, against the alternative that <code>m2</code> has a better fit. If both fit the data equally well, we’d prefer <code>m</code>, since it is a simpler model. We can use <code>anova</code> to perform a likelihood ratio <em>deviance test</em> (see Section <a href="mathschap.html#deviance">12.4</a> for details), which tests this:</p>
<div class="sourceCode" id="cb858"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb858-1"><a href="regression.html#cb858-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(m, m2, <span class="at">test =</span> <span class="st">&quot;LRT&quot;</span>)</span></code></pre></div>
<p>The p-value is very low, and we conclude that <code>m2</code> has a better model fit.</p>
<p>Another useful function is <code>cooks.distance</code>, which can be used to compute the Cook’s distance for each observation, which is useful for finding influential observations. In this case, I’ve chosen to print the row numbers for the observations with a Cook’s distance greater than 0.004 - this number has been arbitrarily chosen in order only to highlight the observations with the highest Cook’s distance.</p>
<div class="sourceCode" id="cb859"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb859-1"><a href="regression.html#cb859-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Index =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">cooks.distance</span>(m)),</span>
<span id="cb859-2"><a href="regression.html#cb859-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">CooksDistance =</span> <span class="fu">cooks.distance</span>(m))</span>
<span id="cb859-3"><a href="regression.html#cb859-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb859-4"><a href="regression.html#cb859-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot index against the Cook&#39;s distance to find</span></span>
<span id="cb859-5"><a href="regression.html#cb859-5" aria-hidden="true" tabindex="-1"></a><span class="co"># influential points:</span></span>
<span id="cb859-6"><a href="regression.html#cb859-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(Index, CooksDistance)) <span class="sc">+</span></span>
<span id="cb859-7"><a href="regression.html#cb859-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb859-8"><a href="regression.html#cb859-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(CooksDistance <span class="sc">&gt;</span> <span class="fl">0.004</span>,</span>
<span id="cb859-9"><a href="regression.html#cb859-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">rownames</span>(res), <span class="st">&quot;&quot;</span>)),</span>
<span id="cb859-10"><a href="regression.html#cb859-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">hjust =</span> <span class="fl">1.1</span>)</span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excGLM3" class="exercise"><strong>Exercise 8.19  </strong></span>Investigate the residuals for your <code>sharks.csv</code> model. Are there any problems with the model fit? Any influential points?</p>
</div>
<p><a href="solutions.html#ch7solutionsGLM3">(Click here to go to the solution.)</a></p>
</div>
<div id="prediction-1" class="section level3 hasAnchor" number="8.3.4">
<h3><span class="header-section-number">8.3.4</span> Prediction<a href="regression.html#prediction-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Just as for linear models, we can use <code>predict</code> to make predictions for new observations using a GLM. To begin with, let’s randomly sample 10 rows from the <code>wine</code> data and fit a model using all data except those ten observations:</p>
<div class="sourceCode" id="cb860"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb860-1"><a href="regression.html#cb860-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomly select 10 rows from the wine data:</span></span>
<span id="cb860-2"><a href="regression.html#cb860-2" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(wine), <span class="dv">10</span>)</span>
<span id="cb860-3"><a href="regression.html#cb860-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb860-4"><a href="regression.html#cb860-4" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glm</span>(type <span class="sc">~</span> pH <span class="sc">+</span> alcohol, <span class="at">data =</span> wine[<span class="sc">-</span>rows,], <span class="at">family =</span> binomial)</span></code></pre></div>
<p>We can now use <code>predict</code> to make predictions for the ten observations:</p>
<div class="sourceCode" id="cb861"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb861-1"><a href="regression.html#cb861-1" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, wine[rows,])</span>
<span id="cb861-2"><a href="regression.html#cb861-2" aria-hidden="true" tabindex="-1"></a>preds</span></code></pre></div>
<p>Those predictions look a bit strange though - what are they? By default, <code>predict</code> returns predictions on the scale of the link function. That’s not really what we want in most cases - instead, we are interested in the predicted probabilities. To get those, we have to add the argument <code>type = "response"</code> to the call:</p>
<div class="sourceCode" id="cb862"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb862-1"><a href="regression.html#cb862-1" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, wine[rows,], <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb862-2"><a href="regression.html#cb862-2" aria-hidden="true" tabindex="-1"></a>preds</span></code></pre></div>
<p>Logistic regression models are often used for prediction, in what is known as classification. Section <a href="mlchapter.html#classifieraccuracy">9.1.7</a> is concerned with how to evaluate the predictive performance of logistic regression and other classification models.</p>
</div>
<div id="modelling-count-data" class="section level3 hasAnchor" number="8.3.5">
<h3><span class="header-section-number">8.3.5</span> Modelling count data<a href="regression.html#modelling-count-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Logistic regression is but one of many types of GLM’s used in practice. One important example is Cox regression, which is used for survival data. We’ll return to that model in Section <a href="regression.html#survival">8.5</a>. For now, we’ll consider count data instead. Let’s have a look at the shark attack data in <code>sharks.csv</code>, available on the book’s website. It contains data about shark attacks in South Africa, downloaded from The Global Shark Attack File (<a href="http://www.sharkattackfile.net/incidentlog.htm" class="uri">http://www.sharkattackfile.net/incidentlog.htm</a>). To load it, we download the file and set <code>file_path</code> to the path of <code>sharks.csv</code>:</p>
<div class="sourceCode" id="cb863"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb863-1"><a href="regression.html#cb863-1" aria-hidden="true" tabindex="-1"></a>sharks <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file_path, <span class="at">sep =</span><span class="st">&quot;;&quot;</span>)</span>
<span id="cb863-2"><a href="regression.html#cb863-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb863-3"><a href="regression.html#cb863-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute number of attacks per year:</span></span>
<span id="cb863-4"><a href="regression.html#cb863-4" aria-hidden="true" tabindex="-1"></a>attacks <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(Type <span class="sc">~</span> Year, <span class="at">data =</span> sharks, <span class="at">FUN =</span> length)</span>
<span id="cb863-5"><a href="regression.html#cb863-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb863-6"><a href="regression.html#cb863-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep data for 1960-2019:</span></span>
<span id="cb863-7"><a href="regression.html#cb863-7" aria-hidden="true" tabindex="-1"></a>attacks <span class="ot">&lt;-</span> <span class="fu">subset</span>(attacks, Year <span class="sc">&gt;=</span> <span class="dv">1960</span>)</span></code></pre></div>
<p>The number of attacks in a year is not binary but a count that, in principle, can take any non-negative integer as its value. Are there any trends over time for the number of reported attacks?</p>
<div class="sourceCode" id="cb864"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb864-1"><a href="regression.html#cb864-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot data from 1960-2019:</span></span>
<span id="cb864-2"><a href="regression.html#cb864-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb864-3"><a href="regression.html#cb864-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(attacks, <span class="fu">aes</span>(Year, Type)) <span class="sc">+</span></span>
<span id="cb864-4"><a href="regression.html#cb864-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb864-5"><a href="regression.html#cb864-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylab</span>(<span class="st">&quot;Number of attacks&quot;</span>)</span></code></pre></div>
<p>No trend is evident. To confirm this, let’s fit a regression model with <code>Type</code> (the number of attacks) as the response variable and <code>Year</code> as an explanatory variable. For count data like this, a good first model to use is <em>Poisson regression</em>. Let <span class="math inline">\(\mu_i\)</span> denote the expected value of the response variable given the explanatory variables. Given <span class="math inline">\(n\)</span> observations of <span class="math inline">\(p\)</span> explanatory variables, the Poisson regression model is:</p>
<p><span class="math display">\[\log(\mu_i)=\beta_0+\beta_1 x_{i1}+\beta_2 x_{i2}+\cdots+\beta_p x_{ip},\qquad i=1,\ldots,n\]</span>
To fit it, we use <code>glm</code> as before, but this time with <code>family = poisson</code>:</p>
<div class="sourceCode" id="cb865"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb865-1"><a href="regression.html#cb865-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glm</span>(Type <span class="sc">~</span> Year, <span class="at">data =</span> attacks, <span class="at">family =</span> poisson)</span>
<span id="cb865-2"><a href="regression.html#cb865-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>We can add the curve corresponding to the fitted model to our scatterplot as follows:</p>
<div class="sourceCode" id="cb866"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb866-1"><a href="regression.html#cb866-1" aria-hidden="true" tabindex="-1"></a>attacks_pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Year =</span> attacks<span class="sc">$</span>Year, <span class="at">at_pred =</span></span>
<span id="cb866-2"><a href="regression.html#cb866-2" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">predict</span>(m, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb866-3"><a href="regression.html#cb866-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb866-4"><a href="regression.html#cb866-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(attacks, <span class="fu">aes</span>(Year, Type)) <span class="sc">+</span></span>
<span id="cb866-5"><a href="regression.html#cb866-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb866-6"><a href="regression.html#cb866-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylab</span>(<span class="st">&quot;Number of attacks&quot;</span>) <span class="sc">+</span></span>
<span id="cb866-7"><a href="regression.html#cb866-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> attacks_pred, <span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> at_pred),</span>
<span id="cb866-8"><a href="regression.html#cb866-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p>The fitted model seems to confirm our view that there is no trend over time in the number of attacks.</p>
<p>For model diagnostics, we can use a binned residual plot and a plot of Cook’s distance to find influential points:</p>
<div class="sourceCode" id="cb867"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb867-1"><a href="regression.html#cb867-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Binned residual plot:</span></span>
<span id="cb867-2"><a href="regression.html#cb867-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arm)</span>
<span id="cb867-3"><a href="regression.html#cb867-3" aria-hidden="true" tabindex="-1"></a><span class="fu">binnedplot</span>(<span class="fu">predict</span>(m, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>),</span>
<span id="cb867-4"><a href="regression.html#cb867-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">residuals</span>(m, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb867-5"><a href="regression.html#cb867-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb867-6"><a href="regression.html#cb867-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb867-7"><a href="regression.html#cb867-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot index against the Cook&#39;s distance to find</span></span>
<span id="cb867-8"><a href="regression.html#cb867-8" aria-hidden="true" tabindex="-1"></a><span class="co"># influential points:</span></span>
<span id="cb867-9"><a href="regression.html#cb867-9" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Index =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(m<span class="sc">$</span>data),</span>
<span id="cb867-10"><a href="regression.html#cb867-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">CooksDistance =</span> <span class="fu">cooks.distance</span>(m))</span>
<span id="cb867-11"><a href="regression.html#cb867-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res, <span class="fu">aes</span>(Index, CooksDistance)) <span class="sc">+</span></span>
<span id="cb867-12"><a href="regression.html#cb867-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb867-13"><a href="regression.html#cb867-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">ifelse</span>(CooksDistance <span class="sc">&gt;</span> <span class="fl">0.1</span>,</span>
<span id="cb867-14"><a href="regression.html#cb867-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">rownames</span>(res), <span class="st">&quot;&quot;</span>)),</span>
<span id="cb867-15"><a href="regression.html#cb867-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">hjust =</span> <span class="fl">1.1</span>)</span></code></pre></div>
<p>A common problem in Poisson regression models is excess zeros, i.e. more observations with value 0 than what is predicted by the model. To check the distribution of counts in the data, we can draw a histogram:</p>
<div class="sourceCode" id="cb868"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb868-1"><a href="regression.html#cb868-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(attacks, <span class="fu">aes</span>(Type)) <span class="sc">+</span></span>
<span id="cb868-2"><a href="regression.html#cb868-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
<p>If there are a lot of zeroes in the data, we should consider using another model, such as a hurdle model or a zero-inflated Poisson regression. Both of these are available in the <code>pscl</code> package.</p>
<p>Another common problem is <em>overdispersion</em>, which occurs when there is more variability in the data than what is predicted by the GLM. A formal test of overdispersion (Cameron &amp; Trivedi, 1990) is provided by <code>dispersiontest</code> in the <code>AER</code> package. The null hypothesis is that there is no overdispersion, and the alternative that there is overdispersion:</p>
<div class="sourceCode" id="cb869"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb869-1"><a href="regression.html#cb869-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;AER&quot;</span>)</span>
<span id="cb869-2"><a href="regression.html#cb869-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb869-3"><a href="regression.html#cb869-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(AER)</span>
<span id="cb869-4"><a href="regression.html#cb869-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dispersiontest</span>(m, <span class="at">trafo =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>There are several alternative models that can be considered in the case of overdispersion. One of them is <em>negative binomial regression</em>, which uses the same link function as Poisson regression. We can fit it using the <code>glm.nb</code> function from <code>MASS</code>:</p>
<div class="sourceCode" id="cb870"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb870-1"><a href="regression.html#cb870-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb870-2"><a href="regression.html#cb870-2" aria-hidden="true" tabindex="-1"></a>m_nb <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Type <span class="sc">~</span> Year, <span class="at">data =</span> attacks)</span>
<span id="cb870-3"><a href="regression.html#cb870-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb870-4"><a href="regression.html#cb870-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_nb)</span></code></pre></div>
<p>For the shark attack data, the predictions from the two models are virtually identical, meaning that both are equally applicable in this case:</p>
<div class="sourceCode" id="cb871"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb871-1"><a href="regression.html#cb871-1" aria-hidden="true" tabindex="-1"></a>attacks_pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Year =</span> attacks<span class="sc">$</span>Year, <span class="at">at_pred =</span></span>
<span id="cb871-2"><a href="regression.html#cb871-2" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">predict</span>(m, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb871-3"><a href="regression.html#cb871-3" aria-hidden="true" tabindex="-1"></a>attacks_pred_nb <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Year =</span> attacks<span class="sc">$</span>Year, <span class="at">at_pred =</span></span>
<span id="cb871-4"><a href="regression.html#cb871-4" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">predict</span>(m_nb, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb871-5"><a href="regression.html#cb871-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb871-6"><a href="regression.html#cb871-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(attacks, <span class="fu">aes</span>(Year, Type)) <span class="sc">+</span></span>
<span id="cb871-7"><a href="regression.html#cb871-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb871-8"><a href="regression.html#cb871-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylab</span>(<span class="st">&quot;Number of attacks&quot;</span>) <span class="sc">+</span></span>
<span id="cb871-9"><a href="regression.html#cb871-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> attacks_pred, <span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> at_pred),</span>
<span id="cb871-10"><a href="regression.html#cb871-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb871-11"><a href="regression.html#cb871-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">data =</span> attacks_pred_nb, <span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> at_pred),</span>
<span id="cb871-12"><a href="regression.html#cb871-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>)</span></code></pre></div>
<p>Finally, we can obtain bootstrap confidence intervals e.g. using case resampling, using <code>boot_summary</code>:</p>
<div class="sourceCode" id="cb872"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb872-1"><a href="regression.html#cb872-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot.pval)</span>
<span id="cb872-2"><a href="regression.html#cb872-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_summary</span>(m_nb, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">method =</span> <span class="st">&quot;case&quot;</span>)</span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excGLM4" class="exercise"><strong>Exercise 8.20  </strong></span>The <code>quakes</code> dataset, available in base R, contains information about seismic events off Fiji. Fit a Poisson regression model with <code>stations</code> as the response variable and <code>mag</code> as an explanatory variable. Are there signs of overdispersion? Does using a negative binomial model improve the model fit?</p>
</div>
<p><a href="solutions.html#ch7solutionsGLM4">(Click here to go to the solution.)</a></p>
</div>
<div id="modelling-rates" class="section level3 hasAnchor" number="8.3.6">
<h3><span class="header-section-number">8.3.6</span> Modelling rates<a href="regression.html#modelling-rates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Poisson regression models, and related models like negative binomial regression, can not only be used to model count data. They can also be used to model <em>rate data</em>, such as the number of cases per capita or the number of cases per unit area. In that case, we need to include an <em>exposure</em> variable <span class="math inline">\(N\)</span> that describes e.g. the population size or area corresponding to each observation. The model will be that:</p>
<p><span class="math display">\[\log(\mu_i/N_i)=\beta_0+\beta_1 x_{i1}+\beta_2 x_{i2}+\cdots+\beta_p x_{ip},\qquad i=1,\ldots,n.\]</span>
Because <span class="math inline">\(\log(\mu_i/N_i)=\log(\mu_i)-\log(N_i)\)</span>, this can be rewritten as:</p>
<p><span class="math display">\[\log(\mu_i)=\beta_0+\beta_1 x_{i1}+\beta_2 x_{i2}+\cdots+\beta_p x_{ip}+\log(N_i),\qquad i=1,\ldots,n.\]</span>
In other words, we should include <span class="math inline">\(\log(N_i)\)</span> on the right-hand side of our model, <em>with a known coefficient</em> equal to 1. In regression, such a term is known as an <em>offset</em>. We can add it to our model using the <code>offset</code> function.</p>
<p>As an example, we’ll consider the <code>ships</code> data from the <code>MASS</code> package. It describes the number of damage incidents for different ship types operating in the 1960’s and 1970’s, and includes information about how many months each ship type was in service (i.e. each ship type’s <em>exposure</em>):</p>
<div class="sourceCode" id="cb873"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb873-1"><a href="regression.html#cb873-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb873-2"><a href="regression.html#cb873-2" aria-hidden="true" tabindex="-1"></a>?ships</span>
<span id="cb873-3"><a href="regression.html#cb873-3" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(ships)</span></code></pre></div>
<p>For our example, we’ll use ship <code>type</code> as the explanatory variable, <code>incidents</code> as the response variable and <code>service</code> as the exposure variable. First, we remove observations with 0 exposure (by definition, these can’t be involved in incidents, and so there is no point in including them in the analysis). Then, we fit the model using <code>glm</code> and <code>offset</code>:</p>
<div class="sourceCode" id="cb874"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb874-1"><a href="regression.html#cb874-1" aria-hidden="true" tabindex="-1"></a>ships <span class="ot">&lt;-</span> ships[ships<span class="sc">$</span>service <span class="sc">!=</span> <span class="dv">0</span>,]</span>
<span id="cb874-2"><a href="regression.html#cb874-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb874-3"><a href="regression.html#cb874-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glm</span>(incidents <span class="sc">~</span> type <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(service)),</span>
<span id="cb874-4"><a href="regression.html#cb874-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">data =</span> ships,</span>
<span id="cb874-5"><a href="regression.html#cb874-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">family =</span> poisson)</span>
<span id="cb874-6"><a href="regression.html#cb874-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb874-7"><a href="regression.html#cb874-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>Model diagnostics can be performed as in the previous sections.</p>
<p>Rate models are usually interpreted in terms of the rate ratios <span class="math inline">\(e^{\beta_j}\)</span>, which describe the multiplicative increases of the intensity of rates when <span class="math inline">\(x_j\)</span> is increased by one unit. To compute the rate ratios for our model, we use <code>exp</code>:</p>
<div class="sourceCode" id="cb875"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb875-1"><a href="regression.html#cb875-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(m))</span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excGLM5" class="exercise"><strong>Exercise 8.21  </strong></span>Compute bootstrap confidence intervals for the rate ratios in the model for the <code>ships</code> data.</p>
</div>
<p><a href="solutions.html#ch7solutionsGLM5">(Click here to go to the solution.)</a></p>
</div>
<div id="bayesian-estimation-of-generalised-linear-models" class="section level3 hasAnchor" number="8.3.7">
<h3><span class="header-section-number">8.3.7</span> Bayesian estimation of generalised linear models<a href="regression.html#bayesian-estimation-of-generalised-linear-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can fit a Bayesian GLM with the <code>rstanarm</code> package, using <code>stan_glm</code> in the same way we did for linear models. Let’s look at an example with the <code>wine</code> data. First, we load and prepare the data:</p>
<div class="sourceCode" id="cb876"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb876-1"><a href="regression.html#cb876-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import data about white and red wines:</span></span>
<span id="cb876-2"><a href="regression.html#cb876-2" aria-hidden="true" tabindex="-1"></a>white <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://tinyurl.com/winedata1&quot;</span>,</span>
<span id="cb876-3"><a href="regression.html#cb876-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sep =</span> <span class="st">&quot;;&quot;</span>)</span>
<span id="cb876-4"><a href="regression.html#cb876-4" aria-hidden="true" tabindex="-1"></a>red <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://tinyurl.com/winedata2&quot;</span>,</span>
<span id="cb876-5"><a href="regression.html#cb876-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sep =</span> <span class="st">&quot;;&quot;</span>)</span>
<span id="cb876-6"><a href="regression.html#cb876-6" aria-hidden="true" tabindex="-1"></a>white<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;white&quot;</span></span>
<span id="cb876-7"><a href="regression.html#cb876-7" aria-hidden="true" tabindex="-1"></a>red<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb876-8"><a href="regression.html#cb876-8" aria-hidden="true" tabindex="-1"></a>wine <span class="ot">&lt;-</span> <span class="fu">rbind</span>(white, red)</span>
<span id="cb876-9"><a href="regression.html#cb876-9" aria-hidden="true" tabindex="-1"></a>wine<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="fu">factor</span>(wine<span class="sc">$</span>type)</span></code></pre></div>
<p>Now, we fit a Bayesian logistic regression model:</p>
<div class="sourceCode" id="cb877"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb877-1"><a href="regression.html#cb877-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb877-2"><a href="regression.html#cb877-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(type <span class="sc">~</span> pH <span class="sc">+</span> alcohol, <span class="at">data =</span> wine, <span class="at">family =</span> binomial)</span>
<span id="cb877-3"><a href="regression.html#cb877-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb877-4"><a href="regression.html#cb877-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the estimates:</span></span>
<span id="cb877-5"><a href="regression.html#cb877-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(m)</span></code></pre></div>
<p>Next, we can plot the posterior distributions of the effects:</p>
<div class="sourceCode" id="cb878"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb878-1"><a href="regression.html#cb878-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m, <span class="st">&quot;dens&quot;</span>, <span class="at">pars =</span> <span class="fu">names</span>(<span class="fu">coef</span>(m)))</span></code></pre></div>
<p>To get 95 % credible intervals for the effects, we can use <code>posterior_interval</code>. We can also use <code>plot</code> to visualise them:</p>
<div class="sourceCode" id="cb879"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb879-1"><a href="regression.html#cb879-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_interval</span>(m, </span>
<span id="cb879-2"><a href="regression.html#cb879-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">pars =</span> <span class="fu">names</span>(<span class="fu">coef</span>(m)),</span>
<span id="cb879-3"><a href="regression.html#cb879-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fl">0.95</span>)</span>
<span id="cb879-4"><a href="regression.html#cb879-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb879-5"><a href="regression.html#cb879-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m, <span class="st">&quot;intervals&quot;</span>,</span>
<span id="cb879-6"><a href="regression.html#cb879-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">pars =</span> <span class="fu">names</span>(<span class="fu">coef</span>(m)),</span>
<span id="cb879-7"><a href="regression.html#cb879-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fl">0.95</span>)</span></code></pre></div>
<p>Finally, we can use <span class="math inline">\(\hat{R}\)</span> to check model convergence. It should be less than 1.1 if the fitting has converged:</p>
<div class="sourceCode" id="cb880"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb880-1"><a href="regression.html#cb880-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m, <span class="st">&quot;rhat&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="mixedmodels" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Mixed models<a href="regression.html#mixedmodels" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Mixed models are used in regression problems where measurements have been made on clusters of related units. As the first example of this, we’ll use a dataset from the <code>lme4</code> package, which also happens to contain useful methods for mixed models. Let’s install it:</p>
<div class="sourceCode" id="cb881"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb881-1"><a href="regression.html#cb881-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;lme4&quot;</span>)</span></code></pre></div>
<p>The <code>sleepstudy</code> dataset from <code>lme4</code> contains data from a study on reaction times in a sleep deprivation study. The participants were restricted to 3 hours of sleep per night, and their average reaction time on a series of tests were measured each day during the 9 days that the study lasted:</p>
<div class="sourceCode" id="cb882"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb882-1"><a href="regression.html#cb882-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb882-2"><a href="regression.html#cb882-2" aria-hidden="true" tabindex="-1"></a>?sleepstudy</span>
<span id="cb882-3"><a href="regression.html#cb882-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(sleepstudy)</span></code></pre></div>
<p>Let’s start our analysis by making boxplots showing reaction times for each subject. We’ll also superimpose the observations for each participant on top of their boxplots:</p>
<div class="sourceCode" id="cb883"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb883-1"><a href="regression.html#cb883-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb883-2"><a href="regression.html#cb883-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sleepstudy, <span class="fu">aes</span>(Subject, Reaction)) <span class="sc">+</span></span>
<span id="cb883-3"><a href="regression.html#cb883-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb883-4"><a href="regression.html#cb883-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">colour =</span> Subject), </span>
<span id="cb883-5"><a href="regression.html#cb883-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="fl">0.1</span>))</span></code></pre></div>
<p>We are interested in finding out if the reaction times increase when the participants have been starved for sleep for a longer period. Let’s try plotting reaction times against days, adding a regression line:</p>
<div class="sourceCode" id="cb884"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb884-1"><a href="regression.html#cb884-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sleepstudy, <span class="fu">aes</span>(Days, Reaction, <span class="at">colour =</span> Subject)) <span class="sc">+</span></span>
<span id="cb884-2"><a href="regression.html#cb884-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb884-3"><a href="regression.html#cb884-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>As we saw in the boxplots, and can see in this plot too, some participants always have comparatively high reaction times, whereas others always have low values. There are clear differences between individuals, and the measurements for each individual will be correlated. This violates a fundamental assumption of the traditional linear model, namely that all observations are independent.</p>
<p>In addition to this, it also seems that the reaction times change in different ways for different participants, as can be seen if we facet the plot by test subject:</p>
<div class="sourceCode" id="cb885"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb885-1"><a href="regression.html#cb885-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sleepstudy, <span class="fu">aes</span>(Days, Reaction, <span class="at">colour =</span> Subject)) <span class="sc">+</span></span>
<span id="cb885-2"><a href="regression.html#cb885-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb885-3"><a href="regression.html#cb885-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb885-4"><a href="regression.html#cb885-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="sc">~</span> Subject, <span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb885-5"><a href="regression.html#cb885-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Both the intercept and the slope of the average reaction time differs between individuals. Because of this, the fit given by the single model can be misleading. Moreover, the fact that the observations are correlated will cause problems for the traditional intervals and tests. We need to take this into account when we estimate the overall intercept and slope.</p>
<p>One approach could be to fit a single model for each subject. That doesn’t seem very useful though. We’re not really interested in these particular test subjects, but in how sleep deprivation affects reaction times in an average person. It would be much better to have a single model that somehow incorporates the correlation between measurements made on the same individual. That is precisely what a linear mixed regression model does.</p>
<div id="fitting-a-linear-mixed-model" class="section level3 hasAnchor" number="8.4.1">
<h3><span class="header-section-number">8.4.1</span> Fitting a linear mixed model<a href="regression.html#fitting-a-linear-mixed-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A linear mixed model (LMM) has two types of effects (explanatory variables):</p>
<ul>
<li><em>Fixed effects</em>, which are non-random. These are usually the variables of primary interest in the data. In the <code>sleepstudy</code> example, <code>Days</code> is a fixed effect.</li>
<li><em>Random effects</em>, which represent nuisance variables that cause measurements to be correlated. These are usually not of interest in and of themselves, but are something that we need to include in the model to account for correlations between measurements. In the <code>sleepstudy</code> example, <code>Subject</code> is a random effect.</li>
</ul>
<p>Linear mixed models can be fitted using <code>lmer</code> from the <code>lme4</code> package. The syntax is the same as for <code>lm</code>, with the addition of random effects. These can be included in different ways. Let’s have a look at them.</p>
<p>First, we can include a <em>random intercept</em>, which gives us a model where the intercept (but not the slope) varies between test subjects. In our example, the formula for this is:</p>
<div class="sourceCode" id="cb886"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb886-1"><a href="regression.html#cb886-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb886-2"><a href="regression.html#cb886-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Subject), <span class="at">data =</span> sleepstudy)</span></code></pre></div>
<p>Alternatively, we could include a <em>random slope</em> in the model, in which case the slope (but not the intercept) varies between test subjects. The formula would be:</p>
<div class="sourceCode" id="cb887"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb887-1"><a href="regression.html#cb887-1" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> Days<span class="sc">|</span>Subject), <span class="at">data =</span> sleepstudy)</span></code></pre></div>
<p>Finally, we can include both a random intercept and random slope in the model. This can be done in two different ways, as we can model the intercept and slope as being correlated or uncorrelated:</p>
<div class="sourceCode" id="cb888"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb888-1"><a href="regression.html#cb888-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlated random intercept and slope:</span></span>
<span id="cb888-2"><a href="regression.html#cb888-2" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> Days<span class="sc">|</span>Subject), <span class="at">data =</span> sleepstudy)</span>
<span id="cb888-3"><a href="regression.html#cb888-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb888-4"><a href="regression.html#cb888-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncorrelated random intercept and slope:</span></span>
<span id="cb888-5"><a href="regression.html#cb888-5" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Subject) <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> Days<span class="sc">|</span>Subject),</span>
<span id="cb888-6"><a href="regression.html#cb888-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> sleepstudy)</span></code></pre></div>
<p>Which model should we choose? Are the intercepts and slopes correlated? It could of course be the case that individuals with a high intercept have a smaller slope - or a greater slope! To find out, we can fit different linear models to each subject, and then make a scatterplot of their intercepts and slopes. To fit a model to each subject, we use <code>split</code> and <code>map</code> as in Section <a href="regression.html#multipredict">8.1.11</a>:</p>
<div class="sourceCode" id="cb889"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb889-1"><a href="regression.html#cb889-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect the coefficients from each linear model:</span></span>
<span id="cb889-2"><a href="regression.html#cb889-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb889-3"><a href="regression.html#cb889-3" aria-hidden="true" tabindex="-1"></a>sleepstudy <span class="sc">%&gt;%</span> <span class="fu">split</span>(.<span class="sc">$</span>Subject) <span class="sc">%&gt;%</span> </span>
<span id="cb889-4"><a href="regression.html#cb889-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">lm</span>(Reaction <span class="sc">~</span> Days, <span class="at">data =</span> .)) <span class="sc">%&gt;%</span> </span>
<span id="cb889-5"><a href="regression.html#cb889-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">map</span>(coef) <span class="ot">-&gt;</span> coefficients</span>
<span id="cb889-6"><a href="regression.html#cb889-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-7"><a href="regression.html#cb889-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to a data frame:</span></span>
<span id="cb889-8"><a href="regression.html#cb889-8" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(coefficients),</span>
<span id="cb889-9"><a href="regression.html#cb889-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">nrow =</span> <span class="fu">length</span>(coefficients),</span>
<span id="cb889-10"><a href="regression.html#cb889-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">byrow =</span> <span class="cn">TRUE</span>),</span>
<span id="cb889-11"><a href="regression.html#cb889-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">row.names =</span> <span class="fu">names</span>(coefficients))</span>
<span id="cb889-12"><a href="regression.html#cb889-12" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(coefficients) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Intercept&quot;</span>, <span class="st">&quot;Days&quot;</span>)</span>
<span id="cb889-13"><a href="regression.html#cb889-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-14"><a href="regression.html#cb889-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the coefficients:</span></span>
<span id="cb889-15"><a href="regression.html#cb889-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coefficients, <span class="fu">aes</span>(Intercept, Days,</span>
<span id="cb889-16"><a href="regression.html#cb889-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">colour =</span> <span class="fu">row.names</span>(coefficients))) <span class="sc">+</span></span>
<span id="cb889-17"><a href="regression.html#cb889-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb889-18"><a href="regression.html#cb889-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb889-19"><a href="regression.html#cb889-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Subject&quot;</span>)</span>
<span id="cb889-20"><a href="regression.html#cb889-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-21"><a href="regression.html#cb889-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the correlation:</span></span>
<span id="cb889-22"><a href="regression.html#cb889-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(coefficients<span class="sc">$</span>Intercept, coefficients<span class="sc">$</span>Days)</span></code></pre></div>
<p>The correlation test is not significant, and judging from the plot, there is little indication that the intercept and slope are correlated. We saw earlier that both the intercept and the slope seem to differ between subjects, and so <code>m4</code> seems like the best choice here. Let’s stick with that, and look at a summary table for the model.</p>
<div class="sourceCode" id="cb890"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb890-1"><a href="regression.html#cb890-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m4, <span class="at">correlation =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>I like to add <code>correlation = FALSE</code> here, which suppresses some superfluous output from <code>summary</code>.</p>
<p>You’ll notice that unlike the <code>summary</code> table for linear models, there are no p-values! This is a deliberate design choice from the <code>lme4</code> developers, who argue that the approximate test available aren’t good enough for small sample sizes (Bates et al., 2015).</p>
<p>Using the bootstrap, as we will do in Section <a href="regression.html#lmmbootstrap">8.4.3</a>, is usually the best approach for mixed models. If you <em>really</em> want some quick p-values, you can load the <code>lmerTest</code> package, which adds p-values computed using the Satterthwaite approximation (Kuznetsova et al., 2017). This is better than the usual approximate test, but still not perfect.</p>
<div class="sourceCode" id="cb891"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb891-1"><a href="regression.html#cb891-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;lmerTest&quot;</span>)</span>
<span id="cb891-2"><a href="regression.html#cb891-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb891-3"><a href="regression.html#cb891-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb891-4"><a href="regression.html#cb891-4" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Subject) <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> Days<span class="sc">|</span>Subject),</span>
<span id="cb891-5"><a href="regression.html#cb891-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> sleepstudy)</span>
<span id="cb891-6"><a href="regression.html#cb891-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m4, <span class="at">correlation =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>If we need to extract the model coefficients, we can do so using <code>fixef</code> (for the fixed effects) and <code>ranef</code> (for the random effects):</p>
<div class="sourceCode" id="cb892"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb892-1"><a href="regression.html#cb892-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(m4)</span>
<span id="cb892-2"><a href="regression.html#cb892-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ranef</span>(m4)</span></code></pre></div>
<p>If we want to extract the variance components from the model, we can use <code>VarCorr</code>:</p>
<div class="sourceCode" id="cb893"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb893-1"><a href="regression.html#cb893-1" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(m4)</span></code></pre></div>
<p>Let’s add the lines from the fitted model to our facetted plot, to compare the results of our mixed model to the lines that were fitted separately for each individual:</p>
<div class="sourceCode" id="cb894"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb894-1"><a href="regression.html#cb894-1" aria-hidden="true" tabindex="-1"></a>mixed_mod <span class="ot">&lt;-</span> <span class="fu">coef</span>(m4)<span class="sc">$</span>Subject</span>
<span id="cb894-2"><a href="regression.html#cb894-2" aria-hidden="true" tabindex="-1"></a>mixed_mod<span class="sc">$</span>Subject <span class="ot">&lt;-</span> <span class="fu">row.names</span>(mixed_mod)</span>
<span id="cb894-3"><a href="regression.html#cb894-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb894-4"><a href="regression.html#cb894-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sleepstudy, <span class="fu">aes</span>(Days, Reaction)) <span class="sc">+</span></span>
<span id="cb894-5"><a href="regression.html#cb894-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb894-6"><a href="regression.html#cb894-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb894-7"><a href="regression.html#cb894-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="sc">~</span> Subject, <span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb894-8"><a href="regression.html#cb894-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;cyan&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb894-9"><a href="regression.html#cb894-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb894-10"><a href="regression.html#cb894-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, <span class="at">slope =</span> Days,</span>
<span id="cb894-11"><a href="regression.html#cb894-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">color =</span> <span class="st">&quot;magenta&quot;</span>),</span>
<span id="cb894-12"><a href="regression.html#cb894-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> mixed_mod, <span class="at">size =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<p>Notice that the lines differ. The intercept and slopes have been <em>shrunk</em> toward the global effects, i.e. toward the average of all lines.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excLMM1" class="exercise"><strong>Exercise 8.22  </strong></span>Consider the <code>Oxboys</code> data from the <code>nlme</code> package. Does a mixed model seem appropriate here? If so, is the intercept and slope for different subjects correlated? Fit a suitable model, with <code>height</code> as the response variable.</p>
<p>Save the code for your model, as you will return to it in the next few exercises.</p>
</div>
<p><a href="solutions.html#ch7solutionsLMM1">(Click here to go to the solution.)</a></p>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch7excLMM1b" class="exercise"><strong>Exercise 8.23  </strong></span>The <code>broom.mixed</code> package allows you to get summaries of mixed models as data frames, just as <code>broom</code> does for linear and generalised linear models. Install it and use it to get the summary table for the model for the <code>Oxboys</code> data that you created in the previous exercise. How are fixed and random effects included in the table?</p>
</div>
<p><a href="solutions.html#ch7solutionsLMM1b">(Click here to go to the solution.)</a></p>
</div>
<div id="model-diagnostics-2" class="section level3 hasAnchor" number="8.4.2">
<h3><span class="header-section-number">8.4.2</span> Model diagnostics<a href="regression.html#model-diagnostics-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As for any linear model, residual plots are useful for diagnostics for linear mixed models. Of particular interest are signs of heteroscedasticity, as homoscedasticity is assumed in the mixed model. We’ll use <code>fortify.merMod</code> to turn the model into an object that can be used with <code>ggplot2</code>, and then create some residual plots:</p>
<div class="sourceCode" id="cb895"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb895-1"><a href="regression.html#cb895-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb895-2"><a href="regression.html#cb895-2" aria-hidden="true" tabindex="-1"></a>fm4 <span class="ot">&lt;-</span> <span class="fu">fortify.merMod</span>(m4)</span>
<span id="cb895-3"><a href="regression.html#cb895-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb895-4"><a href="regression.html#cb895-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot residuals:</span></span>
<span id="cb895-5"><a href="regression.html#cb895-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fm4, <span class="fu">aes</span>(.fitted, .resid)) <span class="sc">+</span></span>
<span id="cb895-6"><a href="regression.html#cb895-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb895-7"><a href="regression.html#cb895-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb895-8"><a href="regression.html#cb895-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xlab</span>(<span class="st">&quot;Fitted values&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Residuals&quot;</span>)</span>
<span id="cb895-9"><a href="regression.html#cb895-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb895-10"><a href="regression.html#cb895-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the residuals of different subjects:</span></span>
<span id="cb895-11"><a href="regression.html#cb895-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fm4, <span class="fu">aes</span>(Subject, .resid)) <span class="sc">+</span></span>
<span id="cb895-12"><a href="regression.html#cb895-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb895-13"><a href="regression.html#cb895-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb895-14"><a href="regression.html#cb895-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylab</span>(<span class="st">&quot;Residuals&quot;</span>)</span>
<span id="cb895-15"><a href="regression.html#cb895-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb895-16"><a href="regression.html#cb895-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed values versus fitted values:</span></span>
<span id="cb895-17"><a href="regression.html#cb895-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fm4, <span class="fu">aes</span>(.fitted, Reaction)) <span class="sc">+</span></span>
<span id="cb895-18"><a href="regression.html#cb895-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb895-19"><a href="regression.html#cb895-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="sc">~</span> Subject, <span class="at">nrow =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb895-20"><a href="regression.html#cb895-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb895-21"><a href="regression.html#cb895-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xlab</span>(<span class="st">&quot;Fitted values&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Observed values&quot;</span>)</span>
<span id="cb895-22"><a href="regression.html#cb895-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb895-23"><a href="regression.html#cb895-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Q-Q plot of residuals:</span></span>
<span id="cb895-24"><a href="regression.html#cb895-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fm4, <span class="fu">aes</span>(<span class="at">sample =</span> .resid)) <span class="sc">+</span></span>
<span id="cb895-25"><a href="regression.html#cb895-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_qq</span>() <span class="sc">+</span> <span class="fu">geom_qq_line</span>()</span>
<span id="cb895-26"><a href="regression.html#cb895-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb895-27"><a href="regression.html#cb895-27" aria-hidden="true" tabindex="-1"></a><span class="do">## Q-Q plot of random effects:</span></span>
<span id="cb895-28"><a href="regression.html#cb895-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">ranef</span>(m4)<span class="sc">$</span>Subject, <span class="fu">aes</span>(<span class="at">sample =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb895-29"><a href="regression.html#cb895-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_qq</span>() <span class="sc">+</span> <span class="fu">geom_qq_line</span>()</span>
<span id="cb895-30"><a href="regression.html#cb895-30" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">ranef</span>(m4)<span class="sc">$</span>Subject, <span class="fu">aes</span>(<span class="at">sample =</span> <span class="st">`</span><span class="at">Days</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb895-31"><a href="regression.html#cb895-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_qq</span>() <span class="sc">+</span> <span class="fu">geom_qq_line</span>()</span></code></pre></div>
<p>The normality assumption appears to be satisfied, but there are some signs of heteroscedasticity in the boxplots of the residuals for the different subjects.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excLMM2" class="exercise"><strong>Exercise 8.24  </strong></span>Return to your mixed model for the <code>Oxboys</code> data from Exercise <a href="regression.html#exr:ch7excLMM1">8.22</a>. Make diagnostic plots for the model. Are there any signs of heteroscedasticity or non-normality?</p>
</div>
<p><a href="solutions.html#ch7solutionsLMM2">(Click here to go to the solution.)</a></p>
</div>
<div id="lmmbootstrap" class="section level3 hasAnchor" number="8.4.3">
<h3><span class="header-section-number">8.4.3</span> Bootstrapping<a href="regression.html#lmmbootstrap" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Summary tables, including p-values, for the fixed effects are available through <code>boot_summary</code>:</p>
<div class="sourceCode" id="cb896"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb896-1"><a href="regression.html#cb896-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot.pval)</span>
<span id="cb896-2"><a href="regression.html#cb896-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_summary</span>(m4, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>)</span></code></pre></div>
<p><code>boot_summary</code> calls a function called <code>bootMer</code>, which performs parametric resampling from the model. In case you want to call it directly, you can do as follows:</p>
<div class="sourceCode" id="cb897"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb897-1"><a href="regression.html#cb897-1" aria-hidden="true" tabindex="-1"></a>boot_res <span class="ot">&lt;-</span> <span class="fu">bootMer</span>(m4, fixef, <span class="at">nsim =</span> <span class="dv">999</span>)</span>
<span id="cb897-2"><a href="regression.html#cb897-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb897-3"><a href="regression.html#cb897-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb897-4"><a href="regression.html#cb897-4" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">1</span>) <span class="co"># Intercept</span></span>
<span id="cb897-5"><a href="regression.html#cb897-5" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">2</span>) <span class="co"># Days</span></span></code></pre></div>
</div>
<div id="nested-random-effects-and-multilevelhierarchical-models" class="section level3 hasAnchor" number="8.4.4">
<h3><span class="header-section-number">8.4.4</span> Nested random effects and multilevel/hierarchical models<a href="regression.html#nested-random-effects-and-multilevelhierarchical-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In many cases, a random factor is <em>nested</em> within another. To see an example of this, consider the <code>Pastes</code> data from <code>lme4</code>:</p>
<div class="sourceCode" id="cb898"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb898-1"><a href="regression.html#cb898-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb898-2"><a href="regression.html#cb898-2" aria-hidden="true" tabindex="-1"></a>?Pastes</span>
<span id="cb898-3"><a href="regression.html#cb898-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(Pastes)</span></code></pre></div>
<p>We are interested in the <code>strength</code> of a chemical product. There are ten delivery batches (<code>batch</code>), and three casks within each delivery (<code>cask</code>). Because of variations in manufacturing, transportation, storage, and so on, it makes sense to include random effects for both <code>batch</code> and <code>cask</code> in a linear mixed model. However, each cask only appears within a single batch, which makes the <code>cask</code> effect <em>nested</em> within <code>batch</code>.</p>
<p>Models that use nested random factors are commonly known as <em>multilevel models</em> (the random factors exist at different “levels”), or <em>hierarchical models</em> (there is a hierarchy between the random factors). These aren’t really any different from other mixed models, but depending on how the data is structured, we may have to be a bit careful to get the nesting right when we fit the model with <code>lmer</code>.</p>
<p>If the two effects weren’t nested, we could fit a model using:</p>
<div class="sourceCode" id="cb899"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb899-1"><a href="regression.html#cb899-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Incorrect model:</span></span>
<span id="cb899-2"><a href="regression.html#cb899-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(strength <span class="sc">~</span> (<span class="dv">1</span><span class="sc">|</span>batch) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>cask),</span>
<span id="cb899-3"><a href="regression.html#cb899-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> Pastes)</span>
<span id="cb899-4"><a href="regression.html#cb899-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1, <span class="at">correlation =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>However, because the casks are labelled <code>a</code>, <code>b</code>, and <code>c</code> within each batch, we’ve now fitted a model where casks from different batches are treated as being equal! To clarify that the labels <code>a</code>, <code>b</code>, and <code>c</code> belong to different casks in different batches, we need to include the nesting in our formula. This is done as follows:</p>
<div class="sourceCode" id="cb900"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb900-1"><a href="regression.html#cb900-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cask in nested within batch:</span></span>
<span id="cb900-2"><a href="regression.html#cb900-2" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(strength <span class="sc">~</span> (<span class="dv">1</span><span class="sc">|</span>batch<span class="sc">/</span>cask),</span>
<span id="cb900-3"><a href="regression.html#cb900-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> Pastes)</span>
<span id="cb900-4"><a href="regression.html#cb900-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m2, <span class="at">correlation =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Equivalently, we can also use:</p>
<div class="sourceCode" id="cb901"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb901-1"><a href="regression.html#cb901-1" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(strength <span class="sc">~</span> (<span class="dv">1</span><span class="sc">|</span>batch) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>batch<span class="sc">:</span>cask),</span>
<span id="cb901-2"><a href="regression.html#cb901-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> Pastes)</span>
<span id="cb901-3"><a href="regression.html#cb901-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m3, <span class="at">correlation =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="anova-with-random-effects" class="section level3 hasAnchor" number="8.4.5">
<h3><span class="header-section-number">8.4.5</span> ANOVA with random effects<a href="regression.html#anova-with-random-effects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>lmerTest</code> package provides ANOVA tables that allow us to use random effects in ANOVA models. To use it, simply load <code>lmerTest</code> before fitting a model with <code>lmer</code>, and then run <code>anova(m, type = "III")</code> (or replace <code>III</code> with <code>II</code> or <code>I</code> if you want a type II or type I ANOVA table instead).</p>
<p>As an example, consider the <code>TVbo</code> data from <code>lmerTest</code>. 3 types of TV sets were compared by 8 assessors for 4 different pictures. To see if there is a difference in the mean score for the colour balance of the TV sets, we can fit a mixed model. We’ll include a random intercept for the assessor. This is a balanced design (in which case the results from all three types of tables coincide):</p>
<div class="sourceCode" id="cb902"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb902-1"><a href="regression.html#cb902-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb902-2"><a href="regression.html#cb902-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb902-3"><a href="regression.html#cb902-3" aria-hidden="true" tabindex="-1"></a><span class="co"># TV data:</span></span>
<span id="cb902-4"><a href="regression.html#cb902-4" aria-hidden="true" tabindex="-1"></a>?TVbo</span>
<span id="cb902-5"><a href="regression.html#cb902-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb902-6"><a href="regression.html#cb902-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model with both fixed and random effects:</span></span>
<span id="cb902-7"><a href="regression.html#cb902-7" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Colourbalance <span class="sc">~</span> TVset<span class="sc">*</span>Picture <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Assessor),</span>
<span id="cb902-8"><a href="regression.html#cb902-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">data =</span> TVbo)</span>
<span id="cb902-9"><a href="regression.html#cb902-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb902-10"><a href="regression.html#cb902-10" aria-hidden="true" tabindex="-1"></a><span class="co"># View fitted model:</span></span>
<span id="cb902-11"><a href="regression.html#cb902-11" aria-hidden="true" tabindex="-1"></a>m</span>
<span id="cb902-12"><a href="regression.html#cb902-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb902-13"><a href="regression.html#cb902-13" aria-hidden="true" tabindex="-1"></a><span class="co"># All three types of ANOVA table give the same results here:</span></span>
<span id="cb902-14"><a href="regression.html#cb902-14" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(m, <span class="at">type =</span> <span class="st">&quot;III&quot;</span>)</span>
<span id="cb902-15"><a href="regression.html#cb902-15" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(m, <span class="at">type =</span> <span class="st">&quot;II&quot;</span>)</span>
<span id="cb902-16"><a href="regression.html#cb902-16" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(m, <span class="at">type =</span> <span class="st">&quot;I&quot;</span>)</span></code></pre></div>
<p>The interaction effect is significant at the 5 % level. As for other ANOVA models, we can visualise this with an interaction plot:</p>
<div class="sourceCode" id="cb903"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb903-1"><a href="regression.html#cb903-1" aria-hidden="true" tabindex="-1"></a><span class="fu">interaction.plot</span>(TVbo<span class="sc">$</span>TVset, TVbo<span class="sc">$</span>Picture,</span>
<span id="cb903-2"><a href="regression.html#cb903-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">response =</span> TVbo<span class="sc">$</span>Colourbalance)</span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excLMM2b" class="exercise"><strong>Exercise 8.25  </strong></span>Fit a mixed effects ANOVA to the <code>TVbo</code> data, using <code>Coloursaturation</code> as the response variable, <code>TVset</code> and <code>Picture</code> as fixed effects, and <code>Assessor</code> as a random effect. Does there appear to be a need to include the interaction between <code>Assessor</code> and <code>TVset</code> as a random effect? If so, do it.</p>
</div>
<p><a href="solutions.html#ch7solutionsLMM2b">(Click here to go to the solution.)</a></p>
</div>
<div id="generalised-linear-mixed-models" class="section level3 hasAnchor" number="8.4.6">
<h3><span class="header-section-number">8.4.6</span> Generalised linear mixed models<a href="regression.html#generalised-linear-mixed-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Everything that we have just done for the linear mixed models carries over to <em>generalised linear mixed models</em> (GLMM), which are GLM’s with both fixed and random effects.</p>
<p>A common example is the <em>item response model</em>, which plays an important role in psychometrics. This model is frequently used in psychological tests containing multiple questions or sets of questions (“items”), where both the subject the item are considered random effects. As an example, consider the <code>VerbAgg</code> data from <code>lme4</code>:</p>
<div class="sourceCode" id="cb904"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb904-1"><a href="regression.html#cb904-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb904-2"><a href="regression.html#cb904-2" aria-hidden="true" tabindex="-1"></a>?VerbAgg</span>
<span id="cb904-3"><a href="regression.html#cb904-3" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(VerbAgg)</span></code></pre></div>
<p>We’ll use the binary version of the response, <code>r2</code>, and fit a logistic mixed regression model to the data, to see if it can be used to explain the subjects’ responses. The formula syntax is the same as for linear mixed models, but now we’ll use <code>glmer</code> to fit a GLMM. We’ll include <code>Anger</code> and <code>Gender</code> as fixed effects (we are interested in seeing how these affect the response) and <code>item</code> and <code>id</code> as random effects with random slopes (we believe that answers to the same item and answers from the same individual may be correlated):</p>
<div class="sourceCode" id="cb905"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb905-1"><a href="regression.html#cb905-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glmer</span>(r2 <span class="sc">~</span> Anger <span class="sc">+</span> Gender <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>item) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>id),</span>
<span id="cb905-2"><a href="regression.html#cb905-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> VerbAgg, <span class="at">family =</span> binomial)</span>
<span id="cb905-3"><a href="regression.html#cb905-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m, <span class="at">correlation =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>We can plot the fitted random effects for <code>item</code> to verify that there appear to be differences between the different items:</p>
<div class="sourceCode" id="cb906"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb906-1"><a href="regression.html#cb906-1" aria-hidden="true" tabindex="-1"></a>mixed_mod <span class="ot">&lt;-</span> <span class="fu">coef</span>(m)<span class="sc">$</span>item</span>
<span id="cb906-2"><a href="regression.html#cb906-2" aria-hidden="true" tabindex="-1"></a>mixed_mod<span class="sc">$</span>item <span class="ot">&lt;-</span> <span class="fu">row.names</span>(mixed_mod)</span>
<span id="cb906-3"><a href="regression.html#cb906-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb906-4"><a href="regression.html#cb906-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mixed_mod, <span class="fu">aes</span>(<span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, item)) <span class="sc">+</span></span>
<span id="cb906-5"><a href="regression.html#cb906-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb906-6"><a href="regression.html#cb906-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xlab</span>(<span class="st">&quot;Random intercept&quot;</span>)</span></code></pre></div>
<p>The <code>situ</code> variable, describing situation type, also appears interesting. Let’s include it as a fixed effect. Let’s also allow different situational (random) effects for different respondents. It seems reasonable that such responses are random rather than fixed (as in the <a href="solutions.html#ch7solutionsLMM2b">solution</a> to Exercise <a href="regression.html#exr:ch7excLMM2b">8.25</a>), and we do have repeated measurements of these responses. We’ll therefore also include <code>situ</code> as a random effect nested within <code>id</code>:</p>
<div class="sourceCode" id="cb907"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb907-1"><a href="regression.html#cb907-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glmer</span>(r2 <span class="sc">~</span> Anger <span class="sc">+</span> Gender <span class="sc">+</span> situ <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>item) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>id<span class="sc">/</span>situ),</span>
<span id="cb907-2"><a href="regression.html#cb907-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> VerbAgg, <span class="at">family =</span> binomial)</span>
<span id="cb907-3"><a href="regression.html#cb907-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m, <span class="at">correlation =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Finally, we’d like to obtain bootstrap confidence intervals for fixed effects. Because this is a fairly large dataset (<span class="math inline">\(n=7,584\)</span>) this can take a looong time to run, so stretch your legs and grab a cup of coffee or two while you wait:</p>
<div class="sourceCode" id="cb908"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb908-1"><a href="regression.html#cb908-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot.pval)</span>
<span id="cb908-2"><a href="regression.html#cb908-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boot_summary</span>(m, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">R =</span> <span class="dv">100</span>)</span>
<span id="cb908-3"><a href="regression.html#cb908-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ideally, R should be greater, but for the sake of</span></span>
<span id="cb908-4"><a href="regression.html#cb908-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this example, we&#39;ll use a low number.</span></span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excLMM3" class="exercise"><strong>Exercise 8.26  </strong></span>Consider the <code>grouseticks</code> data from the <code>lme4</code> package (Elston et al., 2001). Fit a mixed Poisson regression model to the data, with <code>TICKS</code> as the response variable and <code>YEAR</code> and <code>HEIGHT</code> as fixed effects. What variables are suitable to use for random effects? Compute a bootstrap confidence interval for the effect of <code>HEIGHT</code>.</p>
</div>
<p><a href="solutions.html#ch7solutionsLMM3">(Click here to go to the solution.)</a></p>
</div>
<div id="bayesian-estimation-of-mixed-models" class="section level3 hasAnchor" number="8.4.7">
<h3><span class="header-section-number">8.4.7</span> Bayesian estimation of mixed models<a href="regression.html#bayesian-estimation-of-mixed-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>From a numerical point of view, using Bayesian modelling with <code>rstanarm</code> is preferable to frequentist modelling with <code>lme4</code> if you have complex models with many random effects. Indeed, for some models, <code>lme4</code> will return a warning message about a singular fit, basically meaning that the model is too complex, whereas <code>rstanarm</code>, powered by the use of a prior distribution, always will return a fitted model regardless of complexity.</p>
<p>After loading <code>rstanarm</code>, fitting a Bayesian linear mixed model with a weakly informative prior is as simple as substituting <code>lmer</code> with <code>stan_lmer</code>:</p>
<div class="sourceCode" id="cb909"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb909-1"><a href="regression.html#cb909-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb909-2"><a href="regression.html#cb909-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb909-3"><a href="regression.html#cb909-3" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">stan_lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Subject) <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> Days<span class="sc">|</span>Subject),</span>
<span id="cb909-4"><a href="regression.html#cb909-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> sleepstudy)</span>
<span id="cb909-5"><a href="regression.html#cb909-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb909-6"><a href="regression.html#cb909-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the results:</span></span>
<span id="cb909-7"><a href="regression.html#cb909-7" aria-hidden="true" tabindex="-1"></a>m4</span></code></pre></div>
<p>To plot the posterior distributions for the coefficients of the fixed effects, we can use <code>plot</code>, specifying which effects we are interested in using <code>pars</code>:</p>
<div class="sourceCode" id="cb910"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb910-1"><a href="regression.html#cb910-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m4, <span class="st">&quot;dens&quot;</span>, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;(Intercept)&quot;</span>, <span class="st">&quot;Days&quot;</span>))</span></code></pre></div>
<p>To get 95 % credible intervals for the fixed effects, we can use <code>posterior_interval</code> as follows:</p>
<div class="sourceCode" id="cb911"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb911-1"><a href="regression.html#cb911-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior_interval</span>(m4, </span>
<span id="cb911-2"><a href="regression.html#cb911-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;(Intercept)&quot;</span>, <span class="st">&quot;Days&quot;</span>),</span>
<span id="cb911-3"><a href="regression.html#cb911-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fl">0.95</span>)</span></code></pre></div>
<p>We can also plot them using <code>plot</code>:</p>
<div class="sourceCode" id="cb912"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb912-1"><a href="regression.html#cb912-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m4, <span class="st">&quot;intervals&quot;</span>,</span>
<span id="cb912-2"><a href="regression.html#cb912-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;(Intercept)&quot;</span>, <span class="st">&quot;Days&quot;</span>),</span>
<span id="cb912-3"><a href="regression.html#cb912-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fl">0.95</span>)</span></code></pre></div>
<p>Finally, we’ll check that the model fitting has converged:</p>
<div class="sourceCode" id="cb913"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb913-1"><a href="regression.html#cb913-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m4, <span class="st">&quot;rhat&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="survival" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Survival analysis<a href="regression.html#survival" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Many studies are concerned with the duration of time until an event happens: time until a machine fails, time until a patient diagnosed with a disease dies, and so on. In this section we will consider some methods for <em>survival analysis</em> (also known as reliability analysis in engineering and duration analysis in economics), which is used for analysing such data. The main difficulty here is that studies often end before all participants have had events, meaning that some observations are <em>right-censored</em> - for these observations, we don’t know when the event happened, but only that it happened after the end of the study.</p>
<p>The <code>survival</code> package contains a number of useful methods for survival analysis. Let’s install it:</p>
<div class="sourceCode" id="cb914"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb914-1"><a href="regression.html#cb914-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;survival&quot;</span>)</span></code></pre></div>
<p>We will study the lung cancer data in <code>lung</code>:</p>
<div class="sourceCode" id="cb915"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb915-1"><a href="regression.html#cb915-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb915-2"><a href="regression.html#cb915-2" aria-hidden="true" tabindex="-1"></a>?lung</span>
<span id="cb915-3"><a href="regression.html#cb915-3" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(lung)</span></code></pre></div>
<p>The survival times of the patients consist of two parts: <code>time</code> (the time from diagnosis until either death or the end of the study) and <code>status</code> (1 if the observations is censored, 2 if the patient died before the end of the study). To combine these so that they can be used in a survival analysis, we must create a <code>Surv</code> object:</p>
<div class="sourceCode" id="cb916"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb916-1"><a href="regression.html#cb916-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Surv</span>(lung<span class="sc">$</span>time, lung<span class="sc">$</span>status)</span></code></pre></div>
<p>Here, a <code>+</code> sign after a value indicates right-censoring.</p>
<div id="comparing-groups" class="section level3 hasAnchor" number="8.5.1">
<h3><span class="header-section-number">8.5.1</span> Comparing groups<a href="regression.html#comparing-groups" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Survival times are best visualised using Kaplan-Meier curves that show the proportion of surviving patients. Let’s compare the survival times of women and men. We first fit a survival model using <code>survfit</code>, and then draw the Kaplan-Meier curve (with parametric confidence intervals) using <code>autoplot</code> from <code>ggfortify</code>:</p>
<div class="sourceCode" id="cb917"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb917-1"><a href="regression.html#cb917-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify)</span>
<span id="cb917-2"><a href="regression.html#cb917-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb917-3"><a href="regression.html#cb917-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb917-4"><a href="regression.html#cb917-4" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(m)</span></code></pre></div>
<p>To print the values for the survival curves at different time points, we can use <code>summary</code>:</p>
<div class="sourceCode" id="cb918"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb918-1"><a href="regression.html#cb918-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>To test for differences between two groups, we can use the logrank test (also known as the Mantel-Cox test), given by <code>survfit</code>:</p>
<div class="sourceCode" id="cb919"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb919-1"><a href="regression.html#cb919-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span></code></pre></div>
<p>Another option is the Peto-Peto test, which puts more weight on early events (deaths, in the case of the <code>lung</code> data), and therefore is suitable when such events are of greater interest. In contrast, the logrank test puts equal weights on all events regardless of when they occur. The Peto-Peto test is obtained by adding the argument <code>rho = 1</code>:</p>
<div class="sourceCode" id="cb920"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb920-1"><a href="regression.html#cb920-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">rho =</span> <span class="dv">1</span>, <span class="at">data =</span> lung)</span></code></pre></div>
<p>The <code>Hmisc</code> package contains a function for obtaining confidence intervals based on the Kaplan-Meier estimator, called <code>bootkm</code>. This allows us to get confidence intervals for the quantiles (including the median) of the survival distribution for different groups, as well as for differences between the quantiles of different groups. First, let’s install it:</p>
<div class="sourceCode" id="cb921"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb921-1"><a href="regression.html#cb921-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;Hmisc&quot;</span>)</span></code></pre></div>
<p>We can now use <code>bootkm</code> to compute bootstrap confidence intervals for survival times based on the <code>lung</code> data. We’ll compute an interval for the median survival time for females, and one for the difference in median survival time between females and males:</p>
<div class="sourceCode" id="cb922"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb922-1"><a href="regression.html#cb922-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Hmisc)</span>
<span id="cb922-2"><a href="regression.html#cb922-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb922-3"><a href="regression.html#cb922-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a survival object:</span></span>
<span id="cb922-4"><a href="regression.html#cb922-4" aria-hidden="true" tabindex="-1"></a>survobj <span class="ot">&lt;-</span> <span class="fu">Surv</span>(lung<span class="sc">$</span>time, lung<span class="sc">$</span>status)</span>
<span id="cb922-5"><a href="regression.html#cb922-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb922-6"><a href="regression.html#cb922-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get bootstrap replicates of the median survival time for</span></span>
<span id="cb922-7"><a href="regression.html#cb922-7" aria-hidden="true" tabindex="-1"></a><span class="co"># the two groups:</span></span>
<span id="cb922-8"><a href="regression.html#cb922-8" aria-hidden="true" tabindex="-1"></a>median_surv_time_female <span class="ot">&lt;-</span> <span class="fu">bootkm</span>(survobj[lung<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">2</span>],</span>
<span id="cb922-9"><a href="regression.html#cb922-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">q =</span> <span class="fl">0.5</span>, <span class="at">B =</span> <span class="dv">999</span>)</span>
<span id="cb922-10"><a href="regression.html#cb922-10" aria-hidden="true" tabindex="-1"></a>median_surv_time_male <span class="ot">&lt;-</span> <span class="fu">bootkm</span>(survobj[lung<span class="sc">$</span>sex <span class="sc">==</span> <span class="dv">1</span>],</span>
<span id="cb922-11"><a href="regression.html#cb922-11" aria-hidden="true" tabindex="-1"></a>                                <span class="at">q =</span> <span class="fl">0.5</span>, <span class="at">B =</span> <span class="dv">999</span>)</span>
<span id="cb922-12"><a href="regression.html#cb922-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb922-13"><a href="regression.html#cb922-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 95 % bootstrap confidence interval for the median survival time</span></span>
<span id="cb922-14"><a href="regression.html#cb922-14" aria-hidden="true" tabindex="-1"></a><span class="co"># for females:</span></span>
<span id="cb922-15"><a href="regression.html#cb922-15" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(median_surv_time_female,</span>
<span id="cb922-16"><a href="regression.html#cb922-16" aria-hidden="true" tabindex="-1"></a>         <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">975</span>), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb922-17"><a href="regression.html#cb922-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb922-18"><a href="regression.html#cb922-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 95 % bootstrap confidence interval for the difference in median</span></span>
<span id="cb922-19"><a href="regression.html#cb922-19" aria-hidden="true" tabindex="-1"></a><span class="co"># survival time:</span></span>
<span id="cb922-20"><a href="regression.html#cb922-20" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(median_surv_time_female <span class="sc">-</span> median_surv_time_male,</span>
<span id="cb922-21"><a href="regression.html#cb922-21" aria-hidden="true" tabindex="-1"></a>         <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">975</span>), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>To obtain confidence intervals for other quantiles, we simply change the argument <code>q</code> in <code>bootkm</code>.</p>
<p><span class="math display">\[\sim\]</span>
::: {.exercise #ch7excLMM3b}
Consider the <code>ovarian</code> data from the <code>survival</code> package. Plot Kaplan-Meier curves comparing the two treatment groups. Compute a bootstrap confidence interval for the difference in the 75 % quantile for the survival time for the two groups.</p>
<p>:::
<a href="solutions.html#ch7solutionsLMM3b">(Click here to go to the solution.)</a></p>
</div>
<div id="the-cox-proportional-hazards-model" class="section level3 hasAnchor" number="8.5.2">
<h3><span class="header-section-number">8.5.2</span> The Cox proportional hazards model<a href="regression.html#the-cox-proportional-hazards-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The hazard function, or hazard rate, is the rate of events at time <span class="math inline">\(t\)</span> if a subject has survived until time <span class="math inline">\(t\)</span>. The higher the hazard, the greater the probability of an event. Hazard rates play an integral part in survival analysis, particularly in regression models. To model how the survival times are affected by different explanatory variables, we can use a <em>Cox proportional hazards model</em> (Cox, 1972), fitted using <code>coxph</code>:</p>
<div class="sourceCode" id="cb923"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb923-1"><a href="regression.html#cb923-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb923-2"><a href="regression.html#cb923-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>The exponentiated coefficients show the hazard ratios, i.e. the relative increases (values greater than 1) or decreases (values below 1) of the hazard rate when a covariate is increased one step while all others are kept fixed:</p>
<div class="sourceCode" id="cb924"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb924-1"><a href="regression.html#cb924-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(m))</span></code></pre></div>
<p>In this case, the hazard increases with age (multiply the hazard by 1.017 for each additional year that the person has lived), and is lower for women (<code>sex=2</code>) than for men (<code>sex=1</code>).</p>
<p>The <code>censboot_summary</code> function from <code>boot.pval</code> provides a table of estimates, bootstrap confidence intervals, and bootstrap p-values for the model coefficients. The <code>coef</code> argument can be used to specify whether to print confidence intervals for the coefficients or for the exponentiated coeffientes (i.e. the hazard ratios):</p>
<div class="sourceCode" id="cb925"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb925-1"><a href="regression.html#cb925-1" aria-hidden="true" tabindex="-1"></a><span class="co"># censboot_summary requires us to use model = TRUE</span></span>
<span id="cb925-2"><a href="regression.html#cb925-2" aria-hidden="true" tabindex="-1"></a><span class="co"># when fitting our regression model:</span></span>
<span id="cb925-3"><a href="regression.html#cb925-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex,</span>
<span id="cb925-4"><a href="regression.html#cb925-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> lung, <span class="at">model =</span> <span class="cn">TRUE</span>)</span>
<span id="cb925-5"><a href="regression.html#cb925-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb925-6"><a href="regression.html#cb925-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot.pval)</span>
<span id="cb925-7"><a href="regression.html#cb925-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Original coefficients:</span></span>
<span id="cb925-8"><a href="regression.html#cb925-8" aria-hidden="true" tabindex="-1"></a><span class="fu">censboot_summary</span>(m, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">coef =</span> <span class="st">&quot;raw&quot;</span>)</span>
<span id="cb925-9"><a href="regression.html#cb925-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Exponentiated coefficients:</span></span>
<span id="cb925-10"><a href="regression.html#cb925-10" aria-hidden="true" tabindex="-1"></a><span class="fu">censboot_summary</span>(m, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">coef =</span> <span class="st">&quot;exp&quot;</span>)</span></code></pre></div>
<p>To manually obtain bootstrap confidence intervals for the exponentiated coefficients, we can use the <code>censboot</code> function from <code>boot</code> as follows:</p>
<div class="sourceCode" id="cb926"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb926-1"><a href="regression.html#cb926-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get the bootstrap replicates of the exponentiated</span></span>
<span id="cb926-2"><a href="regression.html#cb926-2" aria-hidden="true" tabindex="-1"></a><span class="co"># coefficients:</span></span>
<span id="cb926-3"><a href="regression.html#cb926-3" aria-hidden="true" tabindex="-1"></a>boot_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(data, formula) {</span>
<span id="cb926-4"><a href="regression.html#cb926-4" aria-hidden="true" tabindex="-1"></a>     m_boot <span class="ot">&lt;-</span> <span class="fu">coxph</span>(formula, <span class="at">data =</span> data)</span>
<span id="cb926-5"><a href="regression.html#cb926-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(<span class="fu">exp</span>(<span class="fu">coef</span>(m_boot)))</span>
<span id="cb926-6"><a href="regression.html#cb926-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb926-7"><a href="regression.html#cb926-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb926-8"><a href="regression.html#cb926-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the resampling:</span></span>
<span id="cb926-9"><a href="regression.html#cb926-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb926-10"><a href="regression.html#cb926-10" aria-hidden="true" tabindex="-1"></a>boot_res <span class="ot">&lt;-</span> <span class="fu">censboot</span>(lung[,<span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;status&quot;</span>, <span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>)],</span>
<span id="cb926-11"><a href="regression.html#cb926-11" aria-hidden="true" tabindex="-1"></a>                     boot_fun, <span class="at">R =</span> <span class="dv">999</span>, </span>
<span id="cb926-12"><a href="regression.html#cb926-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">formula =</span> </span>
<span id="cb926-13"><a href="regression.html#cb926-13" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">formula</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex))</span>
<span id="cb926-14"><a href="regression.html#cb926-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb926-15"><a href="regression.html#cb926-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the percentile bootstrap confidence intervals:</span></span>
<span id="cb926-16"><a href="regression.html#cb926-16" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">1</span>) <span class="co"># Age</span></span>
<span id="cb926-17"><a href="regression.html#cb926-17" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">2</span>) <span class="co"># Sex</span></span></code></pre></div>
<p>As the name implies, the Cox proportional hazards model relies on the assumption of <em>proportional hazards</em>, which essentially means that the effect of the explanatory variables is constant over time. This can be assessed visually by plotting the model residuals, using <code>cox.zph</code> and the <code>ggcoxzph</code> function from the <code>survminer</code> package. Specifically, we will plot the scaled Schoenfeld (1982) residuals, which measure the difference between the observed covariates and the expected covariates given the risk at the time of an event. If the proportional hazards assumption holds, then there should be no trend over time for these residuals. Use the trend line to aid the eye:</p>
<div class="sourceCode" id="cb927"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb927-1"><a href="regression.html#cb927-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;survminer&quot;</span>)</span>
<span id="cb927-2"><a href="regression.html#cb927-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb927-3"><a href="regression.html#cb927-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb927-4"><a href="regression.html#cb927-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxzph</span>(<span class="fu">cox.zph</span>(m), <span class="at">var =</span> <span class="dv">1</span>) <span class="co"># age</span></span>
<span id="cb927-5"><a href="regression.html#cb927-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcoxzph</span>(<span class="fu">cox.zph</span>(m), <span class="at">var =</span> <span class="dv">2</span>) <span class="co"># sex</span></span>
<span id="cb927-6"><a href="regression.html#cb927-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb927-7"><a href="regression.html#cb927-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Formal p-values for a test of proportional</span></span>
<span id="cb927-8"><a href="regression.html#cb927-8" aria-hidden="true" tabindex="-1"></a><span class="co"># hazards, for each variable:</span></span>
<span id="cb927-9"><a href="regression.html#cb927-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cox.zph</span>(m)</span></code></pre></div>
<p>In this case, there are no apparent trends over time (which is in line with the corresponding formal hypothesis tests), indicating that the proportional hazards model could be applicable here.</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excLMM3c" class="exercise"><strong>Exercise 8.27  </strong></span>Consider the <code>ovarian</code> data from the <code>survival</code> package.</p>
<ol style="list-style-type: decimal">
<li>Use a Cox proportional hazards regression to test whether there is a difference between the two treatment groups, adjusted for age.</li>
<li>Compute bootstrap confidence interval for the hazard ratio of age.</li>
</ol>
</div>
<p><a href="solutions.html#ch7solutionsLMM3c">(Click here to go to the solution.)</a></p>
<p><br></p>
<div class="exercise">
<p><span id="exr:ch7excLMM4" class="exercise"><strong>Exercise 8.28  </strong></span>Consider the <code>retinopathy</code> data from the <code>survival</code> package. We are interested in a mixed survival model, where <code>id</code> is used to identify patients and <code>type</code>, <code>trt</code>and <code>age</code> are fixed effects. Fit a mixed Cox proportional hazards regression (add <code>cluster = id</code> to the call to <code>coxph</code> to include this as a random effect). Is the assumption of proportional hazards fulfilled?</p>
</div>
<p><a href="solutions.html#ch7solutionsLMM4">(Click here to go to the solution.)</a></p>
</div>
<div id="accelerated-failure-time-models" class="section level3 hasAnchor" number="8.5.3">
<h3><span class="header-section-number">8.5.3</span> Accelerated failure time models<a href="regression.html#accelerated-failure-time-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In many cases, the proportional hazards assumption does not hold. In such cases we can turn to <em>accelerated failure time models</em> (Wei, 1992), for which the effect of covariates is to accelerate or decelerate the life course of a subject.</p>
<p>While the proportional hazards model is semiparametric, accelerated failure time models are typically fully parametric, and thus involve stronger assumptions about an underlying distribution. When fitting such a model using the <code>survreg</code> function, we must therefore specify what distribution to use. Two common choices are the Weibull distribution and the log-logistic distribution. The Weibull distribution is commonly used in engineering, e.g. in reliability studies. The hazard function of Weibull models is always monotonic, i.e. either always increasing or always decreasing. In contrast, the log-logistic distribution allows the hazard function to be non-monotonic, making it more flexible, and often more appropriate for biological studies. Let’s fit both types of models to the <code>lung</code> data and have a look at the results:</p>
<div class="sourceCode" id="cb928"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb928-1"><a href="regression.html#cb928-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb928-2"><a href="regression.html#cb928-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb928-3"><a href="regression.html#cb928-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Weibull model:</span></span>
<span id="cb928-4"><a href="regression.html#cb928-4" aria-hidden="true" tabindex="-1"></a>m_w <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex, <span class="at">data =</span> lung,</span>
<span id="cb928-5"><a href="regression.html#cb928-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">dist =</span> <span class="st">&quot;weibull&quot;</span>, <span class="at">model =</span> <span class="cn">TRUE</span>)</span>
<span id="cb928-6"><a href="regression.html#cb928-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_w)</span>
<span id="cb928-7"><a href="regression.html#cb928-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb928-8"><a href="regression.html#cb928-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit log-logistic model:</span></span>
<span id="cb928-9"><a href="regression.html#cb928-9" aria-hidden="true" tabindex="-1"></a>m_ll <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex, <span class="at">data =</span> lung,</span>
<span id="cb928-10"><a href="regression.html#cb928-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">dist =</span> <span class="st">&quot;loglogistic&quot;</span>, <span class="at">model =</span> <span class="cn">TRUE</span>)</span>
<span id="cb928-11"><a href="regression.html#cb928-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_ll)</span></code></pre></div>
<p>Interpreting the coefficients of accelerated failure time models is easier than interpreting coefficients from proportional hazards models. The exponentiated coefficients show the relative increase or decrease in the expected survival times when a covariate is increased one step while all others are kept fixed:</p>
<div class="sourceCode" id="cb929"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb929-1"><a href="regression.html#cb929-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(m_ll))</span></code></pre></div>
<p>In this case, according to the log-logistic model, the expected survival time decreases by 1.4 % (i.e. multiply by <span class="math inline">\(0.986\)</span>) for each additional year that the patient has lived. The expected survival time for females (<code>sex=2</code>) is 61.2 % higher than for males (multiply by <span class="math inline">\(1.612\)</span>).</p>
<p>To obtain bootstrap confidence intervals and p-values for the effects, we follow the same procedure as for the Cox model, using <code>censboot_summary</code>. Here is an example for the log-logistic accelerated failure time model:</p>
<div class="sourceCode" id="cb930"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb930-1"><a href="regression.html#cb930-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot.pval)</span>
<span id="cb930-2"><a href="regression.html#cb930-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Original coefficients:</span></span>
<span id="cb930-3"><a href="regression.html#cb930-3" aria-hidden="true" tabindex="-1"></a><span class="fu">censboot_summary</span>(m_ll, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">coef =</span> <span class="st">&quot;raw&quot;</span>)</span>
<span id="cb930-4"><a href="regression.html#cb930-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exponentiated coefficients:</span></span>
<span id="cb930-5"><a href="regression.html#cb930-5" aria-hidden="true" tabindex="-1"></a><span class="fu">censboot_summary</span>(m_ll, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">coef =</span> <span class="st">&quot;exp&quot;</span>)</span></code></pre></div>
<p>We can also use <code>censboot</code>:</p>
<div class="sourceCode" id="cb931"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb931-1"><a href="regression.html#cb931-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get the bootstrap replicates of the exponentiated</span></span>
<span id="cb931-2"><a href="regression.html#cb931-2" aria-hidden="true" tabindex="-1"></a><span class="co"># coefficients:</span></span>
<span id="cb931-3"><a href="regression.html#cb931-3" aria-hidden="true" tabindex="-1"></a>boot_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(data, formula, distr) {</span>
<span id="cb931-4"><a href="regression.html#cb931-4" aria-hidden="true" tabindex="-1"></a>     m_boot <span class="ot">&lt;-</span> <span class="fu">survreg</span>(formula, <span class="at">data =</span> data, <span class="at">dist =</span> distr)</span>
<span id="cb931-5"><a href="regression.html#cb931-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(<span class="fu">exp</span>(<span class="fu">coef</span>(m_boot)))</span>
<span id="cb931-6"><a href="regression.html#cb931-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb931-7"><a href="regression.html#cb931-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb931-8"><a href="regression.html#cb931-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the resampling:</span></span>
<span id="cb931-9"><a href="regression.html#cb931-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb931-10"><a href="regression.html#cb931-10" aria-hidden="true" tabindex="-1"></a>boot_res <span class="ot">&lt;-</span> <span class="fu">censboot</span>(lung[,<span class="fu">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;status&quot;</span>, <span class="st">&quot;age&quot;</span>, <span class="st">&quot;sex&quot;</span>)],</span>
<span id="cb931-11"><a href="regression.html#cb931-11" aria-hidden="true" tabindex="-1"></a>                     boot_fun, <span class="at">R =</span> <span class="dv">999</span>, </span>
<span id="cb931-12"><a href="regression.html#cb931-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">formula =</span> </span>
<span id="cb931-13"><a href="regression.html#cb931-13" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">formula</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex),</span>
<span id="cb931-14"><a href="regression.html#cb931-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">distr =</span> <span class="st">&quot;loglogistic&quot;</span>)</span>
<span id="cb931-15"><a href="regression.html#cb931-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb931-16"><a href="regression.html#cb931-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the percentile bootstrap confidence intervals:</span></span>
<span id="cb931-17"><a href="regression.html#cb931-17" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">2</span>) <span class="co"># Age</span></span>
<span id="cb931-18"><a href="regression.html#cb931-18" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_res, <span class="at">type =</span> <span class="st">&quot;perc&quot;</span>, <span class="at">index =</span> <span class="dv">3</span>) <span class="co"># Sex</span></span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excLMM5" class="exercise"><strong>Exercise 8.29  </strong></span>Consider the <code>ovarian</code> data from the <code>survival</code> package. Fit a log-logistic accelerated failure time model to the data, using all available explanatory variables. What is the estimated difference in survival times between the two treatment groups?</p>
</div>
<p><a href="solutions.html#ch7solutionsLMM5">(Click here to go to the solution.)</a></p>
</div>
<div id="bayesian-survival-analysis" class="section level3 hasAnchor" number="8.5.4">
<h3><span class="header-section-number">8.5.4</span> Bayesian survival analysis<a href="regression.html#bayesian-survival-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>At the time of this writing, the latest release of <code>rstanarm</code> does not contain functions for fitting survival analysis models. You can check whether this still is the case by running <code>?stan_surv</code> in the Console. If you don’t find the documentation for the <code>stan_surv</code> function, you will have to install the development version of the package from GitHub (which contains such functions), using the following code:</p>
<div class="sourceCode" id="cb932"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb932-1"><a href="regression.html#cb932-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the devtools package is installed, and start</span></span>
<span id="cb932-2"><a href="regression.html#cb932-2" aria-hidden="true" tabindex="-1"></a><span class="co"># by installing it otherwise:</span></span>
<span id="cb932-3"><a href="regression.html#cb932-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(devtools)) {</span>
<span id="cb932-4"><a href="regression.html#cb932-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)</span>
<span id="cb932-5"><a href="regression.html#cb932-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb932-6"><a href="regression.html#cb932-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb932-7"><a href="regression.html#cb932-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and install the development version of the package:</span></span>
<span id="cb932-8"><a href="regression.html#cb932-8" aria-hidden="true" tabindex="-1"></a><span class="fu">install_github</span>(<span class="st">&quot;stan-dev/rstanarm&quot;</span>, <span class="at">build_vignettes =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Now, let’s have a look at how to fit a Bayesian model to the <code>lung</code> data from <code>survival</code>:</p>
<div class="sourceCode" id="cb933"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb933-1"><a href="regression.html#cb933-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb933-2"><a href="regression.html#cb933-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb933-3"><a href="regression.html#cb933-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb933-4"><a href="regression.html#cb933-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit proportional hazards model using cubic M-splines (similar</span></span>
<span id="cb933-5"><a href="regression.html#cb933-5" aria-hidden="true" tabindex="-1"></a><span class="co"># but not identical to the Cox model!):</span></span>
<span id="cb933-6"><a href="regression.html#cb933-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">stan_surv</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb933-7"><a href="regression.html#cb933-7" aria-hidden="true" tabindex="-1"></a>m</span></code></pre></div>
<p>Fitting a survival model with a random effect works similarly, and uses the same syntax as <code>lme4</code>. Here is an example with the <code>retinopathy</code> data:</p>
<div class="sourceCode" id="cb934"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb934-1"><a href="regression.html#cb934-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">stan_surv</span>(<span class="fu">Surv</span>(futime, status) <span class="sc">~</span> age <span class="sc">+</span> type <span class="sc">+</span> trt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>id),</span>
<span id="cb934-2"><a href="regression.html#cb934-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> retinopathy)</span>
<span id="cb934-3"><a href="regression.html#cb934-3" aria-hidden="true" tabindex="-1"></a>m</span></code></pre></div>
</div>
<div id="multivariate-survival-analysis" class="section level3 hasAnchor" number="8.5.5">
<h3><span class="header-section-number">8.5.5</span> Multivariate survival analysis<a href="regression.html#multivariate-survival-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Some trials involve multiple time-to-event outcomes that need to be assessed simultaneously in a multivariate analysis. Examples includes studies of the time until each of several correlated symptoms or comorbidities occur. This is analogous to the multivariate testing problem of Section <a href="modchapter.html#hotellingst2">7.2.6</a>, but with right-censored data. To test for group differences for a vector of right-censored outcomes, a multivariate version of the logrank test described in Persson et al. (2019) can be used. It is available through the <code>MultSurvTests</code> package:</p>
<div class="sourceCode" id="cb935"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb935-1"><a href="regression.html#cb935-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;MultSurvTests&quot;</span>)</span></code></pre></div>
<p>As an example, we’ll use the <code>diabetes</code> dataset from <code>MultSurvTest</code>. It contains two time-to-event outcomes: time until blindness in a treated eye and in an untreated eye.</p>
<div class="sourceCode" id="cb936"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb936-1"><a href="regression.html#cb936-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MultSurvTests)</span>
<span id="cb936-2"><a href="regression.html#cb936-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Diabetes data:</span></span>
<span id="cb936-3"><a href="regression.html#cb936-3" aria-hidden="true" tabindex="-1"></a>?diabetes</span></code></pre></div>
<p>We’ll compare two groups that received two different treatments. The survival times (time until blindness) and censoring statuses of the two groups are put in a matrices called <code>z</code> and <code>z.delta</code>, which are used as input for the test function <code>perm_mvlogrank</code>:</p>
<div class="sourceCode" id="cb937"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb937-1"><a href="regression.html#cb937-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Survival times for the two groups:</span></span>
<span id="cb937-2"><a href="regression.html#cb937-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">subset</span>(diabetes, LASER<span class="sc">==</span><span class="dv">1</span>)[,<span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">8</span>)])</span>
<span id="cb937-3"><a href="regression.html#cb937-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">subset</span>(diabetes, LASER<span class="sc">==</span><span class="dv">2</span>)[,<span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">8</span>)])</span>
<span id="cb937-4"><a href="regression.html#cb937-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb937-5"><a href="regression.html#cb937-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Censoring status for the two groups:</span></span>
<span id="cb937-6"><a href="regression.html#cb937-6" aria-hidden="true" tabindex="-1"></a>delta.x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">subset</span>(diabetes, LASER<span class="sc">==</span><span class="dv">1</span>)[,<span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">9</span>)])</span>
<span id="cb937-7"><a href="regression.html#cb937-7" aria-hidden="true" tabindex="-1"></a>delta.y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">subset</span>(diabetes, LASER<span class="sc">==</span><span class="dv">2</span>)[,<span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">9</span>)])</span>
<span id="cb937-8"><a href="regression.html#cb937-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb937-9"><a href="regression.html#cb937-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the input for the test:</span></span>
<span id="cb937-10"><a href="regression.html#cb937-10" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rbind</span>(x, y)</span>
<span id="cb937-11"><a href="regression.html#cb937-11" aria-hidden="true" tabindex="-1"></a>delta.z <span class="ot">&lt;-</span> <span class="fu">rbind</span>(delta.x, delta.y)</span>
<span id="cb937-12"><a href="regression.html#cb937-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb937-13"><a href="regression.html#cb937-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the test with 499 permutations:</span></span>
<span id="cb937-14"><a href="regression.html#cb937-14" aria-hidden="true" tabindex="-1"></a><span class="fu">perm_mvlogrank</span>(<span class="at">B =</span> <span class="dv">499</span>, z, delta.z, <span class="at">n1 =</span> <span class="fu">nrow</span>(x))</span></code></pre></div>
</div>
<div id="power-estimates-for-the-logrank-test" class="section level3 hasAnchor" number="8.5.6">
<h3><span class="header-section-number">8.5.6</span> Power estimates for the logrank test<a href="regression.html#power-estimates-for-the-logrank-test" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>spower</code> function in <code>Hmisc</code> can be used to compute the power of the univariate logrank test in different scenarios using simulation. The helper functions <code>Weibull2</code>, <code>Lognorm2</code>, and <code>Gompertz2</code> can be used to define Weibull, lognormal and Gomperts distributions to sample from, using survival probabilities at different time points rather than the traditional parameters of those distributions. We’ll look at an example involving the Weibull distribution here. Additional examples can be found in the function’s documentation (<code>?spower</code>).</p>
<p>Let’s simulate the power of a 3-year follow-up study with two arms (i.e. two groups, control and intervention). First, we define a Weibull distribution for (compliant) control patients. Let’s say that their 1-year survival is 0.9 and their 3-year survival is 0.6. To define a Weibull distribution that corresponds to these numbers, we use <code>Weibull2</code> as follows:</p>
<div class="sourceCode" id="cb938"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb938-1"><a href="regression.html#cb938-1" aria-hidden="true" tabindex="-1"></a>weib_dist <span class="ot">&lt;-</span> <span class="fu">Weibull2</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="fu">c</span>(.<span class="dv">9</span>, .<span class="dv">6</span>))</span></code></pre></div>
<p>We’ll assume that the treatment has no effect for the first 6 months, and that it then has a constant effect, leading to a hazard ratio of 0.75 (so the hazard ratio is 1 if the time in years is less than or equal to 0.5, and 0.75 otherwise). Moreover, we’ll assume that there is a constant drop-out rate, such that 20 % of the patients can be expected to drop out during the three years. Finally, there is no drop-in. We define a function to simulate survival times under these conditions:</p>
<div class="sourceCode" id="cb939"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb939-1"><a href="regression.html#cb939-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In the functions used to define the hazard ratio, drop-out</span></span>
<span id="cb939-2"><a href="regression.html#cb939-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and drop-in, t denotes time in years:</span></span>
<span id="cb939-3"><a href="regression.html#cb939-3" aria-hidden="true" tabindex="-1"></a>sim_func <span class="ot">&lt;-</span> <span class="fu">Quantile2</span>(weib_dist, </span>
<span id="cb939-4"><a href="regression.html#cb939-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">hratio =</span> <span class="cf">function</span>(t) { <span class="fu">ifelse</span>(t <span class="sc">&lt;=</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">0.75</span>) },</span>
<span id="cb939-5"><a href="regression.html#cb939-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">dropout =</span> <span class="cf">function</span>(t) { <span class="fl">0.2</span><span class="sc">*</span>t<span class="sc">/</span><span class="dv">3</span> },</span>
<span id="cb939-6"><a href="regression.html#cb939-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">dropin =</span> <span class="cf">function</span>(t) { <span class="dv">0</span> })</span></code></pre></div>
<p>Next, we define a function for the censoring distribution, which is assumed to be the same for both groups. Let’s say that each follow-up is done at a random time point between 2 and 3 years. We’ll therefore use a uniform distribution on the interval <span class="math inline">\((2,3)\)</span> for the censoring distribution:</p>
<div class="sourceCode" id="cb940"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb940-1"><a href="regression.html#cb940-1" aria-hidden="true" tabindex="-1"></a>rcens <span class="ot">&lt;-</span> <span class="cf">function</span>(n)</span>
<span id="cb940-2"><a href="regression.html#cb940-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb940-3"><a href="regression.html#cb940-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">runif</span>(n, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb940-4"><a href="regression.html#cb940-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Finally, we define two helper functions required by <code>spower</code> and then run the simulation study. The output is the simulated power using the settings that we’ve just created.</p>
<div class="sourceCode" id="cb941"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb941-1"><a href="regression.html#cb941-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define helper functions:</span></span>
<span id="cb941-2"><a href="regression.html#cb941-2" aria-hidden="true" tabindex="-1"></a>rcontrol <span class="ot">&lt;-</span> <span class="cf">function</span>(n) { <span class="fu">sim_func</span>(n, <span class="st">&quot;control&quot;</span>) }</span>
<span id="cb941-3"><a href="regression.html#cb941-3" aria-hidden="true" tabindex="-1"></a>rinterv  <span class="ot">&lt;-</span> <span class="cf">function</span>(n) { <span class="fu">sim_func</span>(n, <span class="st">&quot;intervention&quot;</span>) }</span>
<span id="cb941-4"><a href="regression.html#cb941-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb941-5"><a href="regression.html#cb941-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate power when both groups have sample size 300:</span></span>
<span id="cb941-6"><a href="regression.html#cb941-6" aria-hidden="true" tabindex="-1"></a><span class="fu">spower</span>(rcontrol, rinterv, rcens, <span class="at">nc =</span> <span class="dv">300</span>, <span class="at">ni =</span> <span class="dv">300</span>, </span>
<span id="cb941-7"><a href="regression.html#cb941-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">test =</span> logrank, <span class="at">nsim =</span> <span class="dv">999</span>)</span>
<span id="cb941-8"><a href="regression.html#cb941-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb941-9"><a href="regression.html#cb941-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate power when both groups have sample size 450:</span></span>
<span id="cb941-10"><a href="regression.html#cb941-10" aria-hidden="true" tabindex="-1"></a><span class="fu">spower</span>(rcontrol, rinterv, rcens, <span class="at">nc =</span> <span class="dv">450</span>, <span class="at">ni =</span> <span class="dv">450</span>, </span>
<span id="cb941-11"><a href="regression.html#cb941-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">test =</span> logrank, <span class="at">nsim =</span> <span class="dv">999</span>)</span>
<span id="cb941-12"><a href="regression.html#cb941-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb941-13"><a href="regression.html#cb941-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate power when the control group has size 100</span></span>
<span id="cb941-14"><a href="regression.html#cb941-14" aria-hidden="true" tabindex="-1"></a><span class="co"># and the intervention group has size 300:</span></span>
<span id="cb941-15"><a href="regression.html#cb941-15" aria-hidden="true" tabindex="-1"></a><span class="fu">spower</span>(rcontrol, rinterv, rcens, <span class="at">nc =</span> <span class="dv">100</span>, <span class="at">ni =</span> <span class="dv">300</span>, </span>
<span id="cb941-16"><a href="regression.html#cb941-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">test =</span> logrank, <span class="at">nsim =</span> <span class="dv">999</span>)</span></code></pre></div>
</div>
</div>
<div id="left-censored-data-and-nondetects" class="section level2 hasAnchor" number="8.6">
<h2><span class="header-section-number">8.6</span> Left-censored data and nondetects<a href="regression.html#left-censored-data-and-nondetects" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Survival data is typically right-censored. Left-censored data, on the other hand, is common in medical research (e.g. in biomarker studies) and environmental chemistry (e.g. measurements of chemicals in water), where some measurements fall below the laboratory’s <em>detection limits</em> (or limit of detection, LoD). Such data also occur in studies in economics. A measurement below the detection limit, a <em>nondetect</em>, is still more informative than having no measurement at all - we may not know the exact value, but we know that the measurement is below a given threshold.</p>
<p>In principle, all methods that are applicable to survival analysis can also be used for left-censored data (although the interpretation of coefficients and parameters may differ), but in practice the distributions of lab measurements and economic variables often differ from those that typically describe survival times. In this section we’ll look at methods tailored to the kind of left-censored data that appears in applications in the aforementioned fields.</p>
<div id="estimation" class="section level3 hasAnchor" number="8.6.1">
<h3><span class="header-section-number">8.6.1</span> Estimation<a href="regression.html#estimation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>EnvStats</code> package contains a number of functions that can be used to compute descriptive statistics and estimating parameters of distributions from data with nondetects. Let’s install it:</p>
<div class="sourceCode" id="cb942"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb942-1"><a href="regression.html#cb942-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;EnvStats&quot;</span>)</span></code></pre></div>
<p>Estimates of the mean and standard deviation of a normal distribution that take the censoring into account in the right way can be obtained with <code>enormCensored</code>, which allows us to use several different estimators (the details surrounding the available estimators can be found using <code>?enormCensored</code>). Analogous functions are available for other distributions, for instance <code>elnormAltCensored</code> for the lognormal distribution, <code>egammaCensored</code> for the gamma distribution, and <code>epoisCensored</code> for the Poisson distribution.</p>
<p>To illustrate the use of <code>enormCensored</code>, we will generate data from a normal distribution. We know the true mean and standard deviation of the distribution, and can compute the estimates for the generated sample. We will then pretend that there is a detection limit for this data, and artificially left-censor about 20 % of it. This allows us to compare the estimates for the full sample and the censored sample, to see how the censoring affects the estimates. Try running the code below a few times:</p>
<div class="sourceCode" id="cb943"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb943-1"><a href="regression.html#cb943-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate 50 observations from a N(10, 9)-distribution:</span></span>
<span id="cb943-2"><a href="regression.html#cb943-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="dv">10</span>, <span class="dv">3</span>)</span>
<span id="cb943-3"><a href="regression.html#cb943-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-4"><a href="regression.html#cb943-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the mean and standard deviation:</span></span>
<span id="cb943-5"><a href="regression.html#cb943-5" aria-hidden="true" tabindex="-1"></a>mean_full <span class="ot">&lt;-</span> <span class="fu">mean</span>(x)</span>
<span id="cb943-6"><a href="regression.html#cb943-6" aria-hidden="true" tabindex="-1"></a>sd_full <span class="ot">&lt;-</span> <span class="fu">sd</span>(x)</span>
<span id="cb943-7"><a href="regression.html#cb943-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-8"><a href="regression.html#cb943-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Censor all observations below the &quot;detection limit&quot; 8</span></span>
<span id="cb943-9"><a href="regression.html#cb943-9" aria-hidden="true" tabindex="-1"></a><span class="co"># and replace their values by 8:</span></span>
<span id="cb943-10"><a href="regression.html#cb943-10" aria-hidden="true" tabindex="-1"></a>censored <span class="ot">&lt;-</span> x<span class="sc">&lt;</span><span class="dv">8</span></span>
<span id="cb943-11"><a href="regression.html#cb943-11" aria-hidden="true" tabindex="-1"></a>x[censored] <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb943-12"><a href="regression.html#cb943-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-13"><a href="regression.html#cb943-13" aria-hidden="true" tabindex="-1"></a><span class="co"># The proportion of censored observations is:</span></span>
<span id="cb943-14"><a href="regression.html#cb943-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(censored)</span>
<span id="cb943-15"><a href="regression.html#cb943-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-16"><a href="regression.html#cb943-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the mean and standard deviation in a naive</span></span>
<span id="cb943-17"><a href="regression.html#cb943-17" aria-hidden="true" tabindex="-1"></a><span class="co"># manner, using the ordinary estimators with all</span></span>
<span id="cb943-18"><a href="regression.html#cb943-18" aria-hidden="true" tabindex="-1"></a><span class="co"># nondetects replaced by 8:</span></span>
<span id="cb943-19"><a href="regression.html#cb943-19" aria-hidden="true" tabindex="-1"></a>mean_cens_naive <span class="ot">&lt;-</span> <span class="fu">mean</span>(x)</span>
<span id="cb943-20"><a href="regression.html#cb943-20" aria-hidden="true" tabindex="-1"></a>sd_cens_naive <span class="ot">&lt;-</span> <span class="fu">sd</span>(x)</span>
<span id="cb943-21"><a href="regression.html#cb943-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-22"><a href="regression.html#cb943-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate the mean and standard deviation using</span></span>
<span id="cb943-23"><a href="regression.html#cb943-23" aria-hidden="true" tabindex="-1"></a><span class="co"># different estimators that take the censoring</span></span>
<span id="cb943-24"><a href="regression.html#cb943-24" aria-hidden="true" tabindex="-1"></a><span class="co"># into account:</span></span>
<span id="cb943-25"><a href="regression.html#cb943-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-26"><a href="regression.html#cb943-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EnvStats)</span>
<span id="cb943-27"><a href="regression.html#cb943-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Maximum likelihood estimate:</span></span>
<span id="cb943-28"><a href="regression.html#cb943-28" aria-hidden="true" tabindex="-1"></a>estimates_mle <span class="ot">&lt;-</span> <span class="fu">enormCensored</span>(x, censored,</span>
<span id="cb943-29"><a href="regression.html#cb943-29" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method =</span> <span class="st">&quot;mle&quot;</span>)</span>
<span id="cb943-30"><a href="regression.html#cb943-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Biased-corrected maximum likelihood estimate:</span></span>
<span id="cb943-31"><a href="regression.html#cb943-31" aria-hidden="true" tabindex="-1"></a>estimates_bcmle <span class="ot">&lt;-</span> <span class="fu">enormCensored</span>(x, censored,</span>
<span id="cb943-32"><a href="regression.html#cb943-32" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method =</span> <span class="st">&quot;bcmle&quot;</span>)</span>
<span id="cb943-33"><a href="regression.html#cb943-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Regression on order statistics, ROS, estimate:</span></span>
<span id="cb943-34"><a href="regression.html#cb943-34" aria-hidden="true" tabindex="-1"></a>estimates_ros <span class="ot">&lt;-</span> <span class="fu">enormCensored</span>(x, censored,</span>
<span id="cb943-35"><a href="regression.html#cb943-35" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method =</span> <span class="st">&quot;ROS&quot;</span>)</span>
<span id="cb943-36"><a href="regression.html#cb943-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-37"><a href="regression.html#cb943-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the different estimates:</span></span>
<span id="cb943-38"><a href="regression.html#cb943-38" aria-hidden="true" tabindex="-1"></a>mean_full; sd_full</span>
<span id="cb943-39"><a href="regression.html#cb943-39" aria-hidden="true" tabindex="-1"></a>mean_cens_naive; sd_cens_naive</span>
<span id="cb943-40"><a href="regression.html#cb943-40" aria-hidden="true" tabindex="-1"></a>estimates_mle<span class="sc">$</span>parameters</span>
<span id="cb943-41"><a href="regression.html#cb943-41" aria-hidden="true" tabindex="-1"></a>estimates_bcmle<span class="sc">$</span>parameters</span>
<span id="cb943-42"><a href="regression.html#cb943-42" aria-hidden="true" tabindex="-1"></a>estimates_ros<span class="sc">$</span>parameters</span></code></pre></div>
<p>The naive estimators tend to be biased for data with nondetects (sometimes very biased!). Your mileage may vary depending on e.g. the sample size and the amount of censoring, but in general, the estimators that take censoring into account will fare much better.</p>
<p>After we have obtained estimates for the parameters of the normal distribution, we can plot the data against the fitted distribution to check the assumption of normality:</p>
<div class="sourceCode" id="cb944"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb944-1"><a href="regression.html#cb944-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb944-2"><a href="regression.html#cb944-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to histogram, including a bar for nondetects:</span></span>
<span id="cb944-3"><a href="regression.html#cb944-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(x), <span class="fu">aes</span>(x)) <span class="sc">+</span></span>
<span id="cb944-4"><a href="regression.html#cb944-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_histogram</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="fu">aes</span>(<span class="at">y =</span> ..density..)) <span class="sc">+</span></span>
<span id="cb944-5"><a href="regression.html#cb944-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_function</span>(<span class="at">fun =</span> dnorm, <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb944-6"><a href="regression.html#cb944-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> estimates_mle<span class="sc">$</span>parameters[<span class="dv">1</span>], </span>
<span id="cb944-7"><a href="regression.html#cb944-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">sd =</span> estimates_mle<span class="sc">$</span>parameters[<span class="dv">2</span>]))</span>
<span id="cb944-8"><a href="regression.html#cb944-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb944-9"><a href="regression.html#cb944-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to histogram, excluding nondetects:</span></span>
<span id="cb944-10"><a href="regression.html#cb944-10" aria-hidden="true" tabindex="-1"></a>x_noncens <span class="ot">&lt;-</span> x[<span class="sc">!</span>censored]</span>
<span id="cb944-11"><a href="regression.html#cb944-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(x_noncens), <span class="fu">aes</span>(x_noncens)) <span class="sc">+</span></span>
<span id="cb944-12"><a href="regression.html#cb944-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_histogram</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="fu">aes</span>(<span class="at">y =</span> ..density..)) <span class="sc">+</span></span>
<span id="cb944-13"><a href="regression.html#cb944-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_function</span>(<span class="at">fun =</span> dnorm, <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb944-14"><a href="regression.html#cb944-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> estimates_mle<span class="sc">$</span>parameters[<span class="dv">1</span>], </span>
<span id="cb944-15"><a href="regression.html#cb944-15" aria-hidden="true" tabindex="-1"></a>                                <span class="at">sd =</span> estimates_mle<span class="sc">$</span>parameters[<span class="dv">2</span>]))</span></code></pre></div>
<p>To obtain percentile and BCa bootstrap confidence intervals for the mean, we can add the options <code>ci = TRUE</code> and <code>ci.method = "bootstrap"</code>:</p>
<div class="sourceCode" id="cb945"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb945-1"><a href="regression.html#cb945-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using 999 bootstrap replicates:</span></span>
<span id="cb945-2"><a href="regression.html#cb945-2" aria-hidden="true" tabindex="-1"></a><span class="fu">enormCensored</span>(x, censored, <span class="at">method =</span> <span class="st">&quot;mle&quot;</span>,</span>
<span id="cb945-3"><a href="regression.html#cb945-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">ci =</span> <span class="cn">TRUE</span>,  <span class="at">ci.method =</span> <span class="st">&quot;bootstrap&quot;</span>,</span>
<span id="cb945-4"><a href="regression.html#cb945-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">n.bootstraps =</span> <span class="dv">999</span>)<span class="sc">$</span>interval<span class="sc">$</span>limits</span></code></pre></div>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excLoD1" class="exercise"><strong>Exercise 8.30  </strong></span><a href="http://www.modernstatisticswithr.com/data.zip">Download the <code>il2rb.csv</code> data from the book’s web page</a>. It contains measurements of the biomarker IL-2RB made in serum samples from two groups of patients. The values that are missing are in fact nondetects, with detection limit 0.25.</p>
<p>Under the assumption that the biomarker levels follow a lognormal distribution, compute bootstrap confidence intervals for the mean of the distribution for the control group. What proportion of the data is left-censored?</p>
</div>
<p><a href="solutions.html#ch7solutionsLoD1">(Click here to go to the solution.)</a></p>
</div>
<div id="tests-of-means" class="section level3 hasAnchor" number="8.6.2">
<h3><span class="header-section-number">8.6.2</span> Tests of means<a href="regression.html#tests-of-means" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When testing the difference between two groups’ means, nonparametric tests like the Wilcoxon-Mann-Whitney test often perform very well for data with nondetects, unlike the t-test (Zhang et al., 2009). For data with a high degree of censoring (e.g. more than 50 %), most tests perform poorly. For multivariate tests of mean vectors the situation is the opposite, with Hotelling’s <span class="math inline">\(T^2\)</span> (Section <a href="modchapter.html#hotellingst2">7.2.6</a>) being a much better option than nonparametric tests (Thulin, 2016).</p>
<p><span class="math display">\[\sim\]</span></p>
<div class="exercise">
<p><span id="exr:ch7excLoD2" class="exercise"><strong>Exercise 8.31  </strong></span>Return to the <code>il2rb.csv</code> data from Exercise <a href="regression.html#exr:ch7excLoD2">8.31</a>. Test the hypothesis that there is no difference in location between the two groups.</p>
</div>
<p><a href="solutions.html#ch7solutionsLoD2">(Click here to go to the solution.)</a></p>
</div>
<div id="censored-regression" class="section level3 hasAnchor" number="8.6.3">
<h3><span class="header-section-number">8.6.3</span> Censored regression<a href="regression.html#censored-regression" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Censored regression models can be used when the response variable is censored. A common model in economics is the Tobit regression model (Tobin, 1958), which is a linear regression model with normal errors, tailored to left-censored data. It can be fitted using <code>survreg</code>.</p>
<p>As an example, consider the <code>EPA.92c.zinc.df</code> dataset available in <code>EnvStats</code>. It contains measurements of zinc concentrations from five wells, made on 8 samples from each well, half of which are nondetects. Let’s say that we are interested in comparing these five wells (so that the wells aren’t random effects). Let’s also assume that the 8 samples were collected at different time points, and that we want to investigate whether the concentrations change over time. Such changes could be non-linear, so we’ll include the sample number as a factor. To fit a Tobit model to this data, we use <code>survreg</code> as follows.</p>
<div class="sourceCode" id="cb946"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb946-1"><a href="regression.html#cb946-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EnvStats)</span>
<span id="cb946-2"><a href="regression.html#cb946-2" aria-hidden="true" tabindex="-1"></a>?EPA<span class="fl">.92</span>c.zinc.df</span>
<span id="cb946-3"><a href="regression.html#cb946-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb946-4"><a href="regression.html#cb946-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that in Surv, in the vector describing censoring 0 means</span></span>
<span id="cb946-5"><a href="regression.html#cb946-5" aria-hidden="true" tabindex="-1"></a><span class="co"># censoring and 1 no censoring. This is the opposite of the </span></span>
<span id="cb946-6"><a href="regression.html#cb946-6" aria-hidden="true" tabindex="-1"></a><span class="co"># definition used in EPA.92c.zinc.df$Censored, so we use the !</span></span>
<span id="cb946-7"><a href="regression.html#cb946-7" aria-hidden="true" tabindex="-1"></a><span class="co"># operator to change 0&#39;s to 1&#39;s and vice versa.</span></span>
<span id="cb946-8"><a href="regression.html#cb946-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb946-9"><a href="regression.html#cb946-9" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(Zinc, <span class="sc">!</span>Censored, <span class="at">type =</span> <span class="st">&quot;left&quot;</span>) <span class="sc">~</span> Sample <span class="sc">+</span> Well,</span>
<span id="cb946-10"><a href="regression.html#cb946-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> EPA<span class="fl">.92</span>c.zinc.df, <span class="at">dist =</span> <span class="st">&quot;gaussian&quot;</span>)</span>
<span id="cb946-11"><a href="regression.html#cb946-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>Similarly, we can fit a model under the assumption of lognormality:</p>
<div class="sourceCode" id="cb947"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb947-1"><a href="regression.html#cb947-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(Zinc, <span class="sc">!</span>Censored, <span class="at">type =</span> <span class="st">&quot;left&quot;</span>) <span class="sc">~</span> Sample <span class="sc">+</span> Well,</span>
<span id="cb947-2"><a href="regression.html#cb947-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> EPA<span class="fl">.92</span>c.zinc.df, <span class="at">dist =</span> <span class="st">&quot;lognormal&quot;</span>)</span>
<span id="cb947-3"><a href="regression.html#cb947-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<p>Fitting regression models where the explanatory variables are censored is more challenging. For prediction, a good option is models based on decision trees, studied in Section <a href="mlchapter.html#mlmethods">9.5</a>. For testing whether there is a trend over time, tests based on Kendall’s correlation coefficient can be useful. <code>EnvStats</code> provides two functions for this - <code>kendallTrendTest</code> for testing a monotonic trend, and <code>kendallSeasonalTrendTest</code> for testing a monotonic trend within seasons.</p>
</div>
</div>
<div id="creating-matched-samples" class="section level2 hasAnchor" number="8.7">
<h2><span class="header-section-number">8.7</span> Creating matched samples<a href="regression.html#creating-matched-samples" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><em>Matching</em> is used to balance the distribution of explanatory variables in the groups that are being compared. This is often required in observational studies, where the treatment variable is not randomly assigned, but determined by some external factor(s) that may be related to the treatment. For instance, if you wish to study the effect of smoking on mortality, you can recruit a group of smokers and non-smokers and follow them for a few years. But both mortality and smoking are related to <em>confounding</em> variables such as age and gender, meaning that imbalances in the age and gender distributions of smokers and non-smokers can bias the results. There are several methods for creating balanced or <em>matched samples</em> that seek to mitigate this bias, including <em>propensity score matching</em>, which we’ll use here. The <code>MatchIt</code> and <code>optmatch</code> packages contain the functions that we need for this.</p>
<p>To begin with, let’s install the two packages:</p>
<div class="sourceCode" id="cb948"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb948-1"><a href="regression.html#cb948-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;MatchIt&quot;</span>, <span class="st">&quot;optmatch&quot;</span>))</span></code></pre></div>
<p>We will illustrate the use of the packages using the <code>lalonde</code> dataset, that is shipped with the <code>MatchIt</code> package:</p>
<div class="sourceCode" id="cb949"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb949-1"><a href="regression.html#cb949-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb949-2"><a href="regression.html#cb949-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(lalonde)</span>
<span id="cb949-3"><a href="regression.html#cb949-3" aria-hidden="true" tabindex="-1"></a>?lalonde</span>
<span id="cb949-4"><a href="regression.html#cb949-4" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(lalonde)</span></code></pre></div>
<p>Note that the data has row names, which are useful e.g. for identifying which individuals have been paired - we can access them using <code>rownames(lalonde)</code>.</p>
<div id="propensity-score-matching" class="section level3 hasAnchor" number="8.7.1">
<h3><span class="header-section-number">8.7.1</span> Propensity score matching<a href="regression.html#propensity-score-matching" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To perform automated propensity score matching, we will use the <code>matchit</code> function, which computes propensity scores and then matches participants from the treatment and control groups using these. Matches can be found in several ways. We’ll consider two of them here. As input, the <code>matchit</code> function takes a formula describing the treatment variable and potential confounders, what datasets to use, which method to use and what ratio of control to treatment participants to use.</p>
<p>A common method is <em>nearest neighbour matching</em>, where each participant is matched to the participant in the other group with the most similar propensity score. By default, it starts by finding a match for the participant in the treatment group that has the largest propensity score, then finds a match for the participant in the treatment groups with the second largest score, and so on. Two participants cannot be matched with the same participant in the control group. The nearest neighbour match is <em>locally optimal</em> in the sense that it find the best (still) available match for each participant in the treatment group, ignoring if that match in fact would be even better for another participant in the treatment group.</p>
<p>To perform propensity score matching using nearest neighbour matching with 1 match each, evaluate the results and then extract the matched samples we can use <code>matchit</code> as follows:</p>
<div class="sourceCode" id="cb950"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb950-1"><a href="regression.html#cb950-1" aria-hidden="true" tabindex="-1"></a>matches <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> re74 <span class="sc">+</span> re75 <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> married,</span>
<span id="cb950-2"><a href="regression.html#cb950-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">&quot;nearest&quot;</span>, <span class="at">ratio =</span> <span class="dv">1</span>)</span>
<span id="cb950-3"><a href="regression.html#cb950-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-4"><a href="regression.html#cb950-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matches)</span>
<span id="cb950-5"><a href="regression.html#cb950-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(matches)</span>
<span id="cb950-6"><a href="regression.html#cb950-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(matches, <span class="at">type =</span> <span class="st">&quot;hist&quot;</span>)</span>
<span id="cb950-7"><a href="regression.html#cb950-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-8"><a href="regression.html#cb950-8" aria-hidden="true" tabindex="-1"></a>matched_data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matches)</span>
<span id="cb950-9"><a href="regression.html#cb950-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matched_data)</span></code></pre></div>
<p>To view the matched pairs, you can use:</p>
<div class="sourceCode" id="cb951"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb951-1"><a href="regression.html#cb951-1" aria-hidden="true" tabindex="-1"></a>matches<span class="sc">$</span>match.matrix</span></code></pre></div>
<p>To view the values of the <code>re78</code> variable of the matched pairs, use:</p>
<div class="sourceCode" id="cb952"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb952-1"><a href="regression.html#cb952-1" aria-hidden="true" tabindex="-1"></a>varName <span class="ot">&lt;-</span> <span class="st">&quot;re78&quot;</span></span>
<span id="cb952-2"><a href="regression.html#cb952-2" aria-hidden="true" tabindex="-1"></a>resMatrix <span class="ot">&lt;-</span> lalonde[<span class="fu">row.names</span>(matches<span class="sc">$</span>match.matrix), varName]</span>
<span id="cb952-3"><a href="regression.html#cb952-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(matches<span class="sc">$</span>match.matrix))</span>
<span id="cb952-4"><a href="regression.html#cb952-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb952-5"><a href="regression.html#cb952-5" aria-hidden="true" tabindex="-1"></a>    resMatrix <span class="ot">&lt;-</span> <span class="fu">cbind</span>(resMatrix, lalonde[matches<span class="sc">$</span>match.matrix[,i],</span>
<span id="cb952-6"><a href="regression.html#cb952-6" aria-hidden="true" tabindex="-1"></a>                                          varName])</span>
<span id="cb952-7"><a href="regression.html#cb952-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb952-8"><a href="regression.html#cb952-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(resMatrix) <span class="ot">&lt;-</span> <span class="fu">row.names</span>(matches<span class="sc">$</span>match.matrix)</span>
<span id="cb952-9"><a href="regression.html#cb952-9" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(resMatrix)</span></code></pre></div>
<p>As an alternative to nearest neighbour-matching, <em>optimal matching</em> can be used. This is similar to nearest neighbour-matching, but strives to obtain <em>globally optimal</em> matches rather than locally optimal. This means that each participant in the treatment group is paired with a participant in the control group, while also taking into account how similar the latter participant is to other participants in the treatment group.</p>
<p>To perform propensity score matching using optimal matching with 2 matches each:</p>
<div class="sourceCode" id="cb953"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb953-1"><a href="regression.html#cb953-1" aria-hidden="true" tabindex="-1"></a>matches <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> re74 <span class="sc">+</span> re75 <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> married,</span>
<span id="cb953-2"><a href="regression.html#cb953-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">&quot;optimal&quot;</span>, <span class="at">ratio =</span> <span class="dv">2</span>)</span>
<span id="cb953-3"><a href="regression.html#cb953-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb953-4"><a href="regression.html#cb953-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matches)</span>
<span id="cb953-5"><a href="regression.html#cb953-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(matches)</span>
<span id="cb953-6"><a href="regression.html#cb953-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(matches, <span class="at">type =</span> <span class="st">&quot;hist&quot;</span>)</span>
<span id="cb953-7"><a href="regression.html#cb953-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb953-8"><a href="regression.html#cb953-8" aria-hidden="true" tabindex="-1"></a>matched_data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matches)</span>
<span id="cb953-9"><a href="regression.html#cb953-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matched_data)</span></code></pre></div>
<p>You may also want to find all controls that match participants in the treatment group exactly. This is called exact matching:</p>
<div class="sourceCode" id="cb954"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb954-1"><a href="regression.html#cb954-1" aria-hidden="true" tabindex="-1"></a>matches <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> re74 <span class="sc">+</span> re75 <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> married,</span>
<span id="cb954-2"><a href="regression.html#cb954-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">&quot;exact&quot;</span>)</span>
<span id="cb954-3"><a href="regression.html#cb954-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb954-4"><a href="regression.html#cb954-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matches)</span>
<span id="cb954-5"><a href="regression.html#cb954-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(matches)</span>
<span id="cb954-6"><a href="regression.html#cb954-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(matches, <span class="at">type =</span> <span class="st">&quot;hist&quot;</span>)</span>
<span id="cb954-7"><a href="regression.html#cb954-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb954-8"><a href="regression.html#cb954-8" aria-hidden="true" tabindex="-1"></a>matched_data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matches)</span>
<span id="cb954-9"><a href="regression.html#cb954-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matched_data)</span></code></pre></div>
<p>Participants with no exact matches won’t be included in <code>matched_data</code>.</p>
</div>
<div id="stepwise-matching" class="section level3 hasAnchor" number="8.7.2">
<h3><span class="header-section-number">8.7.2</span> Stepwise matching<a href="regression.html#stepwise-matching" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>At times you will want to combine the above approaches. For instance, you may want to have an exact match for age, and then an approximate match using the propensity scores for other variables. This is also achievable but requires the matching to be done in several steps. To first match the participant exactly on age and then 1-to-2 via nearest-neighbour propensity score matching on <code>re74</code> and <code>re75</code> we can use a loop:</p>
<div class="sourceCode" id="cb955"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb955-1"><a href="regression.html#cb955-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Match exactly one age:</span></span>
<span id="cb955-2"><a href="regression.html#cb955-2" aria-hidden="true" tabindex="-1"></a>matches <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age, <span class="at">data =</span> lalonde, <span class="at">method =</span> <span class="st">&quot;exact&quot;</span>)</span>
<span id="cb955-3"><a href="regression.html#cb955-3" aria-hidden="true" tabindex="-1"></a>matched_data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matches)</span>
<span id="cb955-4"><a href="regression.html#cb955-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb955-5"><a href="regression.html#cb955-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Match the first subclass 1-to-2 via nearest-neighbour propensity</span></span>
<span id="cb955-6"><a href="regression.html#cb955-6" aria-hidden="true" tabindex="-1"></a><span class="co"># score matching: </span></span>
<span id="cb955-7"><a href="regression.html#cb955-7" aria-hidden="true" tabindex="-1"></a>matches2 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb955-8"><a href="regression.html#cb955-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> matched_data[matched_data<span class="sc">$</span>subclass <span class="sc">==</span> <span class="dv">1</span>,],</span>
<span id="cb955-9"><a href="regression.html#cb955-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">method =</span> <span class="st">&quot;nearest&quot;</span>, <span class="at">ratio =</span> <span class="dv">2</span>)</span>
<span id="cb955-10"><a href="regression.html#cb955-10" aria-hidden="true" tabindex="-1"></a>matched_data2 <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matches2, <span class="at">weights =</span> <span class="st">&quot;weights2&quot;</span>,</span>
<span id="cb955-11"><a href="regression.html#cb955-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">subclass =</span> <span class="st">&quot;subclass2&quot;</span>)</span>
<span id="cb955-12"><a href="regression.html#cb955-12" aria-hidden="true" tabindex="-1"></a>matchlist <span class="ot">&lt;-</span> matches2<span class="sc">$</span>match.matrix</span>
<span id="cb955-13"><a href="regression.html#cb955-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb955-14"><a href="regression.html#cb955-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Match the remaining subclasses in the same way:</span></span>
<span id="cb955-15"><a href="regression.html#cb955-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">max</span>(matched_data<span class="sc">$</span>subclass))</span>
<span id="cb955-16"><a href="regression.html#cb955-16" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb955-17"><a href="regression.html#cb955-17" aria-hidden="true" tabindex="-1"></a>    matches2 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> re74 <span class="sc">+</span> re75,</span>
<span id="cb955-18"><a href="regression.html#cb955-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> matched_data[matched_data<span class="sc">$</span>subclass <span class="sc">==</span> i,],</span>
<span id="cb955-19"><a href="regression.html#cb955-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">&quot;nearest&quot;</span>, <span class="at">ratio =</span> <span class="dv">2</span>)</span>
<span id="cb955-20"><a href="regression.html#cb955-20" aria-hidden="true" tabindex="-1"></a>    matched_data2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(matched_data2, <span class="fu">match.data</span>(matches2,</span>
<span id="cb955-21"><a href="regression.html#cb955-21" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">weights =</span> <span class="st">&quot;weights2&quot;</span>,</span>
<span id="cb955-22"><a href="regression.html#cb955-22" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">subclass =</span> <span class="st">&quot;subclass2&quot;</span>))</span>
<span id="cb955-23"><a href="regression.html#cb955-23" aria-hidden="true" tabindex="-1"></a>    matchlist <span class="ot">&lt;-</span> <span class="fu">rbind</span>(matchlist, matches2<span class="sc">$</span>match.matrix)</span>
<span id="cb955-24"><a href="regression.html#cb955-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb955-25"><a href="regression.html#cb955-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb955-26"><a href="regression.html#cb955-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results:</span></span>
<span id="cb955-27"><a href="regression.html#cb955-27" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(matchlist)</span>
<span id="cb955-28"><a href="regression.html#cb955-28" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(matched_data2)</span></code></pre></div>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="55">
<li id="fn55"><p>If the variables aren’t centred, the intercept is the expected value of the response variable when all explanatory variables are 0. This isn’t always realistic or meaningful.<a href="regression.html#fnref55" class="footnote-back">↩︎</a></p></li>
<li id="fn56"><p>On the contrary, doing so will usually only serve to make interpretation more difficult.<a href="regression.html#fnref56" class="footnote-back">↩︎</a></p></li>
<li id="fn57"><p>Prediction intervals provide interval estimates for the new observations. They incorporate both the uncertainty associated with our model estimates, and the fact that the new observation is likely to deviate slightly from its expected value.<a href="regression.html#fnref57" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="modchapter.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="mlchapter.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
