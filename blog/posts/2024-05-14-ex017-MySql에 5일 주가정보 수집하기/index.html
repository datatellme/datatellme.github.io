<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://example.com/blog/posts/2024-05-14-ex017-MySql%EC%97%90%205%EC%9D%BC%20%EC%A3%BC%EA%B0%80%EC%A0%95%EB%B3%B4%20%EC%88%98%EC%A7%91%ED%95%98%EA%B8%B0/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.0, mkdocs-material-9.5.20"><title>5일 주가정보 수집하기02 - Data-Tell-Me</title><link rel=stylesheet href=../../../assets/stylesheets/main.66ac8b77.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Source Code Pro"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=purple> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#5-02gppjm07_040401 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=Data-Tell-Me class="md-header__button md-logo" aria-label=Data-Tell-Me data-md-component=logo> <img src=../../../img/peterpark_01.jpg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Data-Tell-Me </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 5일 주가정보 수집하기02 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=lime aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../about/ class=md-tabs__link> About </a> </li> <li class=md-tabs__item> <a href=../../../statistics/R-Introduction_K/ class=md-tabs__link> Statistics </a> </li> <li class=md-tabs__item> <a href=../../../data/01_mkdocs/ class=md-tabs__link> Data Skill </a> </li> <li class=md-tabs__item> <a href=../../../bibledata/01_Ge/ class=md-tabs__link> Text Mining </a> </li> <li class=md-tabs__item> <a href=../../../shot/01_movipy/ class=md-tabs__link> Shot </a> </li> <li class=md-tabs__item> <a href=../../../quant/01_quant/ class=md-tabs__link> Quant </a> </li> <li class=md-tabs__item> <a href=../../ class=md-tabs__link> Blog </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=Data-Tell-Me class="md-nav__button md-logo" aria-label=Data-Tell-Me data-md-component=logo> <img src=../../../img/peterpark_01.jpg alt=logo> </a> Data-Tell-Me </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../../about/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Statistics </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Statistics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../statistics/R-Introduction_K/ class=md-nav__link> <span class=md-ellipsis> R-Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../../statistics/R-basics_K/ class=md-nav__link> <span class=md-ellipsis> R-basics </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Data Skill </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Data Skill </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../data/01_mkdocs/ class=md-nav__link> <span class=md-ellipsis> mkdocs </span> </a> </li> <li class=md-nav__item> <a href=../../../data/02_Jupyter_nb_to_md/ class=md-nav__link> <span class=md-ellipsis> Jupyter_to_md </span> </a> </li> <li class=md-nav__item> <a href=../../../data/03_python_rmd/ class=md-nav__link> <span class=md-ellipsis> python_rmd </span> </a> </li> <li class=md-nav__item> <a href=../../../data/04_python_reticulate/ class=md-nav__link> <span class=md-ellipsis> python_reticulate </span> </a> </li> <li class=md-nav__item> <a href=../../../data/05_bat_file/ class=md-nav__link> <span class=md-ellipsis> bat file </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Text Mining </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Text Mining </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../bibledata/01_Ge/ class=md-nav__link> <span class=md-ellipsis> 창세기 </span> </a> </li> <li class=md-nav__item> <a href=../../../bibledata/02_Ex/ class=md-nav__link> <span class=md-ellipsis> 출애굽기 </span> </a> </li> <li class=md-nav__item> <a href=../../../bibledata/03_Lev/ class=md-nav__link> <span class=md-ellipsis> 레위기 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Shot </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Shot </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../shot/01_movipy/ class=md-nav__link> <span class=md-ellipsis> movipy </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Quant </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Quant </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../quant/01_quant/ class=md-nav__link> <span class=md-ellipsis> quant </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../ class=md-nav__link> <span class=md-ellipsis> Blog </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=5-02gppjm07_040401>5일 주가정보 수집하기02(gppjm07_040401)</h1> <h2 id=introduction>들어가며(Introduction)</h2> <ul> <li> <p>전 장에서 주가정보 수집하기 자동화 프로그램을 작성해보았습니다.</p> </li> <li> <p>Chat GPT에게 보완 수정한 최종 파이썬 코드를 오류가 있는지 확인 시켜보았습니다.</p> </li> <li> <p>Chat GPT 3.5 버전은 2021년 1월까지의 데이터로 돌아 갑니다.</p> </li> <li> <p>그래서 인지 FinanceDataReader 프로그램도 그때 기준으로 수정하였습니다.</p> </li> <li> <p>예를 들어 현재는 'Symbol' 대신 'Code'를 사용하는데 예전 버전인 'Symbol'로 수정했습니다.</p> </li> </ul> <p><strong>목표(Goal)</strong></p> <ul> <li> <p>5일전 부터 현재까지의 주가정보 수집하기 자동화 프로그램을 만드는 것이 목표입니다.</p> </li> <li> <p>기간설정을 통하여 연 단위와 더불어 일 단위로 업데이트 할 수 있는 방법을 알아 봅니다. </p> </li> </ul> <p><strong>목적(Why)</strong></p> <ul> <li>목적01</li> <li>부연설명</li> </ul> <h2 id=how>질문 작성 방법(How)</h2> <ul> <li>질문01: </li> <li>부연설명 </li> </ul> <p><strong>질문 내용(프롬프트)</strong></p> <ul> <li> <p>완성된 파이썬 코드를 확인하기 위해서 stock_data 데이터 삽입하기 단계에서 row['Code']라는 잘못된 코드를 작성했습니다.</p> </li> <li> <p>Chat GPT는 정확하게 symbol 위치를 변경하고 단어를 수정했습니다.</p> </li> <li> <p>Chat GPT는 2021년 기준이라 df_krx["Symbol"]는 예전 코드를 사용했습니다.</p> </li> </ul> <div class=highlight><pre><span></span><code>Q01: FinanceDataReader를 사용하여 한국거래소(KRX)의 주식 데이터를 수집하고, 데이터베이스에 저장하는 기능관련해서 계속 질문해도 되니?

Q02: 다음 파이썬 코드에 오류가 있는지 확인 부탁해. 

다음: 

import pymysql
import pandas as pd
from datetime import datetime
import FinanceDataReader as fdr
from tqdm import tqdm

# 데이터베이스 연결 설정
db_conf = {
    &#39;host&#39;: &#39;localhost&#39;,    # 호스트 이름
    &#39;user&#39;: &#39;root&#39;,         # 사용자 이름
    &#39;password&#39;: &#39;password&#39;, # 비밀번호
    &#39;database&#39;: &#39;test02_db&#39; # 데이터베이스 이름
}

# MySql에 테이블 stock_list와 stock_data 테이블 만들기 
def create_table(db_conf):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 테이블 생성 쿼리 실행
            create_table_query01 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_list (
                code VARCHAR(6),
                name VARCHAR(30),
                market VARCHAR(30),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (code)
            )
            &quot;&quot;&quot;
            create_table_query02 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_data (
                date date,
                open int,
                high int,
                low int,
                close int,
                volume int,
                code VARCHAR(6),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (date, code)
            )
            &quot;&quot;&quot;    

            cursor.execute(create_table_query01)
            cursor.execute(create_table_query02)
        connection.commit()
    finally:
        connection.close()

# stock_list 데이터 삽입하기
def insert_code(df_krx):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 목록을 데이터베이스에 삽입
            for index, row in df_krx.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_list (code, name, market)
                VALUES (%s, %s, %s)
                &quot;&quot;&quot;
                cursor.execute(insert_query, (row[&#39;Code&#39;], row[&#39;Name&#39;], row[&#39;Market&#39;]))
        connection.commit()
    finally:
        connection.close()

# stock_data 데이터 삽입하기
def insert_stock_data(db_conf, symbol, df_sto):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 데이터를 데이터베이스에 삽입
            for index, row in df_sto.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_data (date, open, high, low, close, volume, code)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                &quot;&quot;&quot;
                cursor.execute(insert_query, (index.strftime(&#39;%Y-%m-%d&#39;), row[&#39;Code&#39;], row[&#39;Open&#39;], row[&#39;High&#39;], row[&#39;Low&#39;], row[&#39;Close&#39;], row[&#39;Volume&#39;]))
        connection.commit()
    finally:
        connection.close()

# 주식데이터 수집하기
def stock_data_collect(year):
    create_table(db_conf)
    df_krx = fdr.StockListing(&#39;KRX&#39;)
    df_krx = df_krx.fillna(&quot;&quot;)
    insert_code(df_krx)

    # 기간 설정
    year=&quot;2023&quot;

    symbol_list = df_krx[&quot;Code&quot;]

    for symbol in tqdm(symbol_list):
        try:
            df_sto = fdr.DataReader(symbol, year)
            insert_stock_data(db_conf, symbol, df_sto)
        except Exception as e:
            print(symbol, end=&quot;, &quot;)
            print(e)

    return 0

if __name__ == &#39;__main__&#39;:
    year = str(datetime.now().year)
    stock_data_collect(year)


Q03: &#39;1년 전부터 현재까지의 데이터 수집&#39; 부분을 &#39;5일 전부터 현재까지의 데이터 수집&#39; 할 수 있게 전체코드 수정 부탁해. 
</code></pre></div> <h2 id=what>질문에 대한 답변 결과(What)</h2> <ul> <li>부연설명01</li> <li>부연설명02</li> </ul> <p><strong>Chat GPT 답변</strong></p> <div class=highlight><pre><span></span><code>A01: 물론이죠! 주식 데이터 수집 및 데이터베이스 저장에 관련된 모든 질문을 알려주세요. 가능한 한 도와드리겠습니다. 


A02: 코드를 살펴보니 몇 가지 수정이 필요해 보입니다. 먼저, stock_data_collect 함수 내에서 연도를 설정하는 부분을 수정해야 합니다. 또한 데이터 프레임의 컬럼명을 잘못 사용한 부분도 수정이 필요합니다. 아래는 수정된 코드입니다.

python
코드 복사
import pymysql
import pandas as pd
from datetime import datetime
import FinanceDataReader as fdr
from tqdm import tqdm

# 데이터베이스 연결 설정
db_conf = {
    &#39;host&#39;: &#39;localhost&#39;,    # 호스트 이름
    &#39;user&#39;: &#39;root&#39;,         # 사용자 이름
    &#39;password&#39;: &#39;password&#39;, # 비밀번호
    &#39;database&#39;: &#39;test02_db&#39; # 데이터베이스 이름
}

# MySql에 테이블 stock_list와 stock_data 테이블 만들기 
def create_table(db_conf):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 테이블 생성 쿼리 실행
            create_table_query01 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_list (
                code VARCHAR(6),
                name VARCHAR(30),
                market VARCHAR(30),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (code)
            )
            &quot;&quot;&quot;
            create_table_query02 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_data (
                date DATE,
                open_price INT,
                high_price INT,
                low_price INT,
                close_price INT,
                volume INT,
                code VARCHAR(6),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (date, code)
            )
            &quot;&quot;&quot;    

            cursor.execute(create_table_query01)
            cursor.execute(create_table_query02)
        connection.commit()
    finally:
        connection.close()

# stock_list 데이터 삽입하기
def insert_code(df_krx):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 목록을 데이터베이스에 삽입
            for index, row in df_krx.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_list (code, name, market)
                VALUES (%s, %s, %s)
                &quot;&quot;&quot;
                cursor.execute(insert_query, (row[&#39;Symbol&#39;], row[&#39;Name&#39;], row[&#39;Market&#39;]))
        connection.commit()
    finally:
        connection.close()

# stock_data 데이터 삽입하기
def insert_stock_data(db_conf, symbol, df_sto):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 데이터를 데이터베이스에 삽입
            for index, row in df_sto.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_data (date, open_price, high_price, low_price, close_price, volume, code)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                &quot;&quot;&quot;
                cursor.execute(insert_query, (index.strftime(&#39;%Y-%m-%d&#39;), row[&#39;Open&#39;], row[&#39;High&#39;], row[&#39;Low&#39;], row[&#39;Close&#39;], row[&#39;Volume&#39;], symbol))
        connection.commit()
    finally:
        connection.close()

# 주식데이터 수집하기
def stock_data_collect(year):
    create_table(db_conf)
    df_krx = fdr.StockListing(&#39;KRX&#39;)
    df_krx = df_krx.fillna(&quot;&quot;)
    insert_code(df_krx)

    # 기간 설정
    start_date = f&#39;{year}-01-01&#39;
    end_date = datetime.now().strftime(&#39;%Y-%m-%d&#39;)

    symbol_list = df_krx[&quot;Symbol&quot;]

    for symbol in tqdm(symbol_list):
        try:
            df_sto = fdr.DataReader(symbol, start_date, end_date)
            insert_stock_data(db_conf, symbol, df_sto)
        except Exception as e:
            print(symbol, end=&quot;, &quot;)
            print(e)

    return 0

if __name__ == &#39;__main__&#39;:
    year = str(datetime.now().year - 1)  # 1년 전부터 현재까지의 데이터 수집
    stock_data_collect(year)

이렇게 수정하면 주식 데이터를 데이터베이스에 성공적으로 저장할 수 있을 것입니다.


Q03: 아래는 주식 데이터를 5일 전부터 현재까지 수집하는 코드입니다.

python
코드 복사
import pymysql
import pandas as pd
from datetime import datetime, timedelta
import FinanceDataReader as fdr
from tqdm import tqdm

# 데이터베이스 연결 설정
db_conf = {
    &#39;host&#39;: &#39;localhost&#39;,    # 호스트 이름
    &#39;user&#39;: &#39;root&#39;,         # 사용자 이름
    &#39;password&#39;: &#39;password&#39;, # 비밀번호
    &#39;database&#39;: &#39;test02_db&#39; # 데이터베이스 이름
}

# MySql에 테이블 stock_list와 stock_data 테이블 만들기 
def create_table(db_conf):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 테이블 생성 쿼리 실행
            create_table_query01 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_list (
                code VARCHAR(6),
                name VARCHAR(30),
                market VARCHAR(30),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (code)
            )
            &quot;&quot;&quot;
            create_table_query02 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_data (
                date DATE,
                open_price INT,
                high_price INT,
                low_price INT,
                close_price INT,
                volume INT,
                code VARCHAR(6),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (date, code)
            )
            &quot;&quot;&quot;    

            cursor.execute(create_table_query01)
            cursor.execute(create_table_query02)
        connection.commit()
    finally:
        connection.close()

# stock_list 데이터 삽입하기
def insert_code(df_krx):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 목록을 데이터베이스에 삽입
            for index, row in df_krx.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_list (code, name, market)
                VALUES (%s, %s, %s)
                &quot;&quot;&quot;
                cursor.execute(insert_query, (row[&#39;Symbol&#39;], row[&#39;Name&#39;], row[&#39;Market&#39;]))
        connection.commit()
    finally:
        connection.close()

# stock_data 데이터 삽입하기
def insert_stock_data(db_conf, symbol, df_sto):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 데이터를 데이터베이스에 삽입
            for index, row in df_sto.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_data (date, open_price, high_price, low_price, close_price, volume, code)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                &quot;&quot;&quot;
                cursor.execute(insert_query, (index.strftime(&#39;%Y-%m-%d&#39;), row[&#39;Open&#39;], row[&#39;High&#39;], row[&#39;Low&#39;], row[&#39;Close&#39;], row[&#39;Volume&#39;], symbol))
        connection.commit()
    finally:
        connection.close()

# 주식데이터 수집하기
def stock_data_collect():
    create_table(db_conf)
    df_krx = fdr.StockListing(&#39;KRX&#39;)
    df_krx = df_krx.fillna(&quot;&quot;)

    # 5일 전부터 현재까지의 날짜 구하기
    start_date = (datetime.now() - timedelta(days=5)).strftime(&#39;%Y-%m-%d&#39;)
    end_date = datetime.now().strftime(&#39;%Y-%m-%d&#39;)

    insert_code(df_krx)

    symbol_list = df_krx[&quot;Symbol&quot;]

    for symbol in tqdm(symbol_list):
        try:
            df_sto = fdr.DataReader(symbol, start_date, end_date)
            insert_stock_data(db_conf, symbol, df_sto)
        except Exception as e:
            print(symbol, end=&quot;, &quot;)
            print(e)

    return 0

if __name__ == &#39;__main__&#39;:
    stock_data_collect()


이렇게 수정하면 5일 전부터 현재까지의 주식 데이터를 데이터베이스에 저장할 수 있습니다.
</code></pre></div> <h2 id=discussion>답변 결과 디버깅 및 수정(Discussion)</h2> <ul> <li>"Symbol"을 현재 버전인 "Code"로 변경했습니다.</li> <li>업데이트 과정 시 에라 메세지 발생으로 Chat GPT에 질문하여 쿼리문 'ON DUPLICATE KEY UPDATE'를 추가하여 아래와 같이 수정하였습니다.</li> </ul> <div class=highlight><pre><span></span><code># stock_list 데이터 삽입하기
def insert_code(df_krx):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 목록을 데이터베이스에 삽입
            for index, row in df_krx.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_list (code, name, market)
                VALUES (%s, %s, %s)
                ON DUPLICATE KEY UPDATE
                name=VALUES(name), market=VALUES(market), collected_time=CURRENT_TIMESTAMP
                &quot;&quot;&quot;
                cursor.execute(insert_query, (row[&#39;Code&#39;], row[&#39;Name&#39;], row[&#39;Market&#39;]))
        connection.commit()
    finally:
        connection.close()

# stock_data 데이터 삽입하기
def insert_stock_data(db_conf, symbol, df_sto):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 데이터를 데이터베이스에 삽입
            for index, row in df_sto.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_data (date, open_price, high_price, low_price, close_price, volume, code)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                ON DUPLICATE KEY UPDATE
                open_price=VALUES(open_price),
                high_price=VALUES(high_price),
                low_price=VALUES(low_price),
                close_price=VALUES(close_price),
                volume=VALUES(volume),
                collected_time=CURRENT_TIMESTAMP
                &quot;&quot;&quot;
                cursor.execute(insert_query, (index.strftime(&#39;%Y-%m-%d&#39;), row[&#39;Open&#39;], row[&#39;High&#39;], row[&#39;Low&#39;], row[&#39;Close&#39;], row[&#39;Volume&#39;], symbol))
        connection.commit()
    finally:
        connection.close()
</code></pre></div> <p><strong>완성된 최종 프로그램(연 단위)(gppjm07_040401)</strong></p> <div class=highlight><pre><span></span><code>import pymysql
import pandas as pd
from datetime import datetime
import FinanceDataReader as fdr
from tqdm import tqdm

# 데이터베이스 연결 설정
db_conf = {
    &#39;host&#39;: &#39;localhost&#39;,    # 호스트 이름
    &#39;user&#39;: &#39;root&#39;,         # 사용자 이름
    &#39;password&#39;: &#39;password&#39;, # 비밀번호
    &#39;database&#39;: &#39;test02_db&#39; # 데이터베이스 이름
}

# MySql에 테이블 stock_list와 stock_data 테이블 만들기 
def create_table(db_conf):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 테이블 생성 쿼리 실행
            create_table_query01 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_list (
                code VARCHAR(6),
                name VARCHAR(30),
                market VARCHAR(30),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (code)
            )
            &quot;&quot;&quot;
            create_table_query02 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_data (
                date DATE,
                open_price INT,
                high_price INT,
                low_price INT,
                close_price INT,
                volume INT,
                code VARCHAR(6),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (date, code)
            )
            &quot;&quot;&quot;    

            cursor.execute(create_table_query01)
            cursor.execute(create_table_query02)
        connection.commit()
    finally:
        connection.close()

# stock_list 데이터 삽입하기
def insert_code(df_krx):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 목록을 데이터베이스에 삽입
            for index, row in df_krx.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_list (code, name, market)
                VALUES (%s, %s, %s)
                ON DUPLICATE KEY UPDATE
                name=VALUES(name), market=VALUES(market), collected_time=CURRENT_TIMESTAMP
                &quot;&quot;&quot;
                cursor.execute(insert_query, (row[&#39;Code&#39;], row[&#39;Name&#39;], row[&#39;Market&#39;]))
        connection.commit()
    finally:
        connection.close()

# stock_data 데이터 삽입하기
def insert_stock_data(db_conf, symbol, df_sto):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 데이터를 데이터베이스에 삽입
            for index, row in df_sto.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_data (date, open_price, high_price, low_price, close_price, volume, code)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                ON DUPLICATE KEY UPDATE
                open_price=VALUES(open_price),
                high_price=VALUES(high_price),
                low_price=VALUES(low_price),
                close_price=VALUES(close_price),
                volume=VALUES(volume),
                collected_time=CURRENT_TIMESTAMP
                &quot;&quot;&quot;
                cursor.execute(insert_query, (index.strftime(&#39;%Y-%m-%d&#39;), row[&#39;Open&#39;], row[&#39;High&#39;], row[&#39;Low&#39;], row[&#39;Close&#39;], row[&#39;Volume&#39;], symbol))
        connection.commit()
    finally:
        connection.close()

# 주식데이터 수집하기
def stock_data_collect(year):
    create_table(db_conf)
    df_krx = fdr.StockListing(&#39;KRX&#39;)
    df_krx = df_krx.fillna(&quot;&quot;)
    insert_code(df_krx)

    # 기간 설정
    start_date = f&#39;{year}-01-01&#39;
    end_date = datetime.now().strftime(&#39;%Y-%m-%d&#39;)

    symbol_list = df_krx[&quot;Code&quot;]

    for symbol in tqdm(symbol_list):
        try:
            df_sto = fdr.DataReader(symbol, start_date, end_date)
            insert_stock_data(db_conf, symbol, df_sto)
        except Exception as e:
            print(symbol, end=&quot;, &quot;)
            print(e)

    return 0

if __name__ == &#39;__main__&#39;:
    year = str(datetime.now().year - 1)  # 1년 전부터 현재까지의 데이터 수집
    stock_data_collect(year)
</code></pre></div> <p><strong>완성된 최종 프로그램(5일 전)(gppjm07_040402)</strong></p> <ul> <li></li> </ul> <div class=highlight><pre><span></span><code>import pymysql
import pandas as pd
from datetime import datetime, timedelta
import FinanceDataReader as fdr
from tqdm import tqdm

# 데이터베이스 연결 설정
db_conf = {
    &#39;host&#39;: &#39;localhost&#39;,    # 호스트 이름
    &#39;user&#39;: &#39;root&#39;,         # 사용자 이름
    &#39;password&#39;: &#39;password&#39;, # 비밀번호
    &#39;database&#39;: &#39;test02_db&#39; # 데이터베이스 이름
}

# MySql에 테이블 stock_list와 stock_data 테이블 만들기 
def create_table(db_conf):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 테이블 생성 쿼리 실행
            create_table_query01 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_list (
                code VARCHAR(6),
                name VARCHAR(30),
                market VARCHAR(30),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (code)
            )
            &quot;&quot;&quot;
            create_table_query02 = &quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS stock_data (
                date DATE,
                open_price INT,
                high_price INT,
                low_price INT,
                close_price INT,
                volume INT,
                code VARCHAR(6),
                collected_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                PRIMARY KEY (date, code)
            )
            &quot;&quot;&quot;    

            cursor.execute(create_table_query01)
            cursor.execute(create_table_query02)
        connection.commit()
    finally:
        connection.close()

# stock_list 데이터 삽입하기
def insert_code(df_krx):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 목록을 데이터베이스에 삽입
            for index, row in df_krx.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_list (code, name, market)
                VALUES (%s, %s, %s)
                ON DUPLICATE KEY UPDATE
                name=VALUES(name), market=VALUES(market), collected_time=CURRENT_TIMESTAMP
                &quot;&quot;&quot;
                cursor.execute(insert_query, (row[&#39;Code&#39;], row[&#39;Name&#39;], row[&#39;Market&#39;]))
        connection.commit()
    finally:
        connection.close()

# stock_data 데이터 삽입하기
def insert_stock_data(db_conf, symbol, df_sto):
    # 데이터베이스 연결
    connection = pymysql.connect(**db_conf)
    try:
        with connection.cursor() as cursor:
            # 주식 데이터를 데이터베이스에 삽입
            for index, row in df_sto.iterrows():
                insert_query = &quot;&quot;&quot;
                INSERT INTO stock_data (date, open_price, high_price, low_price, close_price, volume, code)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                ON DUPLICATE KEY UPDATE
                open_price=VALUES(open_price),
                high_price=VALUES(high_price),
                low_price=VALUES(low_price),
                close_price=VALUES(close_price),
                volume=VALUES(volume),
                collected_time=CURRENT_TIMESTAMP
                &quot;&quot;&quot;
                cursor.execute(insert_query, (index.strftime(&#39;%Y-%m-%d&#39;), row[&#39;Open&#39;], row[&#39;High&#39;], row[&#39;Low&#39;], row[&#39;Close&#39;], row[&#39;Volume&#39;], symbol))
        connection.commit()
    finally:
        connection.close()

# 주식데이터 수집하기
def stock_data_collect():
    create_table(db_conf)
    df_krx = fdr.StockListing(&#39;KRX&#39;)
    df_krx = df_krx.fillna(&quot;&quot;)

    # 5일 전부터 현재까지의 날짜 구하기
    start_date = (datetime.now() - timedelta(days=5)).strftime(&#39;%Y-%m-%d&#39;)
    end_date = datetime.now().strftime(&#39;%Y-%m-%d&#39;)

    insert_code(df_krx)

    symbol_list = df_krx[&quot;Code&quot;]

    for symbol in tqdm(symbol_list):
        try:
            df_sto = fdr.DataReader(symbol, start_date, end_date)
            insert_stock_data(db_conf, symbol, df_sto)
        except Exception as e:
            print(symbol, end=&quot;, &quot;)
            print(e)

    return 0

if __name__ == &#39;__main__&#39;:
    stock_data_collect()
</code></pre></div> <h2 id=conclusion>결어(Conclusion)</h2> <ul> <li>정리하기01</li> <li>정리하기02</li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2023 <a href=https://github.com/datatellme target=_blank rel=noopener>Data Tell Me</a> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.dd8806f2.min.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>